# 测试指南 - v1.1.0

## 测试重点：UI 根本性修复

### 测试场景 1：监控面板基本功能

**目标**：确认监控面板无崩溃，所有配送器可选

**步骤**：
1. 启动游戏，加载存档
2. 打开监控面板（默认快捷键：`V`）
3. 选择"配送器"筛选
4. 观察：
   - ✅ 无 `NullReferenceException` 错误
   - ✅ 配送器列表正常显示
   - ✅ 可以点击任意配送器查看详情
5. 滚动到列表底部
6. 观察：
   - ✅ 滚动流畅，无卡顿
   - ✅ 无崩溃
   - ✅ 虚拟配送器（如果显示）可以正常查看

**预期结果**：
- 无任何错误日志
- UI 完全正常
- 所有配送器可选

---

### 测试场景 2：虚拟配送器与真实配送器混合

**目标**：确认虚拟配送器和真实配送器可以共存

**步骤**：
1. 建造多个战场分析基站（例如：3个）
2. 建造多个配送器（例如：5个）
3. 设置部分配送器需求战场基站的物品
4. 等待虚拟配送器创建（加载日志查看）
5. 打开监控面板，观察：
   - ✅ 所有真实配送器正常显示
   - ✅ 虚拟配送器（如果显示）没有错误
   - ✅ 可以在配送器之间切换

**预期日志**：
```
[Info] ✅ 为虚拟配送器[26]创建假实体[500]
[Info] ✅ 为虚拟配送器[27]创建假实体[501]
[Info] ✅ 为虚拟配送器[28]创建假实体[502]
```

---

### 测试场景 3：存档加载

**目标**：确认假实体在存档加载后正确恢复

**步骤**：
1. 在有虚拟配送器的存档中保存游戏
2. 退出游戏
3. 重新启动游戏
4. 加载存档
5. 检查日志：
   - ✅ 虚拟配送器映射被恢复
   - ✅ 假实体被重用或重新创建
6. 打开监控面板：
   - ✅ 无错误
   - ✅ 所有配送器正常

**预期日志**：
```
[Info] ♻️ 从存档恢复虚拟配送器映射：dispenser[26] → battleBase[1] (entityId=150)
[Info] 检测到假实体[500]已存在，直接使用
```

---

### 测试场景 4：配送功能

**目标**：确认配送功能不受 UI 修复影响

**步骤**：
1. 战场分析基站有物品（例如：100 个硅块）
2. 配送器设置为需求"硅块"
3. 观察无人机动作：
   - ✅ 无人机从配送器起飞
   - ✅ 飞向战场分析基站
   - ✅ 在基站上空拾取物品
   - ✅ 返回配送器
   - ✅ 配送到其他建筑或机甲
4. 检查日志：
   - ✅ 配对创建成功
   - ✅ 无人机派出成功
   - ✅ 物品拾取成功

**预期日志**：
```
[Info] ✓ 已添加配对：虚拟配送器[26] → 配送器[1]
[Info] 🚀 准备派出无人机! dispenser[1] virtualPair[0] idleCouriers=5
```

---

### 测试场景 5：压力测试

**目标**：测试大量虚拟配送器的情况

**步骤**：
1. 建造 10+ 个战场分析基站
2. 建造 20+ 个配送器
3. 设置所有配送器需求战场基站的物品
4. 等待系统稳定
5. 打开监控面板：
   - ✅ 列表显示正常
   - ✅ 滚动流畅
   - ✅ 无崩溃
6. 观察游戏性能：
   - ✅ 无明显卡顿
   - ✅ 配送正常进行

---

### 测试场景 6：边界情况

**目标**：测试异常情况

#### 6.1 拆除战场分析基站

**步骤**：
1. 配送进行中，拆除战场分析基站
2. 观察：
   - ✅ 空载无人机立即返回
   - ✅ 虚拟配送器被清理
   - ✅ 无错误日志

#### 6.2 切换配送器模式

**步骤**：
1. 配送器设置为"供应"模式
2. 观察：
   - ✅ 不会从战场基站取货
3. 切换为"需求"模式
4. 观察：
   - ✅ 重新开始配送

#### 6.3 战场基站物品清空

**步骤**：
1. 配送进行到战场基站清空
2. 观察：
   - ✅ 无人机停止派出
   - ✅ 配对被移除
3. 手动放入物品到战场基站
4. 观察：
   - ✅ 自动重新创建配对
   - ✅ 无人机重新派出

---

## 日志检查清单

### 启动阶段
- [ ] `正在加载...`
- [ ] `已对 PlanetFactory.Init 应用补丁（创建虚拟配送器）`
- [ ] `已对 PlanetFactory.Import 应用补丁（存档加载后创建虚拟配送器）`
- [ ] `已对 PlanetFactory.Free 应用补丁（清理虚拟配送器映射）`
- [ ] `已对 PlanetTransport.RefreshDispenserTraffic 应用补丁（添加配对）`
- [ ] `已对 DispenserComponent.InternalTick 应用补丁（Prefix：派出空载无人机）`
- [ ] `已对 DispenserComponent.OnRematchPairs 应用补丁（跳过虚拟配送器）`
- [ ] `已对 BattleBaseComponent.InternalUpdate 应用补丁（监控物品变化，包括手动放入）`
- [ ] `✅ 加载完成！使用虚拟配送器方案（含假实体修复）`

### 运行阶段
- [ ] 虚拟配送器创建：`✅ 为虚拟配送器[X]创建假实体[Y]`
- [ ] 配对创建：`✓ 已添加配对：虚拟配送器[X] → 配送器[Y]`
- [ ] 无人机派出：`🚀 准备派出无人机!`
- [ ] **无 `NullReferenceException`**
- [ ] **无 `IndexOutOfRangeException`**

### 错误排查
如果出现错误，检查：
1. 堆栈跟踪中是否提到 `UIControlPanelDispenserEntry.OnSetTarget`
2. 是否有 `entityPool[xxx].dispenserId` 访问失败
3. 虚拟配送器是否正确创建了假实体

---

## 已知正常行为

1. **虚拟配送器可见**（如果显示在监控面板）
   - 这是正常的，假实体让虚拟配送器完全融入游戏架构
   - 可以正常查看，不会报错

2. **假实体不可见**
   - `modelIndex = -1`，没有模型
   - 不会在游戏世界中看到任何假配送器

3. **配送器ID不连续**
   - 真实配送器：ID 1, 2, 3, ...
   - 虚拟配送器：ID 26, 27, 28, ...（根据创建顺序）
   - 这是正常的

---

## 回归测试

确认以下功能未受影响：

- [ ] 真实配送器的配送器-配送器物流正常
- [ ] 真实配送器的配送器-机甲物流正常
- [ ] 战场分析基站的其他功能正常（战斗、升级等）
- [ ] 其他 Mod 兼容性正常

---

## 成功标准

✅ **完全通过**：
- 所有测试场景通过
- 无 `NullReferenceException`
- 无 `IndexOutOfRangeException`
- 配送功能正常
- UI 完全稳定

⚠️ **部分通过**：
- 基本功能正常，但有性能问题或边界情况错误

❌ **失败**：
- UI 崩溃
- 配送功能异常
- 存档损坏

---

## 反馈

测试完成后，请提供：
1. 测试场景编号
2. 通过/失败状态
3. 日志文件（`BepInEx\LogOutput.log`）
4. 截图（如有错误）

感谢测试！🎉
