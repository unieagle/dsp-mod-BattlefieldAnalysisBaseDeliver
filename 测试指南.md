# 测试指南

## 📋 测试前准备

### 1. 确认配送器配置

在游戏中，检查需求方配送器（箱子上的配送器）：

✅ **必需条件**：
1. 配送器有无人机（至少1个，建议10个）
2. 配送器设置为"需求"模式（playerMode = Demand）
3. 配送器过滤器设置为战场基站有的物品（例如：燃料棒）

### 2. 确认战场基站状态

✅ **必需条件**：
1. 战场基站已建造并运行
2. 战场基站中有配送器需要的物品
3. 物品数量 > 0

---

## 🔍 新增的诊断日志

### 日志级别

最新版本包含详细的诊断日志，会在以下情况输出：

1. **前20次派遣检查**：详细输出所有信息
2. **每5秒一次**：持续输出关键信息（找到配对、准备派遣）
3. **关键事件**：始终输出（配对建立、无人机派遣）

### 日志内容说明

#### 1. 配对建立日志（RefreshDispenserTraffic）

```log
[战场分析基站配送支持] RefreshDispenser(NEW): planetId=24007，开始检查战场分析基站...
[战场分析基站配送支持] 📊   dispenser[1]: filter=1804 (氢燃料棒), playerMode=2 (2=需求)
[战场分析基站配送支持] 📊   dispenser[2]: filter=0 (无), playerMode=1 (2=需求)
[战场分析基站配送支持] 📊   battleBase[1]: entityId=11, pcId=3
[战场分析基站配送支持] 📊   battleBase[1].grids[0]: itemId=1804 (氢燃料棒), count=50
[战场分析基站配送支持] ✓ 已添加配对：虚拟配送器[2] (战场基站1) gridIdx=0 itemId=1804 (氢燃料棒) → 配送器[1]
```

**说明**：
- `dispenser[1]` = 需求方配送器（箱子上的）
- `dispenser[2]` = 虚拟配送器（代表战场基站）
- 配对已成功建立

#### 2. 派遣检查日志（InternalTick）

```log
[战场分析基站配送支持] 🔍 派遣检查 #1: dispenser[1] idle=10, work=0, pairCount=1
[战场分析基站配送支持]   检查 pair[0]: supplyId=2, isVirtual=true
[战场分析基站配送支持] ✅ 发现虚拟配送器配对! dispenser[1] pair[0]: supplyId=2
[战场分析基站配送支持] 🚀 准备派出无人机! dispenser[1] virtualPair[0] idleCouriers=10
```

**说明**：
- `idle=10` → 有10个空闲无人机 ✅
- `pairCount=1` → 有1个配对 ✅
- `supplyId=2` → 供应方是虚拟配送器[2] ✅
- `isVirtual=true` → 确认是虚拟配送器 ✅
- 满足所有条件，准备派遣！

#### 3. 派遣成功日志

```log
[战场分析基站配送支持] ⭐ 开始派遣无人机: dispenser[1], courierIdx=0
[战场分析基站配送支持] 🎯 开始派遣无人机到战场基站: courier[0], battleBaseId=1
```

**说明**：
- 无人机已成功派出

#### 4. 无人机到达和取货日志

```log
[战场分析基站配送支持] ✅ 无人机已到达战场基站！t=1.23 > 0.98 * maxt=1.20
[战场分析基站配送支持] 📦 从战场基站[1]取到5个物品 (1804: 氢燃料棒), 剩余45
[战场分析基站配送支持] 🔄 无人机开始返回配送器
```

**说明**：
- 无人机到达战场基站
- 成功取货（每次取5个）
- 返回配送器

---

## 🚦 可能的日志情况

### 情况1：完全正常

```log
✅ 配对建立
✅ 派遣检查
✅ 发现虚拟配送器配对
✅ 准备派出无人机
✅ 开始派遣
✅ 无人机到达
✅ 取货成功
✅ 返回配送器
```

**结果**：功能完全正常！🎉

---

### 情况2：没有派遣检查日志

```log
✅ 配对建立
❌ 没有看到"派遣检查"日志
```

**问题**：InternalTick Patch 没有被调用

**可能原因**：
1. Patch 没有正确应用
2. 配送器没有被游戏调用 InternalTick

**解决方案**：
- 检查 BepInEx 日志，确认 Patch 已应用
- 尝试重启游戏

---

### 情况3：有派遣检查，但 idle=0

```log
✅ 配对建立
✅ 派遣检查 #1: dispenser[1] idle=0, work=0, pairCount=1
⚠️ 不满足派遣条件: idle=0, pairs=true, pairCount=1
```

**问题**：配送器没有无人机！

**解决方案**：
1. 打开配送器UI
2. 点击右上角的"+"按钮添加无人机
3. 或者启用"自动补充无人机"

---

### 情况4：有派遣检查，但 pairCount=0

```log
❌ 没有看到"派遣检查"日志
或
✅ 派遣检查 #1: dispenser[1] idle=10, work=0, pairCount=0
```

**问题**：配对没有建立

**可能原因**：
1. 配送器的过滤器设置不匹配战场基站的物品
2. 配送器没有设置为"需求"模式
3. 战场基站中没有物品

**解决方案**：
1. 检查配送器过滤器（必须匹配战场基站有的物品）
2. 检查配送器模式（必须是"需求"）
3. 检查战场基站中是否有该物品

---

### 情况5：有配对，但 isVirtual=false

```log
✅ 派遣检查 #1: dispenser[1] idle=10, work=0, pairCount=1
✅ 检查 pair[0]: supplyId=5, isVirtual=false
⚠️ 没有找到虚拟配送器配对
```

**问题**：配对的 supplyId 不是虚拟配送器

**可能原因**：
1. 有其他真实配送器也在供应这个物品
2. 虚拟配送器没有正确创建

**解决方案**：
- 检查是否有其他配送器在供应同样的物品
- 查看 BepInEx 日志，确认虚拟配送器已创建

---

## 🛠️ 测试步骤

### 1. 重启游戏

确保最新版本的 mod 已加载。

### 2. 加载存档

打开包含战场基站的存档。

### 3. 检查配送器

打开需求方配送器UI：
- ✅ 确认有无人机（至少1个）
- ✅ 确认设置为"需求"模式
- ✅ 确认过滤器设置正确

### 4. 等待配对

等待几秒，配对会自动建立。

### 5. 观察日志

打开 `BepInEx/LogOutput.log`，搜索：
```
战场分析基站配送支持
```

查看最近的日志。

### 6. 观察无人机

在游戏中观察配送器：
- 应该看到无人机从配送器飞出
- 飞向战场基站
- 到达后无人机变为装载状态
- 返回配送器
- 然后飞向机甲配送

### 7. 检查UI错误

打开"监控面板"（Control Panel）：
- ✅ 应该不再显示虚拟配送器
- ✅ 应该没有 NullReferenceException

---

## 📊 预期行为

### 正常流程

```
1. 战场基站收集物品（例如：燃料棒 x50）
   ↓
2. 需求配送器需要该物品
   ↓
3. RefreshDispenserTraffic 建立配对：虚拟配送器[2] → 需求配送器[1]
   ↓
4. InternalTick 检测到配对，派出无人机
   ↓
5. 无人机从配送器飞向战场基站（空载）
   ↓
6. 无人机到达战场基站，取货（5个）
   ↓
7. 无人机返回配送器（装载）
   ↓
8. 无人机飞向机甲配送
   ↓
9. 重复步骤4-8，直到所有物品配送完毕
```

### 频率

- 每 60 帧（约1秒）检查一次是否需要派遣
- 每次派遣1个无人机
- 无人机取货量：min(5, courierCarries)
- 如果需要取50个物品，会派出10个无人机（每个取5个）

---

## 🐛 如果还是不工作

### 收集以下信息

1. **BepInEx 日志**：
   - 路径：`BepInEx/LogOutput.log`
   - 搜索：`战场分析基站配送支持`
   - 复制最近的 100 行

2. **游戏状态**：
   - 配送器有多少个无人机？
   - 配送器的过滤器是什么？
   - 配送器的模式是什么？（需求/供应）
   - 战场基站有什么物品？
   - 战场基站物品数量多少？

3. **截图**：
   - 配送器UI
   - 战场基站存储
   - 监控面板（如果有错误）

---

## ✅ 成功指标

如果看到以下情况，说明 mod 工作正常：

1. ✅ 配对成功建立
2. ✅ 无人机从配送器飞出
3. ✅ 无人机飞向战场基站（空载）
4. ✅ 无人机从战场基站返回（装载）
5. ✅ 战场基站物品数量减少
6. ✅ 机甲收到物品
7. ✅ 监控面板没有错误

---

## 📝 关键提示

1. **配送器必须有无人机！**
   - 这是最常见的问题
   - 配送器默认可能没有无人机
   - 手动添加或启用自动补充

2. **配送器必须设置为需求模式！**
   - playerMode = 2 (需求)
   - 不是供应模式

3. **过滤器必须匹配！**
   - 配送器的 filter 必须等于战场基站中物品的 itemId
   - 例如：燃料棒 = 1804

4. **等待60帧（1秒）！**
   - 派遣检查不是每帧都执行
   - 需要等待至少1秒才会看到第一次派遣

5. **查看日志！**
   - 日志会告诉你确切的问题
   - 前20次检查会详细输出所有信息

---

祝测试顺利！🚀
