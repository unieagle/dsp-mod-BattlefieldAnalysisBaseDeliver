# é…å¯¹åˆ é™¤æœºåˆ¶åˆ†æ

## ğŸ“‹ é—®é¢˜æ¸…å•

ç”¨æˆ·æå‡ºçš„å…³é”®é—®é¢˜ï¼š

1. **é…é€å™¨è®¾ç½®æ”¹å˜**ï¼šéœ€æ±‚ â†’ ä¾›åº”ï¼Œæˆ–ä¿®æ”¹ç‰©å“ç­›é€‰å™¨
2. **åŸºç«™æ‹†é™¤**ï¼šè™šæ‹Ÿé…é€å™¨çš„ç‰©ç†å®ä½“ä¸å­˜åœ¨äº†
3. **é…é€å™¨æ‹†é™¤**ï¼šéœ€æ±‚æ–¹é…é€å™¨è¢«æ‹†é™¤

è¿™äº›æƒ…å†µä¸‹ï¼ŒåŸæœ‰çš„é…å¯¹åº”è¯¥è¢«åˆ é™¤ã€‚

---

## ğŸ” æ¸¸æˆåŸç”Ÿçš„é…å¯¹åˆ é™¤æœºåˆ¶

### 1. ClearPairs æ–¹æ³•

```csharp
// DispenserComponent.cs, ç¬¬215è¡Œ
public void ClearPairs()
{
    this.pairCount = 0;
    this.playerPairCount = 0;
    if (this.pairs != null)
    {
        Array.Clear(this.pairs, 0, this.pairs.Length);
    }
}
```

**ä½œç”¨**ï¼šæ¸…ç©ºé…é€å™¨çš„æ‰€æœ‰é…å¯¹

---

### 2. RefreshDispenserTraffic æ–¹æ³•

```csharp
// PlanetTransport.cs, ç¬¬1264è¡Œ
public void RefreshDispenserTraffic(int keyId = 0)
{
    int logisticCourierCarries = GameMain.history.logisticCourierCarries;
    
    // 1. æ¸…ç©ºæ‰€æœ‰é…é€å™¨çš„é…å¯¹
    this.playerDeliveryPackage.ClearPairs();
    for (int i = 1; i < this.dispenserCursor; i++)
    {
        if (this.dispenserPool[i] != null && this.dispenserPool[i].id == i)
        {
            this.dispenserPool[i].ClearPairs();
        }
    }
    
    // 2. æ ¹æ®å½“å‰è®¾ç½®é‡æ–°å»ºç«‹é…å¯¹
    // ... (éå†æ‰€æœ‰é…é€å™¨ï¼Œæ ¹æ® playerModeã€filter ç­‰é‡æ–°é…å¯¹) ...
    
    // 3. è§¦å‘å›è°ƒï¼ˆæˆ‘ä»¬çš„è¡¥ä¸æ¥å…¥è¿™é‡Œï¼‰
    if (PlanetTransport.onFactoryRefreshDispenserTraffic != null)
    {
        PlanetTransport.onFactoryRefreshDispenserTraffic(this.factory, keyId);
    }
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- æ¸…ç©º **æ‰€æœ‰é…é€å™¨** çš„é…å¯¹
- ç„¶å **å®Œå…¨é‡å»º** é…å¯¹
- **ä¸æ˜¯å¢é‡å¼**ï¼Œè€Œæ˜¯ **å…¨é‡é‡å»º**

---

### 3. RefreshDispenserTraffic çš„è°ƒç”¨æ—¶æœº

```csharp
// åœºæ™¯1: ä¿®æ”¹ç‰©å“ç­›é€‰å™¨
SetDispenserFilter(int dispenserId, int filter)
{
    // ...
    this.RefreshDispenserTraffic(dispenserId);
}

// åœºæ™¯2: ä¿®æ”¹éœ€æ±‚/ä¾›åº”æ¨¡å¼
SetDispenserPlayerDeliveryMode(int dispenserId, EPlayerDeliveryMode playerDeliveryMode)
{
    // ...
    this.RefreshDispenserTraffic(dispenserId);
}

// åœºæ™¯3: ä¿®æ”¹å­˜å‚¨æ¨¡å¼
SetDispenserStorageDeliveryMode(int dispenserId, EStorageDeliveryMode storageDeliveryMode)
{
    // ...
    this.RefreshDispenserTraffic(dispenserId);
}

// åœºæ™¯4: æ‹†é™¤é…é€å™¨
RemoveDispenserComponent(int id)
{
    // ... æ¸…ç†å·¥ä½œ ...
    this.RefreshDispenserTraffic(id);
}
```

**æ€»ç»“**ï¼š
- âœ… **é…é€å™¨è®¾ç½®æ”¹å˜** â†’ è‡ªåŠ¨è§¦å‘ `RefreshDispenserTraffic`
- âœ… **é…é€å™¨æ‹†é™¤** â†’ è‡ªåŠ¨è§¦å‘ `RefreshDispenserTraffic`
- âŒ **åŸºç«™æ‹†é™¤** â†’ **æ²¡æœ‰** è§¦å‘æœºåˆ¶

---

## ğŸ¯ æˆ‘ä»¬çš„ Mod å¦‚ä½•æ¥å…¥

### æ¥å…¥ç‚¹ï¼šonFactoryRefreshDispenserTraffic å›è°ƒ

```csharp
// PlanetTransport_RefreshDispenserTraffic_NEW.cs
[HarmonyPostfix]
static void Postfix(PlanetFactory factory, int keyId)
{
    // 1. ç¡®ä¿è™šæ‹Ÿé…é€å™¨å­˜åœ¨
    VirtualDispenserManager.CreateVirtualDispensers(factory);
    
    // 2. ä¸ºæ¯ä¸ªéœ€æ±‚é…é€å™¨å»ºç«‹é…å¯¹
    for each dispenser:
        if (dispenser.playerMode == Demand && dispenser.filter == itemId)
        {
            // æ£€æŸ¥è™šæ‹Ÿé…é€å™¨æ˜¯å¦å·²æœ‰è¿™ä¸ªç‰©å“
            // å»ºç«‹é…å¯¹ï¼šè™šæ‹Ÿé…é€å™¨ â†’ é…é€å™¨
            dispenser.AddPair(virtualDispenserId, gridIdx, dispenserId, 0);
        }
}
```

**è¿ä½œæœºåˆ¶**ï¼š

1. æ¸¸æˆè°ƒç”¨ `RefreshDispenserTraffic`
2. æ¸¸æˆæ¸…ç©ºæ‰€æœ‰é…å¯¹ï¼ˆåŒ…æ‹¬æˆ‘ä»¬çš„ï¼‰
3. æ¸¸æˆé‡æ–°å»ºç«‹æ¸¸æˆåŸç”Ÿçš„é…å¯¹
4. æ¸¸æˆè§¦å‘å›è°ƒ `onFactoryRefreshDispenserTraffic`
5. **æˆ‘ä»¬çš„è¡¥ä¸è¿è¡Œ**ï¼Œå»ºç«‹è™šæ‹Ÿé…é€å™¨çš„é…å¯¹

**ä¼˜ç‚¹**ï¼š
- âœ… é…é€å™¨è®¾ç½®æ”¹å˜æ—¶ï¼Œé…å¯¹ä¼šè‡ªåŠ¨é‡å»º
- âœ… é…é€å™¨æ‹†é™¤æ—¶ï¼Œé…å¯¹ä¼šè‡ªåŠ¨æ¸…ç†
- âœ… ä¸éœ€è¦æ‰‹åŠ¨åˆ é™¤é…å¯¹

---

## âš ï¸ å½“å‰å­˜åœ¨çš„é—®é¢˜

### é—®é¢˜1ï¼šåŸºç«™æ‹†é™¤æ—¶ï¼Œè™šæ‹Ÿé…é€å™¨ä¸ä¼šè¢«æ¸…ç†

**ç°çŠ¶**ï¼š

```
1. åˆ›å»ºè™šæ‹Ÿé…é€å™¨ï¼šbattleBaseId=1 â†’ virtualDispenserId=2
2. å»ºç«‹é…å¯¹ï¼šè™šæ‹Ÿé…é€å™¨[2] â†’ é…é€å™¨[1]
3. ç”¨æˆ·æ‹†é™¤åŸºç«™[1]
4. âŒ è™šæ‹Ÿé…é€å™¨[2] ä»ç„¶åœ¨ dispenserPool ä¸­
5. âŒ é…å¯¹ä»ç„¶å­˜åœ¨ï¼šè™šæ‹Ÿé…é€å™¨[2] â†’ é…é€å™¨[1]
6. âŒ æ´¾é£é€»è¾‘ä»ç„¶ä¼šå°è¯•æ´¾é£æ— äººæœº
7. ğŸ’¥ æ— äººæœºé£å‘ä¸å­˜åœ¨çš„ entityId
```

**æ½œåœ¨åæœ**ï¼š
- æ— äººæœºé£å‘æ— æ•ˆçš„ä½ç½®
- æ¸¸æˆå¯èƒ½å´©æºƒæˆ–å‡ºç° `NullReferenceException`
- å­˜æ¡£å¯èƒ½æŸå

---

### é—®é¢˜2ï¼šé…å¯¹å¯èƒ½æŒ‡å‘æ— æ•ˆçš„è™šæ‹Ÿé…é€å™¨

**åœºæ™¯**ï¼š

```
ç”¨æˆ·æ‹†é™¤åŸºç«™[1] â†’ entityId å˜ä¸º 0
ä½†é…å¯¹ä»ç„¶å­˜åœ¨ï¼švirtualDispenserId=2 â†’ dispenserId=1

RefreshDispenserTraffic é‡å»ºé…å¯¹æ—¶ï¼š
- æ£€æŸ¥ virtualDispenserId=2 æ˜¯å¦æœ‰ç‰©å“
- âŒ ä½† entityId=0ï¼ŒåŸºç«™ä¸å­˜åœ¨äº†
- âŒ ä»ç„¶å¯èƒ½å»ºç«‹é…å¯¹ï¼ˆå–å†³äºæˆ‘ä»¬çš„æ£€æŸ¥é€»è¾‘ï¼‰
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šåœ¨æ´¾é£å‰æ£€æŸ¥åŸºç«™æ˜¯å¦å­˜åœ¨ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

```csharp
// DispenserComponent_InternalTick_Patch.cs
private static bool CheckBattleBaseExists(PlanetFactory factory, int battleBaseId)
{
    var defenseSystem = factory.defenseSystem;
    if (defenseSystem == null) return false;
    
    var battleBasesField = defenseSystem.GetType().GetField("battleBases", ...);
    var battleBasesPool = battleBasesField.GetValue(defenseSystem);
    var bufferField = battleBasesPool.GetType().GetField("buffer", ...);
    Array? battleBases = bufferField.GetValue(battleBasesPool) as Array;
    
    if (battleBases == null || battleBaseId >= battleBases.Length) return false;
    
    object? battleBase = battleBases.GetValue(battleBaseId);
    if (battleBase == null) return false;
    
    // æ£€æŸ¥ entityId
    var entityIdField = battleBase.GetType().GetField("entityId");
    int entityId = (int)entityIdField.GetValue(battleBase)!;
    
    return entityId > 0;  // entityId > 0 è¯´æ˜åŸºç«™å­˜åœ¨
}

// åœ¨æ´¾é£å‰æ£€æŸ¥
if (!CheckBattleBaseExists(factory, battleBaseId))
{
    // åŸºç«™ä¸å­˜åœ¨ï¼Œè·³è¿‡æ´¾é£
    continue;
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… é˜²æ­¢æ— äººæœºé£å‘ä¸å­˜åœ¨çš„åŸºç«™
- âœ… ç®€å•ï¼Œå®¹æ˜“å®ç°

**ç¼ºç‚¹**ï¼š
- âš ï¸ è™šæ‹Ÿé…é€å™¨å’Œé…å¯¹ä»ç„¶å­˜åœ¨ï¼ˆå ç”¨å†…å­˜ï¼‰
- âš ï¸ æ¯æ¬¡æ´¾é£éƒ½è¦æ£€æŸ¥ï¼ˆæ€§èƒ½å¼€é”€ï¼‰

---

### æ–¹æ¡ˆ2ï¼šå»ºç«‹é…å¯¹æ—¶æ£€æŸ¥åŸºç«™æ˜¯å¦å­˜åœ¨ï¼ˆæ¨èï¼‰

```csharp
// PlanetTransport_RefreshDispenserTraffic_NEW.cs
// åœ¨å»ºç«‹é…å¯¹å‰æ£€æŸ¥
if (!CheckBattleBaseExists(factory, battleBaseId))
{
    // åŸºç«™ä¸å­˜åœ¨ï¼Œè·³è¿‡è¿™ä¸ªè™šæ‹Ÿé…é€å™¨
    continue;
}

// åªä¸ºå­˜åœ¨çš„åŸºç«™å»ºç«‹é…å¯¹
dispenser.AddPair(virtualDispenserId, gridIdx, dispenserId, 0);
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸ä¸ºä¸å­˜åœ¨çš„åŸºç«™å»ºç«‹é…å¯¹
- âœ… æ›´é«˜æ•ˆï¼ˆåªåœ¨é…å¯¹æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼‰
- âœ… é…å¯¹æ•°é‡æ›´å‡†ç¡®

**ç¼ºç‚¹**ï¼š
- âš ï¸ è™šæ‹Ÿé…é€å™¨ä»ç„¶å­˜åœ¨ï¼ˆä½†æ²¡æœ‰é…å¯¹æŒ‡å‘å®ƒï¼‰

---

### æ–¹æ¡ˆ3ï¼šåŸºç«™æ‹†é™¤æ—¶æ¸…ç†è™šæ‹Ÿé…é€å™¨ï¼ˆå®Œç¾æ–¹æ¡ˆï¼Œä½†å¤æ‚ï¼‰

```csharp
// æ–°è¡¥ä¸ï¼šPlanetFactory_RemoveEntityWithComponents_Patch.cs
[HarmonyPostfix]
static void Postfix(PlanetFactory __instance, int id)
{
    // æ£€æŸ¥è¢«æ‹†é™¤çš„å®ä½“æ˜¯å¦æ˜¯æˆ˜åœºåˆ†æåŸºç«™
    var entityPool = __instance.entityPool;
    if (entityPool[id].battleBaseId > 0)
    {
        int battleBaseId = entityPool[id].battleBaseId;
        
        // æŸ¥æ‰¾å¯¹åº”çš„è™šæ‹Ÿé…é€å™¨
        if (VirtualDispenserManager.TryGetVirtualDispenserId(battleBaseId, out int virtualDispenserId))
        {
            // æ¸…ç†è™šæ‹Ÿé…é€å™¨
            // 1. ä» dispenserPool ä¸­ç§»é™¤ï¼ˆæˆ–æ ‡è®°ä¸ºæ— æ•ˆï¼‰
            // 2. è§¦å‘ RefreshDispenserTraffic æ¸…ç†é…å¯¹
            __instance.transport.RemoveDispenserComponent(virtualDispenserId);
            
            // 3. ä»æ˜ å°„ä¸­ç§»é™¤
            VirtualDispenserManager.RemoveMapping(virtualDispenserId, battleBaseId);
        }
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®Œå…¨æ¸…ç†è™šæ‹Ÿé…é€å™¨å’Œé…å¯¹
- âœ… ä¸å ç”¨é¢å¤–å†…å­˜
- âœ… é€»è¾‘å®Œæ•´

**ç¼ºç‚¹**ï¼š
- âš ï¸ å®ç°å¤æ‚ï¼ˆéœ€è¦æ‰¾åˆ°åŸºç«™æ‹†é™¤çš„è¡¥ä¸ç‚¹ï¼‰
- âš ï¸ å¯èƒ½ä¸æ¸¸æˆçš„å…¶ä»–é€»è¾‘å†²çª

---

### æ–¹æ¡ˆ4ï¼šè™šæ‹Ÿé…é€å™¨è‡ªæˆ‘éªŒè¯ï¼ˆæ··åˆæ–¹æ¡ˆï¼Œæ¨èï¼‰

```csharp
// VirtualDispenserManager.cs
public static bool IsVirtualDispenserValid(PlanetFactory factory, int virtualDispenserId)
{
    // 1. æ£€æŸ¥æ˜¯å¦æ˜¯è™šæ‹Ÿé…é€å™¨
    if (!TryGetBattleBaseId(virtualDispenserId, out int battleBaseId))
        return false;
    
    // 2. æ£€æŸ¥åŸºç«™æ˜¯å¦å­˜åœ¨
    if (!CheckBattleBaseExists(factory, battleBaseId))
    {
        // åŸºç«™ä¸å­˜åœ¨ï¼Œä»æ˜ å°„ä¸­ç§»é™¤ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
        RemoveMapping(virtualDispenserId, battleBaseId);
        return false;
    }
    
    return true;
}

// ä½¿ç”¨ï¼š
// åœ¨ RefreshDispenserTraffic å»ºç«‹é…å¯¹æ—¶
if (!VirtualDispenserManager.IsVirtualDispenserValid(factory, virtualDispenserId))
    continue;

// åœ¨ InternalTick æ´¾é£æ—¶
if (!VirtualDispenserManager.IsVirtualDispenserValid(factory, pair.supplyId))
    continue;
```

**ä¼˜ç‚¹**ï¼š
- âœ… åœ¨å¤šä¸ªå…³é”®ç‚¹æ£€æŸ¥ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
- âœ… è‡ªåŠ¨æ¸…ç†æ˜ å°„ï¼ˆå‡å°‘å†…å­˜å ç”¨ï¼‰
- âœ… å®ç°ç®€å•ï¼Œå®¹æ˜“ç»´æŠ¤

**ç¼ºç‚¹**ï¼š
- âš ï¸ è™šæ‹Ÿé…é€å™¨å®ä¾‹ä»åœ¨ dispenserPool ä¸­ï¼ˆä½†ä¸å½±å“åŠŸèƒ½ï¼‰

---

## ğŸ“Š ç°çŠ¶æ€»ç»“

### âœ… å·²ç»å¤„ç†çš„åœºæ™¯

| åœºæ™¯ | è§¦å‘æœºåˆ¶ | æ¸…ç†æ•ˆæœ | æˆ‘ä»¬çš„å¤„ç† |
|------|----------|----------|-----------|
| ä¿®æ”¹é…é€å™¨ç­›é€‰å™¨ | `RefreshDispenserTraffic` | æ¸…ç©ºæ‰€æœ‰é…å¯¹ | âœ… è‡ªåŠ¨é‡å»ºé…å¯¹ |
| ä¿®æ”¹é…é€å™¨æ¨¡å¼ | `RefreshDispenserTraffic` | æ¸…ç©ºæ‰€æœ‰é…å¯¹ | âœ… è‡ªåŠ¨é‡å»ºé…å¯¹ |
| æ‹†é™¤é…é€å™¨ | `RefreshDispenserTraffic` | æ¸…ç©ºæ‰€æœ‰é…å¯¹ | âœ… è‡ªåŠ¨æ¸…ç†é…å¯¹ |

---

### âŒ å°šæœªå¤„ç†çš„åœºæ™¯

| åœºæ™¯ | è§¦å‘æœºåˆ¶ | æ¸…ç†æ•ˆæœ | æˆ‘ä»¬çš„å¤„ç† |
|------|----------|----------|-----------|
| æ‹†é™¤åŸºç«™ | **æ— ** | **æ— ** | âŒ è™šæ‹Ÿé…é€å™¨å’Œé…å¯¹ä»ç„¶å­˜åœ¨ |

---

## ğŸ¯ æ¨èå®æ–½æ–¹æ¡ˆ

### çŸ­æœŸæ–¹æ¡ˆï¼ˆç«‹å³å®æ–½ï¼‰

**æ–¹æ¡ˆ2 + æ–¹æ¡ˆ1**ï¼š
1. **åœ¨å»ºç«‹é…å¯¹æ—¶æ£€æŸ¥**åŸºç«™æ˜¯å¦å­˜åœ¨ï¼ˆæ–¹æ¡ˆ2ï¼‰
2. **åœ¨æ´¾é£å‰æ£€æŸ¥**åŸºç«™æ˜¯å¦å­˜åœ¨ï¼ˆæ–¹æ¡ˆ1ï¼Œä½œä¸ºé¢å¤–ä¿é™©ï¼‰

**ä»£ç ä½ç½®**ï¼š
- `PlanetTransport_RefreshDispenserTraffic_NEW.cs`ï¼ˆå»ºç«‹é…å¯¹æ—¶ï¼‰
- `DispenserComponent_InternalTick_Patch.cs`ï¼ˆæ´¾é£æ—¶ï¼‰

---

### é•¿æœŸæ–¹æ¡ˆï¼ˆå®Œå–„ä½“éªŒï¼‰

**æ–¹æ¡ˆ4**ï¼šè™šæ‹Ÿé…é€å™¨è‡ªæˆ‘éªŒè¯
- ç»Ÿä¸€çš„éªŒè¯æ¥å£
- è‡ªåŠ¨æ¸…ç†æ˜ å°„
- å¤šç‚¹æ£€æŸ¥

**é¢å¤–æ”¹è¿›**ï¼š
- æ·»åŠ è™šæ‹Ÿé…é€å™¨ç®¡ç†ç•Œé¢ï¼ˆè°ƒè¯•ç”¨ï¼‰
- ç›‘æ§è™šæ‹Ÿé…é€å™¨çš„å¥åº·çŠ¶æ€
- å®šæœŸæ¸…ç†æ— æ•ˆçš„è™šæ‹Ÿé…é€å™¨

---

## ğŸ“ éœ€è¦æ·»åŠ çš„ä»£ç 

### 1. åŸºç«™å­˜åœ¨æ€§æ£€æŸ¥æ–¹æ³•

```csharp
// VirtualDispenserManager.cs
public static bool CheckBattleBaseExists(PlanetFactory factory, int battleBaseId)
{
    try
    {
        var defenseSystem = factory.defenseSystem;
        if (defenseSystem == null) return false;
        
        var battleBasesField = defenseSystem.GetType().GetField("battleBases", 
            BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance);
        if (battleBasesField == null) return false;
        
        object? battleBasesPool = battleBasesField.GetValue(defenseSystem);
        if (battleBasesPool == null) return false;
        
        var bufferField = battleBasesPool.GetType().GetField("buffer", 
            BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance);
        if (bufferField == null) return false;
        
        Array? battleBases = bufferField.GetValue(battleBasesPool) as Array;
        if (battleBases == null || battleBaseId >= battleBases.Length) return false;
        
        object? battleBase = battleBases.GetValue(battleBaseId);
        if (battleBase == null) return false;
        
        var entityIdField = battleBase.GetType().GetField("entityId");
        if (entityIdField == null) return false;
        
        int entityId = (int)entityIdField.GetValue(battleBase)!;
        return entityId > 0;
    }
    catch
    {
        return false;
    }
}
```

---

### 2. åœ¨å»ºç«‹é…å¯¹æ—¶æ£€æŸ¥

```csharp
// PlanetTransport_RefreshDispenserTraffic_NEW.cs
// åœ¨ç¬¬250è¡Œå·¦å³ï¼Œå»ºç«‹é…å¯¹å‰æ·»åŠ ï¼š

// âœ… æ£€æŸ¥åŸºç«™æ˜¯å¦ä»ç„¶å­˜åœ¨
if (!VirtualDispenserManager.CheckBattleBaseExists(factory, battleBaseId))
{
    if (debugLog)
    {
        Plugin.Log?.LogWarning($"[{PluginInfo.PLUGIN_NAME}] âš ï¸ æˆ˜åœºåŸºç«™[{battleBaseId}]ä¸å­˜åœ¨ï¼Œè·³è¿‡è™šæ‹Ÿé…é€å™¨[{virtualDispenserId}]");
    }
    continue;  // è·³è¿‡è¿™ä¸ªè™šæ‹Ÿé…é€å™¨
}
```

---

### 3. åœ¨æ´¾é£æ—¶æ£€æŸ¥

```csharp
// DispenserComponent_InternalTick_Patch.cs
// åœ¨ DispatchOneCourierToBattleBase æ–¹æ³•ä¸­ï¼Œæ´¾é£å‰æ·»åŠ ï¼š

// è·å–åŸºç«™ID
if (!VirtualDispenserManager.TryGetBattleBaseId(pair.supplyId, out int battleBaseId))
{
    continue;
}

// âœ… æ£€æŸ¥åŸºç«™æ˜¯å¦ä»ç„¶å­˜åœ¨
if (!VirtualDispenserManager.CheckBattleBaseExists(factory, battleBaseId))
{
    Plugin.Log?.LogWarning($"[{PluginInfo.PLUGIN_NAME}] âš ï¸ æˆ˜åœºåŸºç«™[{battleBaseId}]ä¸å­˜åœ¨ï¼Œå–æ¶ˆæ´¾é£");
    continue;
}
```

---

## âš ï¸ æœªæ¥å¯èƒ½éœ€è¦çš„æ”¹è¿›

### 1. ç›‘å¬åŸºç«™æ‹†é™¤äº‹ä»¶

å¦‚æœæ¸¸æˆæä¾›äº†åŸºç«™æ‹†é™¤çš„äº‹ä»¶æˆ–å›è°ƒï¼Œæˆ‘ä»¬åº”è¯¥æ¥å…¥ã€‚

### 2. å®šæœŸæ¸…ç†è™šæ‹Ÿé…é€å™¨

æ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆå¦‚1ç§’ï¼‰ï¼Œæ£€æŸ¥æ‰€æœ‰è™šæ‹Ÿé…é€å™¨ï¼š
- å¦‚æœå¯¹åº”çš„åŸºç«™ä¸å­˜åœ¨ï¼Œæ¸…ç†è™šæ‹Ÿé…é€å™¨
- å¦‚æœæ˜ å°„ä¸ä¸€è‡´ï¼Œä¿®å¤æ˜ å°„

### 3. è™šæ‹Ÿé…é€å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

- åˆ›å»ºï¼šå½“åŸºç«™å»ºé€ å®Œæˆæ—¶
- æ›´æ–°ï¼šå½“åŸºç«™ç§»åŠ¨æˆ–å‡çº§æ—¶ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
- é”€æ¯ï¼šå½“åŸºç«™æ‹†é™¤æ—¶

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒæœºåˆ¶

æ¸¸æˆçš„é…å¯¹åˆ é™¤æœºåˆ¶æ˜¯ **å…¨é‡é‡å»º**ï¼Œè€Œä¸æ˜¯å¢é‡å¼ï¼š

1. æ¸…ç©ºæ‰€æœ‰é…å¯¹ï¼ˆ`ClearPairs`ï¼‰
2. æ ¹æ®å½“å‰è®¾ç½®é‡æ–°å»ºç«‹é…å¯¹
3. è§¦å‘å›è°ƒï¼ˆæˆ‘ä»¬åœ¨è¿™é‡Œæ¥å…¥ï¼‰

### æˆ‘ä»¬çš„ç­–ç•¥

1. âœ… **ä¾èµ–æ¸¸æˆçš„ RefreshDispenserTraffic**
   - ä¸éœ€è¦æ‰‹åŠ¨åˆ é™¤é…å¯¹
   - é…é€å™¨è®¾ç½®æ”¹å˜æ—¶è‡ªåŠ¨å¤„ç†

2. âš ï¸ **æ·»åŠ åŸºç«™å­˜åœ¨æ€§æ£€æŸ¥**
   - å»ºç«‹é…å¯¹æ—¶æ£€æŸ¥ï¼ˆé˜²æ­¢å»ºç«‹æ— æ•ˆé…å¯¹ï¼‰
   - æ´¾é£æ—¶æ£€æŸ¥ï¼ˆé˜²æ­¢é£å‘ä¸å­˜åœ¨çš„åŸºç«™ï¼‰

3. ğŸ¯ **é˜²å¾¡æ€§ç¼–ç¨‹**
   - å¤šä¸ªå…³é”®ç‚¹æ£€æŸ¥
   - è‡ªåŠ¨æ¸…ç†æ— æ•ˆæ˜ å°„
   - ä¼˜é›…é™çº§ï¼ˆè€Œä¸æ˜¯å´©æºƒï¼‰

### ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§**ï¼ˆç°åœ¨å®æ–½ï¼‰ï¼š
   - âœ… å»ºç«‹é…å¯¹æ—¶æ£€æŸ¥åŸºç«™æ˜¯å¦å­˜åœ¨
   - âœ… æ´¾é£æ—¶æ£€æŸ¥åŸºç«™æ˜¯å¦å­˜åœ¨

2. **ä¸­ä¼˜å…ˆçº§**ï¼ˆä¸‹ä¸ªç‰ˆæœ¬ï¼‰ï¼š
   - ğŸ”„ è™šæ‹Ÿé…é€å™¨è‡ªæˆ‘éªŒè¯æœºåˆ¶
   - ğŸ”„ è‡ªåŠ¨æ¸…ç†æ˜ å°„

3. **ä½ä¼˜å…ˆçº§**ï¼ˆæœªæ¥æ”¹è¿›ï¼‰ï¼š
   - ğŸ“‹ ç›‘å¬åŸºç«™æ‹†é™¤äº‹ä»¶
   - ğŸ“‹ å®šæœŸæ¸…ç†æ— æ•ˆè™šæ‹Ÿé…é€å™¨
