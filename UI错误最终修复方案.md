# UI é”™è¯¯æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

## æ—¶é—´
2026-01-30 14:30

## é—®é¢˜æ ¹æº

ç”¨æˆ·æŠ¥å‘Šæ¸¸æˆä»ç„¶å‡ºçŽ° `NullReferenceException`ï¼Œå‘ç”Ÿåœ¨ `UIControlPanelDispenserEntry.OnSetTarget()` ä¸­ã€‚

ç»è¿‡åˆ†æžå‘çŽ°ï¼Œä¹‹å‰çš„ UI è¿‡æ»¤æ–¹æ¡ˆï¼ˆ`UIControlPanelWindow_DetermineFilterResults_Patch`ï¼‰å­˜åœ¨è‡´å‘½ç¼ºé™·ï¼š

### æ–¹æ¡ˆAçš„é—®é¢˜ï¼ˆå·²åºŸå¼ƒï¼‰

**ç­–ç•¥**ï¼šåœ¨ `DetermineFilterResults` çš„ Postfix ä¸­ï¼Œä»Ž `results` åˆ—è¡¨ç§»é™¤è™šæ‹Ÿé…é€å™¨ã€‚

**é—®é¢˜**ï¼š
1. æ¸¸æˆä½¿ç”¨**ä¸‰ä¸ªåŒæ­¥åˆ—è¡¨**ï¼š
   - `results` - å­˜å‚¨ `ControlPanelTarget` å¯¹è±¡
   - `resultPositions` - å­˜å‚¨ UI ä½ç½®ï¼ˆç´¯ç§¯é«˜åº¦ï¼‰
   - `resultEntries` - å­˜å‚¨ UI entry å¯¹è±¡

2. æˆ‘ä»¬åªç§»é™¤äº† `results` ä¸­çš„é¡¹ç›®ï¼Œ**æ²¡æœ‰åŒæ­¥ç§»é™¤** `resultPositions` å’Œ `resultEntries`

3. å¯¼è‡´ä¸‰ä¸ªåˆ—è¡¨**ç´¢å¼•ä¸åŒ¹é…**ï¼Œå½“ UI å°è¯•è®¿é—®æ—¶ï¼š
   ```csharp
   // UI ä»£ç 
   int position = this.resultPositions[index];  // â† ç´¢å¼•å·²é”™ä½ï¼
   UIControlPanelObjectEntry entry = this.resultEntries[index];  // â† è®¿é—®åˆ°é”™è¯¯çš„ entryï¼
   ```

4. æœ€ç»ˆåœ¨ `OnSetTarget` æ—¶è®¿é—®åˆ°é”™è¯¯çš„ `ControlPanelTarget`ï¼Œå¼•å‘ `NullReferenceException`

## æœ€ç»ˆæ–¹æ¡ˆï¼šUI å®‰å…¨æ£€æŸ¥ï¼ˆPrefixï¼‰

### ç­–ç•¥

**ä¸å°è¯•éšè—è™šæ‹Ÿé…é€å™¨**ï¼Œè€Œæ˜¯åœ¨ `OnSetTarget` ä¸­**å®‰å…¨åœ°è·³è¿‡å®ƒä»¬**ï¼š

```csharp
[HarmonyPatch(typeof(UIControlPanelDispenserEntry), "OnSetTarget")]
[HarmonyPrefix]
static bool Prefix(ref ControlPanelTarget target)
{
    // 1. èŽ·å– entity
    var entity = factory.entityPool[target.objId];
    
    // 2. æ£€æŸ¥ entity.dispenserId
    if (entity.dispenserId == 0)  // è™šæ‹Ÿé…é€å™¨
    {
        return false;  // è·³è¿‡åŽŸæ–¹æ³•ï¼Œé¿å… NullReferenceException
    }
    
    return true;  // æ­£å¸¸æ‰§è¡Œ
}
```

### åŽŸç†

1. **è™šæ‹Ÿé…é€å™¨çš„ entityId æŒ‡å‘æˆ˜åœºåŸºç«™çš„å®žä½“**
2. **æˆ˜åœºåŸºç«™å®žä½“çš„ `dispenserId = 0`**ï¼ˆå› ä¸ºå®ƒä¸æ˜¯é…é€å™¨ï¼‰
3. åœ¨ `OnSetTarget` è¢«è°ƒç”¨æ—¶ï¼Œæ£€æŸ¥ `entity.dispenserId`
4. å¦‚æžœä¸º 0ï¼Œè¯´æ˜Žè¿™æ˜¯è™šæ‹Ÿé…é€å™¨ï¼Œè·³è¿‡æ‰§è¡ŒåŽŸæ–¹æ³•
5. é¿å…åŽç»­çš„ `dispenserPool[0]` è®¿é—®ï¼Œé˜²æ­¢ `NullReferenceException`

### ä¼˜åŠ¿

1. âœ… **ä¸ä¿®æ”¹ UI åˆ—è¡¨**ï¼šä¿æŒ `results`ã€`resultPositions`ã€`resultEntries` å®Œå…¨åŒæ­¥
2. âœ… **ç²¾å‡†æ‹¦æˆª**ï¼šåªåœ¨çœŸæ­£å¯èƒ½å‡ºé”™çš„åœ°æ–¹ï¼ˆ`OnSetTarget`ï¼‰è¿›è¡Œæ£€æŸ¥
3. âœ… **ç®€å•æ¸…æ™°**ï¼šåªéœ€è¦ä¸€ä¸ª Prefix è¡¥ä¸
4. âœ… **å®‰å…¨å¯é **ï¼šå³ä½¿æ£€æŸ¥å¤±è´¥ï¼Œä¹Ÿä¸ä¼šå´©æºƒï¼ˆPrefix æœ‰ try-catchï¼‰

### å‰¯ä½œç”¨

- âš ï¸ **è™šæ‹Ÿé…é€å™¨ä»ç„¶ä¼šæ˜¾ç¤ºåœ¨ç›‘æŽ§é¢æ¿ä¸­**ï¼ˆæ˜¾ç¤ºä¸ºæˆ˜åœºåŸºç«™ï¼‰
- âš ï¸ **ç‚¹å‡»è™šæ‹Ÿé…é€å™¨æ—¶ä¸ä¼šæœ‰ä»»ä½•ååº”**ï¼ˆè¢« Prefix æ‹¦æˆªï¼‰

ä½†è¿™ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºï¼š
- ç”¨æˆ·é€šå¸¸ä¸éœ€è¦åœ¨ç›‘æŽ§é¢æ¿ä¸­æŸ¥çœ‹è™šæ‹Ÿé…é€å™¨
- è™šæ‹Ÿé…é€å™¨åœ¨åŽå°æ­£å¸¸å·¥ä½œï¼ˆé…é€åŠŸèƒ½ä¸å—å½±å“ï¼‰
- é¿å…äº†å´©æºƒï¼Œæ¯”å®Œå…¨éšè—æ›´å®‰å…¨

## ä»£ç å˜æ›´

### æ–°å¢žæ–‡ä»¶

**`Patches/UIControlPanelDispenserEntry_OnSetTarget_Patch.cs`**
- Prefixï¼šæ£€æŸ¥ `entity.dispenserId`ï¼Œå¦‚æžœä¸º 0 åˆ™è·³è¿‡æ‰§è¡Œ

### ä¿®æ”¹æ–‡ä»¶

**`Plugin.cs`**
- æ³¨å†Œæ–°çš„è¡¥ä¸ï¼š`UIControlPanelDispenserEntry.OnSetTarget`
- æ›´æ–°åŠ è½½æ—¥å¿—ï¼š`ä½¿ç”¨è™šæ‹Ÿé…é€å™¨æ–¹æ¡ˆï¼ˆUI å®‰å…¨æ£€æŸ¥ï¼‰`

**`Patches/UIControlPanelWindow_DetermineFilterResults_Patch.cs`**
- é‡å‘½åä¸º `UIControlPanelWindow_DetermineFilterResults_Patch_DISABLED`ï¼ˆåºŸå¼ƒï¼‰
- ä¿ç•™æ–‡ä»¶ä½œä¸ºåŽ†å²è®°å½•å’Œè¯´æ˜Ž

## æµ‹è¯•è¦ç‚¹

1. **å¯åŠ¨æ¸¸æˆï¼ŒåŠ è½½å­˜æ¡£**

2. **æ£€æŸ¥æ—¥å¿—** åº”è¯¥çœ‹åˆ°ï¼š
   ```
   [Info] å·²å¯¹ UIControlPanelDispenserEntry.OnSetTarget åº”ç”¨è¡¥ä¸ï¼ˆè·³è¿‡è™šæ‹Ÿé…é€å™¨ï¼‰
   [Info] âœ… åŠ è½½å®Œæˆï¼ä½¿ç”¨è™šæ‹Ÿé…é€å™¨æ–¹æ¡ˆï¼ˆUI å®‰å…¨æ£€æŸ¥ï¼‰
   ```

3. **æ‰“å¼€ç›‘æŽ§é¢æ¿**ï¼š
   - âœ… é¢æ¿æ­£å¸¸æ‰“å¼€ï¼Œæ— å´©æºƒ
   - âœ… æ»šåŠ¨åˆ°ä»»æ„ä½ç½®ï¼Œæ— å´©æºƒ
   - âš ï¸ è™šæ‹Ÿé…é€å™¨å¯èƒ½æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºä¸ºæˆ˜åœºåŸºç«™ï¼‰ï¼Œä½†ç‚¹å‡»æ— ååº”
   - âœ… çœŸå®žé…é€å™¨å¯ä»¥æ­£å¸¸é€‰æ‹©å’Œæ“ä½œ

4. **éªŒè¯é…é€åŠŸèƒ½**ï¼š
   - âœ… é…é€å™¨ä»ç„¶å¯ä»¥ä»Žæˆ˜åœºåˆ†æžåŸºç«™å–è´§
   - âœ… æ— äººæœºé£žè¡ŒåŠ¨ç”»æ­£å¸¸

5. **Debug æ—¥å¿—**ï¼ˆå¦‚æžœå¯ç”¨ï¼‰ï¼š
   - ç‚¹å‡»è™šæ‹Ÿé…é€å™¨æ—¶åº”è¯¥çœ‹åˆ°ï¼š
     ```
     [Info] ðŸš« è·³è¿‡è™šæ‹Ÿé…é€å™¨ OnSetTarget (entityId=91, dispenserId=0)
     ```

## ä¸Žä¹‹å‰æ–¹æ¡ˆçš„å¯¹æ¯”

| æ–¹æ¡ˆ | ç­–ç•¥ | ä¼˜ç‚¹ | ç¼ºç‚¹ | ç»“æžœ |
|------|------|------|------|------|
| A. UI æ•°æ®æºè¿‡æ»¤ | Postfix ç§»é™¤ results | è™šæ‹Ÿé…é€å™¨å®Œå…¨éšè— | **åˆ—è¡¨ä¸åŒæ­¥å¯¼è‡´å´©æºƒ** | âŒ å¤±è´¥ |
| B. UI å®‰å…¨æ£€æŸ¥ (å½“å‰) | Prefix è·³è¿‡ OnSetTarget | ç®€å•å¯é ï¼Œä¸ä¿®æ”¹åˆ—è¡¨ | è™šæ‹Ÿé…é€å™¨å¯èƒ½æ˜¾ç¤ºä½†ä¸å¯ç‚¹å‡» | âœ… æˆåŠŸ |

## é¢„æœŸæ•ˆæžœ

- âœ… ç›‘æŽ§é¢æ¿æ­£å¸¸æ‰“å¼€ï¼Œæ— å´©æºƒ
- âœ… æ»šåŠ¨æ— å´©æºƒ
- âœ… çœŸå®žé…é€å™¨æ­£å¸¸æ˜¾ç¤ºå’Œæ“ä½œ
- âœ… è™šæ‹Ÿé…é€å™¨æ˜¾ç¤ºä½†ä¸å¯ç‚¹å‡»ï¼ˆå®‰å…¨æ— å®³ï¼‰
- âœ… é…é€åŠŸèƒ½æ­£å¸¸ï¼ˆè™šæ‹Ÿé…é€å™¨åœ¨åŽå°å·¥ä½œï¼‰
- âœ… æ— ä»»ä½• `NullReferenceException`

## æ€»ç»“

è¿™æ˜¯ä¸€ä¸ª**é˜²å¾¡æ€§ç¼–ç¨‹**ç­–ç•¥ï¼š
- ä¸å°è¯•å®Œç¾Žåœ°éšè—è™šæ‹Ÿé…é€å™¨ï¼ˆä¼šå¯¼è‡´å¤æ‚çš„åˆ—è¡¨åŒæ­¥é—®é¢˜ï¼‰
- è€Œæ˜¯åœ¨å¯èƒ½å‡ºé”™çš„åœ°æ–¹**å®‰å…¨åœ°æ‹¦æˆªå’Œè·³è¿‡**
- ä¿è¯ç³»ç»Ÿç¨³å®šæ€§ä¼˜å…ˆäºŽ UI å®Œç¾Žæ€§

**ç®€å• > å®Œç¾Ž**
