# playerPairCount vs pairCount è¯¦è§£

## ğŸ“Š åŸºæœ¬å®šä¹‰

```csharp
public class DispenserComponent
{
    public SupplyDemandPair[] pairs;       // é…å¯¹æ•°ç»„
    public int playerPairCount;            // "ç©å®¶é…å¯¹"çš„æ•°é‡
    public int pairCount;                  // æ‰€æœ‰é…å¯¹çš„æ€»æ•°é‡
}
```

---

## ğŸ”‘ å…³é”®ï¼šAddPair æ–¹æ³•

### æ¸¸æˆæºç 

```csharp
public void AddPair(int sId, int sIdx, int dId, int dIdx)
{
    // ç¡®ä¿æ•°ç»„å®¹é‡è¶³å¤Ÿ
    if (this.pairs == null)
    {
        this.SetPairCapacity(8);
    }
    if (this.pairCount == this.pairs.Length)
    {
        this.SetPairCapacity(this.pairs.Length * 2);
    }
    
    // æ·»åŠ é…å¯¹åˆ°æ•°ç»„
    this.pairs[this.pairCount].supplyId = sId;
    this.pairs[this.pairCount].supplyIndex = sIdx;
    this.pairs[this.pairCount].demandId = dId;
    this.pairs[this.pairCount].demandIndex = dIdx;
    
    // âœ… pairCount æ€»æ˜¯å¢åŠ 
    this.pairCount++;
    
    // â— åªæœ‰ sId < 0 æˆ– dId < 0 æ—¶æ‰å¢åŠ  playerPairCount
    if (sId < 0 || dId < 0)
    {
        this.playerPairCount++;
    }
}
```

---

## ğŸ¯ ä¸¤è€…çš„åŒºåˆ«

### pairCountï¼ˆæ‰€æœ‰é…å¯¹ï¼‰

**å®šä¹‰**ï¼šé…é€å™¨çš„**æ‰€æœ‰é…å¯¹**æ€»æ•°

**å¢åŠ æ—¶æœº**ï¼š
- âœ… æ¯æ¬¡è°ƒç”¨ `AddPair` éƒ½ä¼šå¢åŠ 
- âœ… æ— è®º ID æ˜¯æ­£æ•°è¿˜æ˜¯è´Ÿæ•°

**åŒ…å«çš„é…å¯¹ç±»å‹**ï¼š
1. ç©å®¶é…å¯¹ï¼ˆplayerPairCountï¼‰
2. å­˜å‚¨é…å¯¹ï¼ˆstorageMode ç›¸å…³ï¼‰
3. **æˆ‘ä»¬çš„è™šæ‹Ÿé…é€å™¨é…å¯¹**

**æ•°ç»„ä½ç½®**ï¼š
```
pairs[0] â† ç¬¬1ä¸ªé…å¯¹
pairs[1] â† ç¬¬2ä¸ªé…å¯¹
...
pairs[pairCount-1] â† æœ€åä¸€ä¸ªé…å¯¹
```

---

### playerPairCountï¼ˆç©å®¶é…å¯¹ï¼‰

**å®šä¹‰**ï¼šä½¿ç”¨**è´Ÿæ•°ID**çš„é…å¯¹æ•°é‡

**å¢åŠ æ—¶æœº**ï¼š
- âœ… åªåœ¨ `supplyId < 0` æˆ– `demandId < 0` æ—¶å¢åŠ 
- âŒ æ­£æ•°IDçš„é…å¯¹ä¸ä¼šå¢åŠ è¿™ä¸ªè®¡æ•°

**æ¸¸æˆè®¾è®¡æ„å›¾**ï¼ˆæ¨æµ‹ï¼‰ï¼š
- è´Ÿæ•°IDè¡¨ç¤º"ç‰¹æ®Šé…å¯¹"
- ä¾‹å¦‚ï¼šé…é€å™¨åˆ°ç©å®¶æœºç”²çš„é…å¯¹
- "player" æŒ‡çš„æ˜¯"ä¸ç©å®¶ç›¸å…³"ï¼Œè€Œä¸æ˜¯"é…é€å™¨åˆ°é…é€å™¨"

**æ•°ç»„ä½ç½®**ï¼š
```
pairs[0 ~ playerPairCount-1]  â† ç©å®¶é…å¯¹ï¼ˆè´Ÿæ•°IDï¼‰
pairs[playerPairCount ~ pairCount-1]  â† å…¶ä»–é…å¯¹ï¼ˆæ­£æ•°IDï¼‰
```

---

## ğŸ“‹ é…å¯¹çš„åˆ†ç±»

### æ ¹æ® ID ç±»å‹åˆ†ç±»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  pairs æ•°ç»„ï¼ˆæ€»é•¿åº¦ = pairCountï¼‰       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0: ç©å®¶é…å¯¹1 (supplyId < 0)            â”‚ â†â”
â”‚ 1: ç©å®¶é…å¯¹2 (demandId < 0)            â”‚  â”‚ playerPairCount
â”‚ ...                                     â”‚  â”‚
â”‚ playerPairCount-1: ç©å®¶é…å¯¹N           â”‚ â†â”˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ playerPairCount: å­˜å‚¨é…å¯¹1 (æ­£æ•°ID)    â”‚ â†â”
â”‚ playerPairCount+1: å­˜å‚¨é…å¯¹2           â”‚  â”‚ pairCount - playerPairCount
â”‚ ...                                     â”‚  â”‚
â”‚ pairCount-1: å­˜å‚¨é…å¯¹M                 â”‚ â†â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” æ¸¸æˆä¸­çš„ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå¤„ç†ç©å®¶é…å¯¹

```csharp
// OnRematchPairs æ–¹æ³•ï¼šé‡æ–°åŒ¹é…ç©å®¶é…å¯¹
if (this.pairProcess < this.playerPairCount)
{
    this.pairProcess = this.playerPairCount;
}

// åªéå†ç©å®¶é…å¯¹
for (int i = 0; i < this.playerPairCount; i++)
{
    ref SupplyDemandPair pair = ref this.pairs[i];
    // å¤„ç†ç©å®¶é…å¯¹é€»è¾‘
    // è¿™äº›é…å¯¹é€šå¸¸æ¶‰åŠåˆ°ç©å®¶èƒŒåŒ…ï¼ˆdeliveryPackageï¼‰
}
```

### åœºæ™¯2ï¼šå¤„ç†æ‰€æœ‰é…å¯¹

```csharp
// InternalTick æ–¹æ³•ï¼šå¤„ç†æ‰€æœ‰é…å¯¹
for (int i = 0; i < this.pairCount; i++)
{
    ref SupplyDemandPair pair = ref this.pairs[i];
    // å¤„ç†æ‰€æœ‰é…å¯¹çš„é€»è¾‘
}
```

### åœºæ™¯3ï¼šå¾ªç¯å¤„ç†é…å¯¹

```csharp
// å¤„ç†é…å¯¹çš„å¾ªç¯é€»è¾‘
if (this.pairProcess >= this.pairCount)
{
    this.pairProcess = this.playerPairCount;  // è·³å›åˆ°ç©å®¶é…å¯¹
}

// æ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨é…å¯¹éœ€è¦å¤„ç†
if (this.pairCount > this.playerPairCount)
{
    // æœ‰å­˜å‚¨é…å¯¹
    å¤„ç†å­˜å‚¨é…å¯¹();
}
```

---

## ğŸ’¡ ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„ Mod éœ€è¦ç‰¹åˆ«å¤„ç†

### æˆ‘ä»¬çš„è™šæ‹Ÿé…é€å™¨é…å¯¹

```csharp
è™šæ‹Ÿé…é€å™¨é…å¯¹ï¼š
  supplyId = 2    // âœ… æ­£æ•°ï¼ˆè™šæ‹Ÿé…é€å™¨IDï¼‰
  demandId = 1    // âœ… æ­£æ•°ï¼ˆéœ€æ±‚é…é€å™¨IDï¼‰

AddPair(2, gridIdx, 1, 0);

ç»“æœï¼š
  pairCount++         â†’ å¢åŠ  âœ…
  playerPairCount     â†’ ä¸å˜ âŒï¼ˆå› ä¸ºéƒ½æ˜¯æ­£æ•°ï¼‰
```

### å¯¼è‡´çš„é—®é¢˜

#### é—®é¢˜1ï¼šå¹‚ç­‰æ€§æ£€æŸ¥å¤±æ•ˆ

```csharp
// âŒ é”™è¯¯çš„ä»£ç 
for (int i = 0; i < playerPairCount; i++)  // playerPairCount = 0
{
    æ£€æŸ¥é…å¯¹æ˜¯å¦å·²å­˜åœ¨();
}
// æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Œæ°¸è¿œæ‰¾ä¸åˆ°å·²å­˜åœ¨çš„é…å¯¹

// âœ… æ­£ç¡®çš„ä»£ç 
for (int i = 0; i < pairCount; i++)  // pairCount = å®é™…é…å¯¹æ•°
{
    æ£€æŸ¥é…å¯¹æ˜¯å¦å·²å­˜åœ¨();
}
```

#### é—®é¢˜2ï¼šæ´¾é£é€»è¾‘å¤±æ•ˆ

```csharp
// âŒ é”™è¯¯çš„ä»£ç 
if (dispenser.playerPairCount > 0)  // playerPairCount = 0
{
    æ´¾é£æ— äººæœº();
}
// æ¡ä»¶æ°¸è¿œä¸æ»¡è¶³

// âœ… æ­£ç¡®çš„ä»£ç 
if (dispenser.pairCount > 0)  // pairCount > 0
{
    æ´¾é£æ— äººæœº();
}
```

---

## ğŸ® æ¸¸æˆä¸­çš„å®é™…ä¾‹å­

### ä¾‹å­1ï¼šé…é€å™¨åˆ°æœºç”²ï¼ˆç©å®¶é…å¯¹ï¼‰

```
åœºæ™¯ï¼šç©å®¶è®¾ç½®é…é€å™¨ç»™æœºç”²é…é€ç‰©å“

é…å¯¹ï¼š
  supplyId = -1     // è´Ÿæ•°ï¼ä»£è¡¨ç©å®¶èƒŒåŒ…
  supplyIndex = 0
  demandId = 1      // é…é€å™¨ID
  demandIndex = 0

AddPair(-1, 0, 1, 0);

ç»“æœï¼š
  pairCount++        â†’ å˜æˆ 1
  playerPairCount++  â†’ å˜æˆ 1 âœ…ï¼ˆå› ä¸º supplyId < 0ï¼‰
```

### ä¾‹å­2ï¼šé…é€å™¨åˆ°ç‰©æµç«™ï¼ˆå­˜å‚¨é…å¯¹ï¼‰

```
åœºæ™¯ï¼šé…é€å™¨è‡ªåŠ¨ä¸é™„è¿‘çš„ç‰©æµç«™å»ºç«‹é…å¯¹

é…å¯¹ï¼š
  supplyId = 5      // æ­£æ•°ï¼ç‰©æµç«™çš„é…é€å™¨ID
  supplyIndex = 0
  demandId = 1      // é…é€å™¨ID
  demandIndex = 0

AddPair(5, 0, 1, 0);

ç»“æœï¼š
  pairCount++        â†’ å˜æˆ 1
  playerPairCount    â†’ ä¸å˜ âŒï¼ˆå› ä¸ºéƒ½æ˜¯æ­£æ•°ï¼‰
```

### ä¾‹å­3ï¼šæˆ‘ä»¬çš„è™šæ‹Ÿé…é€å™¨ï¼ˆå­˜å‚¨é…å¯¹ï¼‰

```
åœºæ™¯ï¼šæˆ˜åœºåŸºç«™çš„è™šæ‹Ÿé…é€å™¨ä¸éœ€æ±‚é…é€å™¨é…å¯¹

é…å¯¹ï¼š
  supplyId = 2      // æ­£æ•°ï¼è™šæ‹Ÿé…é€å™¨ID
  supplyIndex = 0
  demandId = 1      // é…é€å™¨ID
  demandIndex = 0

AddPair(2, 0, 1, 0);

ç»“æœï¼š
  pairCount++        â†’ å˜æˆ 1
  playerPairCount    â†’ ä¸å˜ âŒï¼ˆå› ä¸ºéƒ½æ˜¯æ­£æ•°ï¼‰
  
ç±»å‹ï¼šå­˜å‚¨é…å¯¹ï¼ˆä¸ä¾‹å­2ç›¸åŒï¼‰
```

---

## ğŸ“Š å¯¹æ¯”è¡¨æ ¼

| ç‰¹æ€§ | pairCount | playerPairCount |
|------|-----------|-----------------|
| **å«ä¹‰** | æ‰€æœ‰é…å¯¹æ€»æ•° | ä½¿ç”¨è´Ÿæ•°IDçš„é…å¯¹æ•° |
| **å¢åŠ æ¡ä»¶** | æ¯æ¬¡ AddPair | åªåœ¨ sId<0 æˆ– dId<0 æ—¶ |
| **åŒ…å«èŒƒå›´** | pairs[0 ~ pairCount-1] | pairs[0 ~ playerPairCount-1] |
| **æˆ‘ä»¬çš„é…å¯¹** | âœ… åŒ…å« | âŒ ä¸åŒ…å« |
| **éå†æ—¶ä½¿ç”¨** | å¤„ç†æ‰€æœ‰é…å¯¹ | åªå¤„ç†ç©å®¶é…å¯¹ |

---

## ğŸ”‘ å…³é”®ç†è§£

### playerPairCount ä¸æ˜¯"é…é€å™¨åˆ°é…é€å™¨"

**å¸¸è§è¯¯è§£**ï¼š
- âŒ "player" = ç©å®¶æ‰‹åŠ¨è®¾ç½®
- âŒ "player" = é…é€å™¨åˆ°é…é€å™¨

**å®é™…å«ä¹‰**ï¼š
- âœ… "player" = ä¸ç©å®¶èƒŒåŒ…ç›¸å…³
- âœ… "player" = ä½¿ç”¨è´Ÿæ•°IDæ ‡è¯†

### è´Ÿæ•°IDçš„ç‰¹æ®Šå«ä¹‰

```
è´Ÿæ•°IDåœ¨æ¸¸æˆä¸­çš„ç”¨é€”ï¼š
  -1  â†’ ç©å®¶èƒŒåŒ…ï¼ˆdeliveryPackageï¼‰
  -2  â†’ å…¶ä»–ç‰¹æ®Šå®ä½“ï¼Ÿ
  
æ­£æ•°IDï¼š
  1, 2, 3, ... â†’ é…é€å™¨ã€ç‰©æµç«™ç­‰å®ä½“çš„æ­£å¸¸ID
```

---

## âœ… æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆ

### ä¸ºä»€ä¹ˆä½¿ç”¨ pairCount

1. **è™šæ‹Ÿé…é€å™¨ä½¿ç”¨æ­£æ•°ID**
   - é¿å…æ•°ç»„è¶Šç•Œ
   - ä¸éœ€è¦ Patch è¿‡å¤šåœ°æ–¹

2. **é…å¯¹è¢«å½’ç±»ä¸º"å­˜å‚¨é…å¯¹"**
   - ä¸è®¡å…¥ playerPairCount
   - è®¡å…¥ pairCount

3. **å¿…é¡»ä½¿ç”¨ pairCount æ¥æ£€æµ‹å’Œéå†**
   - å¹‚ç­‰æ€§æ£€æŸ¥ï¼šéå† pairCount ä¸ªé…å¯¹
   - æ´¾é£é€»è¾‘ï¼šæ£€æŸ¥ pairCount > 0

### ä»£ç ç¤ºä¾‹

```csharp
// âœ… æ­£ç¡®çš„å¹‚ç­‰æ€§æ£€æŸ¥
for (int i = 0; i < existingPairCount; i++)  // ä½¿ç”¨ pairCount
{
    var pair = existingPairs[i];
    if (pair.supplyId == virtualDispenserId && 
        pair.demandId == dispenserId)
    {
        alreadyExists = true;  // æ‰¾åˆ°äº†ï¼
        break;
    }
}

// âœ… æ­£ç¡®çš„æ´¾é£é€»è¾‘
if (dispenser.idleCourierCount > 0 && dispenser.pairCount > 0)  // æ£€æŸ¥ pairCount
{
    for (int i = 0; i < dispenser.pairCount; i++)  // éå† pairCount
    {
        var pair = dispenser.pairs[i];
        if (VirtualDispenserManager.IsVirtualDispenser(pair.supplyId))
        {
            DispatchCourier();  // æ´¾é£ï¼
            break;
        }
    }
}
```

---

## ğŸ¯ æ€»ç»“

### pairCountï¼ˆæ‰€æœ‰é…å¯¹ï¼‰
- åŒ…å«æ‰€æœ‰é…å¯¹
- æ¯æ¬¡ AddPair éƒ½å¢åŠ 
- æˆ‘ä»¬çš„è™šæ‹Ÿé…é€å™¨é…å¯¹åœ¨è¿™é‡Œ âœ…

### playerPairCountï¼ˆç©å®¶é…å¯¹ï¼‰
- åªåŒ…å«è´Ÿæ•°IDçš„é…å¯¹
- åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹å¢åŠ 
- æˆ‘ä»¬çš„è™šæ‹Ÿé…é€å™¨é…å¯¹ä¸åœ¨è¿™é‡Œ âŒ

### æ ¸å¿ƒæ•™è®­
**ä¸è¦è¢«åå­—è¯¯å¯¼ï¼**
- "player" ä¸æ˜¯æŒ‡"ç©å®¶æ‰‹åŠ¨è®¾ç½®"
- "player" æ˜¯æŒ‡"ä½¿ç”¨è´Ÿæ•°IDçš„ç‰¹æ®Šé…å¯¹"
- å¿…é¡»æŸ¥çœ‹ä»£ç å®ç°æ‰èƒ½ç¡®å®šçœŸå®å«ä¹‰

---

## ğŸ“ è¯Šæ–­æŠ€å·§

æŸ¥çœ‹æ—¥å¿—æ—¶ï¼ŒåŒæ—¶æ˜¾ç¤ºä¸¤ä¸ªå­—æ®µï¼š

```log
ğŸ” é…é€å™¨[1] çŠ¶æ€: pairCount=1 (playerPairCount=0)
```

**è§£è¯»**ï¼š
- `pairCount=1`ï¼šæœ‰1ä¸ªé…å¯¹ï¼ˆå¯èƒ½æ˜¯æˆ‘ä»¬çš„è™šæ‹Ÿé…é€å™¨ï¼‰
- `playerPairCount=0`ï¼šæ²¡æœ‰ç©å®¶é…å¯¹ï¼ˆæ²¡æœ‰è´Ÿæ•°IDé…å¯¹ï¼‰
- ç»“è®ºï¼šè¿™1ä¸ªé…å¯¹æ˜¯æ­£æ•°IDé…å¯¹ï¼Œéœ€è¦éå† pairCount æ‰èƒ½æ‰¾åˆ°ï¼
