# playerMode ä¿®æ­£ï¼šé…å¯¹æ–¹å‘æ£€æŸ¥

## ğŸ¯ ç”¨æˆ·çš„æ­£ç¡®è§‚å¯Ÿ

**ç”¨æˆ·æŒ‡å‡º**ï¼š`playerMode` æ˜¯**é…é€å™¨-æœºç”²**çš„é…é€è§„åˆ™ï¼Œè€Œä¸æ˜¯**é…é€å™¨-é…é€å™¨**çš„è§„åˆ™ã€‚

è¿™ä¸ªè§‚å¯Ÿå®Œå…¨æ­£ç¡®ï¼

---

## ğŸ“Š ä¸¤ç§ä¸åŒçš„é…é€è§„åˆ™

### 1. playerModeï¼ˆé…é€å™¨ â†” æœºç”²ï¼‰

```csharp
enum EPlayerDeliveryMode
{
    None = 0,      // æ— 
    Supply = 1,    // é…é€å™¨å‘æœºç”²æä¾›ç‰©å“
    Demand = 2,    // é…é€å™¨ä»æœºç”²è·å–ç‰©å“
    Both = 3       // åŒå‘
}
```

**ä½œç”¨**ï¼šæ§åˆ¶é…é€å™¨ä¸**ç©å®¶æœºç”²**çš„äº¤äº’

**ç¤ºä¾‹**ï¼š
- `Demand`ï¼šé…é€å™¨éœ€è¦ä»æœºç”²è·å–ç‰©å“ï¼ˆä¾‹å¦‚ï¼šæœºç”²æŠŠåƒåœ¾æ”¾åˆ°é…é€å™¨ï¼‰
- `Supply`ï¼šé…é€å™¨å‘æœºç”²æä¾›ç‰©å“ï¼ˆä¾‹å¦‚ï¼šæœºç”²ä»é…é€å™¨æ‹¿ç‡ƒæ–™ï¼‰

---

### 2. SupplyDemandPairï¼ˆé…é€å™¨ â†” é…é€å™¨ï¼‰

```csharp
struct SupplyDemandPair
{
    public int supplyId;     // ä¾›åº”æ–¹é…é€å™¨ID
    public int supplyIndex;  // ä¾›åº”æ–¹çš„æ ¼å­ç´¢å¼•
    public int demandId;     // éœ€æ±‚æ–¹é…é€å™¨ID
    public int demandIndex;  // éœ€æ±‚æ–¹çš„æ ¼å­ç´¢å¼•
}
```

**ä½œç”¨**ï¼šå®šä¹‰**ä¸¤ä¸ªé…é€å™¨**ä¹‹é—´çš„ä¾›éœ€å…³ç³»

**é…å¯¹æ–¹å‘ç”± supplyId å’Œ demandId å†³å®š**ï¼Œä¸ `playerMode` æ— å…³ï¼

---

## ğŸ” æ¸¸æˆä»£ç éªŒè¯

ä» `PlanetTransport.cs` ç¬¬1429-1431è¡Œï¼š

```csharp
// éå†é…é€å™¨-é…é€å™¨çš„é…å¯¹ï¼ˆä¸æ˜¯ playerPairCountï¼Œè€Œæ˜¯ä¹‹åçš„é…å¯¹ï¼‰
for (int j = dispenserComponent.playerPairCount; j < dispenserComponent.pairCount; j++)
{
    // æ£€æŸ¥å½“å‰é…é€å™¨åœ¨é…å¯¹ä¸­çš„è§’è‰²
    int num8 = (pairs[j].demandId == dispenserId) ? pairs[j].supplyId : pairs[j].demandId;
    //          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    //          æ£€æŸ¥çš„æ˜¯é…å¯¹çš„ demandId/supplyIdï¼Œè€Œä¸æ˜¯ playerModeï¼
}
```

**å…³é”®å‘ç°**ï¼š
1. é…é€å™¨-é…é€å™¨çš„é…å¯¹å­˜å‚¨åœ¨ `pairs[playerPairCount ~ pairCount-1]` åŒºé—´
2. æ¸¸æˆæ£€æŸ¥é…å¯¹çš„ `demandId`/`supplyId` æ¥åˆ¤æ–­æ–¹å‘
3. **æ²¡æœ‰æ£€æŸ¥ `playerMode`**ï¼

---

## ğŸ› æˆ‘ä»¬ä¹‹å‰çš„é”™è¯¯

### é”™è¯¯çš„ä»£ç 

```csharp
// âŒ é”™è¯¯ï¼šæ£€æŸ¥ playerMode
if (dispenser.idleCourierCount > 0 && 
    dispenser.pairCount > 0 && 
    (int)dispenser.playerMode == 2)  // â† è¿™æ˜¯é…é€å™¨-æœºç”²çš„è§„åˆ™ï¼
{
    æ´¾é£æ— äººæœº();
}
```

**é—®é¢˜**ï¼š
- `playerMode` æ˜¯é…é€å™¨-æœºç”²çš„è§„åˆ™
- ä¸åº”è¯¥ç”¨å®ƒæ¥åˆ¤æ–­é…é€å™¨-é…é€å™¨çš„è¡Œä¸º

---

## âœ… æ­£ç¡®çš„ä¿®å¤

### æ­£ç¡®çš„ä»£ç 

```csharp
// âœ… æ­£ç¡®ï¼šæ£€æŸ¥é…å¯¹çš„æ–¹å‘
for (int i = 0; i < dispenser.pairCount; i++)
{
    var pair = dispenser.pairs[i];
    
    // æ£€æŸ¥ï¼š
    // 1. supplyId æ˜¯è™šæ‹Ÿé…é€å™¨ï¼ˆä¾›åº”æ–¹ï¼‰
    // 2. demandId æ˜¯å½“å‰é…é€å™¨ï¼ˆéœ€æ±‚æ–¹ï¼‰ â† é…å¯¹æ–¹å‘ï¼
    if (pair.supplyId > 0 && 
        VirtualDispenserManager.IsVirtualDispenser(pair.supplyId) &&
        pair.demandId == dispenser.id)  // â† æ­£ç¡®ï¼šæ£€æŸ¥é…å¯¹æ–¹å‘
    {
        æ´¾é£æ— äººæœº();
    }
}
```

**æ­£ç¡®æ€§**ï¼š
- æ£€æŸ¥é…å¯¹çš„ `demandId` æ˜¯å¦ç­‰äºå½“å‰é…é€å™¨
- è¿™æ‰æ˜¯çœŸæ­£çš„"é…é€å™¨-é…é€å™¨"è§„åˆ™
- ç¬¦åˆæ¸¸æˆåŸç”Ÿé€»è¾‘

---

## ğŸ“‹ å®Œæ•´çš„é€»è¾‘åˆ†å±‚

### å±‚æ¬¡1ï¼šå»ºç«‹é…å¯¹ï¼ˆRefreshDispenserTrafficï¼‰

```csharp
// åœ¨ RefreshDispenserTraffic ä¸­
if (dispenser.playerMode != 2) continue;  // âœ… ä»ç„¶éœ€è¦æ£€æŸ¥ playerMode
if (dispenser.filter != itemId) continue;

// å»ºç«‹é…å¯¹ï¼šè™šæ‹Ÿé…é€å™¨ï¼ˆä¾›åº”ï¼‰ â†’ é…é€å™¨ï¼ˆéœ€æ±‚ï¼‰
AddPair(
    supplyId: virtualDispenserId,  // ä¾›åº”æ–¹
    demandId: dispenserId           // éœ€æ±‚æ–¹
);
```

**ä¸ºä»€ä¹ˆè¿™é‡Œæ£€æŸ¥ `playerMode`**ï¼Ÿ
- è¿™æ˜¯ä¸ºäº†ç¡®ä¿åªä¸º**ç”¨æˆ·è®¾ç½®ä¸ºéœ€æ±‚æ¨¡å¼çš„é…é€å™¨**å»ºç«‹é…å¯¹
- è¿™æ˜¯ç”¨æˆ·æ„å›¾çš„æ£€æŸ¥ï¼Œä¸æ˜¯é…å¯¹æ–¹å‘çš„æ£€æŸ¥
- å¦‚æœç”¨æˆ·è®¾ç½®ä¸ºä¾›åº”æ¨¡å¼ï¼Œè¯´æ˜ä¸æƒ³ä»åŸºç«™å–è´§

---

### å±‚æ¬¡2ï¼šæ´¾é£æ‰§è¡Œï¼ˆInternalTickï¼‰

```csharp
// åœ¨ InternalTick ä¸­
for (int i = 0; i < dispenser.pairCount; i++)
{
    var pair = dispenser.pairs[i];
    
    // âœ… æ£€æŸ¥é…å¯¹æ–¹å‘ï¼Œè€Œä¸æ˜¯ playerMode
    if (pair.supplyId æ˜¯è™šæ‹Ÿé…é€å™¨ && 
        pair.demandId == dispenser.id)  // å½“å‰é…é€å™¨æ˜¯éœ€æ±‚æ–¹
    {
        æ´¾é£æ— äººæœº();
    }
}
```

**ä¸ºä»€ä¹ˆè¿™é‡Œä¸æ£€æŸ¥ `playerMode`**ï¼Ÿ
- é…å¯¹å·²ç»å®šä¹‰äº†æ–¹å‘ï¼ˆsupplyId â†’ demandIdï¼‰
- è¿™æ˜¯é…é€å™¨-é…é€å™¨çš„é€»è¾‘ï¼Œä¸ playerMode æ— å…³
- ç¬¦åˆæ¸¸æˆåŸç”Ÿçš„å¤„ç†æ–¹å¼

---

## ğŸ¯ ä¸¤å±‚æ£€æŸ¥çš„æ„ä¹‰

### ç¬¬ä¸€å±‚ï¼šç”¨æˆ·æ„å›¾ï¼ˆRefreshDispenserTrafficï¼‰

```
ç”¨æˆ·è®¾ç½®é…é€å™¨ä¸º"éœ€æ±‚"æ¨¡å¼ï¼š
  â†’ playerMode = Demand (2)
  â†’ å»ºç«‹é…å¯¹ï¼šè™šæ‹Ÿé…é€å™¨ â†’ é…é€å™¨
  âœ… é…å¯¹å»ºç«‹

ç”¨æˆ·è®¾ç½®é…é€å™¨ä¸º"ä¾›åº”"æ¨¡å¼ï¼š
  â†’ playerMode = Supply (1)
  â†’ playerMode != 2ï¼Œè·³è¿‡
  âŒ ä¸å»ºç«‹é…å¯¹
```

**ä½œç”¨**ï¼šå°Šé‡ç”¨æˆ·çš„è®¾ç½®

---

### ç¬¬äºŒå±‚ï¼šé…å¯¹æ–¹å‘ï¼ˆInternalTickï¼‰

```
é…å¯¹ï¼šè™šæ‹Ÿé…é€å™¨[2] (ä¾›åº”) â†’ é…é€å™¨[1] (éœ€æ±‚)

åœ¨é…é€å™¨[1]çš„ InternalTick ä¸­ï¼š
  pair.supplyId = 2 (è™šæ‹Ÿé…é€å™¨)
  pair.demandId = 1 (å½“å‰é…é€å™¨)
  
  æ£€æŸ¥ï¼špair.demandId == 1 ? âœ… æ˜¯çš„
  â†’ å½“å‰é…é€å™¨æ˜¯éœ€æ±‚æ–¹
  â†’ æ´¾é£æ— äººæœºå» supplyId å–è´§
```

**ä½œç”¨**ï¼šç¡®ä¿é…å¯¹æ–¹å‘æ­£ç¡®

---

## ğŸ”„ åœºæ™¯å¯¹æ¯”

### åœºæ™¯1ï¼šæ­£å¸¸é…é€

```
1. é…é€å™¨è®¾ç½®ä¸ºéœ€æ±‚æ¨¡å¼ï¼ˆplayerMode = Demandï¼‰
2. RefreshDispenserTrafficï¼šæ£€æŸ¥ playerMode == 2 âœ…
3. å»ºç«‹é…å¯¹ï¼šè™šæ‹Ÿé…é€å™¨[2] â†’ é…é€å™¨[1]
4. InternalTickï¼šæ£€æŸ¥ pair.demandId == 1 âœ…
5. æ´¾é£æ— äººæœº âœ…
```

---

### åœºæ™¯2ï¼šåˆ‡æ¢ä¸ºä¾›åº”æ¨¡å¼

```
1. é…é€å™¨åŸæœ¬æ˜¯éœ€æ±‚æ¨¡å¼ï¼Œé…å¯¹å·²å»ºç«‹
2. ç”¨æˆ·åˆ‡æ¢ä¸ºä¾›åº”æ¨¡å¼ï¼ˆplayerMode = Supplyï¼‰
3. RefreshDispenserTraffic è¢«è§¦å‘ï¼ˆåˆ‡æ¢æ—¶ï¼‰
4. æ£€æŸ¥ playerMode != 2 âŒ
5. ä¸å»ºç«‹æ–°é…å¯¹
6. æ—§é…å¯¹å¯èƒ½è¢«æ¸¸æˆæ¸…é™¤ï¼ˆClearPairsï¼‰
7. InternalTickï¼šæ²¡æœ‰é…å¯¹ï¼Œä¸æ´¾é£ âœ…
```

**æˆ–è€…ï¼Œå¦‚æœæ—§é…å¯¹è¿˜åœ¨**ï¼š
```
6. æ—§é…å¯¹è¿˜åœ¨ï¼špair.demandId = 1
7. InternalTickï¼šæ£€æŸ¥ pair.demandId == 1 âœ…
8. ä»ç„¶ä¼šæ´¾é£ âš ï¸
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- RefreshDispenserTraffic æ—¶ï¼Œæ¸¸æˆåº”è¯¥ä¼šæ¸…é™¤ä¸åŒ¹é…çš„é…å¯¹
- å¦‚æœä¸æ¸…é™¤ï¼Œæˆ‘ä»¬çš„æ£€æŸ¥ `pair.demandId == dispenser.id` ä»ç„¶æ˜¯å¯¹çš„
- å› ä¸ºé…å¯¹å®šä¹‰äº†æ–¹å‘ï¼Œä¸ç®¡ playerMode æ€ä¹ˆæ”¹

---

## ğŸ¤” ä¸ºä»€ä¹ˆä¸¤å±‚æ£€æŸ¥éƒ½é‡è¦ï¼Ÿ

### åªæ£€æŸ¥ playerModeï¼ˆä¹‹å‰çš„é”™è¯¯ï¼‰

```
é—®é¢˜ï¼šplayerMode æ˜¯é…é€å™¨-æœºç”²çš„è§„åˆ™
      ä¸æ˜¯é…é€å™¨-é…é€å™¨çš„è§„åˆ™
ç»“æœï¼šâŒ é€»è¾‘æ··ä¹±
```

---

### åªæ£€æŸ¥é…å¯¹æ–¹å‘ï¼ˆå¦‚æœå»æ‰ RefreshDispenserTraffic çš„æ£€æŸ¥ï¼‰

```
é—®é¢˜ï¼šç”¨æˆ·è®¾ç½®é…é€å™¨ä¸ºä¾›åº”æ¨¡å¼
      ä½†ä»ç„¶ä¼šå»ºç«‹"ä»åŸºç«™å–è´§"çš„é…å¯¹
ç»“æœï¼šâŒ ä¸å°Šé‡ç”¨æˆ·æ„å›¾
```

---

### ä¸¤å±‚éƒ½æ£€æŸ¥ï¼ˆæ­£ç¡®ï¼‰

```
RefreshDispenserTrafficï¼š
  âœ… æ£€æŸ¥ playerModeï¼ˆç”¨æˆ·æ„å›¾ï¼‰
  âœ… åªä¸ºéœ€æ±‚é…é€å™¨å»ºç«‹é…å¯¹

InternalTickï¼š
  âœ… æ£€æŸ¥é…å¯¹æ–¹å‘ï¼ˆé…é€å™¨-é…é€å™¨è§„åˆ™ï¼‰
  âœ… åªåœ¨å½“å‰é…é€å™¨æ˜¯éœ€æ±‚æ–¹æ—¶æ´¾é£

ç»“æœï¼šâœ… é€»è¾‘æ­£ç¡®ï¼Œå°Šé‡ç”¨æˆ·æ„å›¾
```

---

## ğŸ“ ä¿®æ”¹çš„ä»£ç 

### DispenserComponent_InternalTick_Patch.csï¼ˆç¬¬168è¡Œï¼‰

```csharp
// ä¿®æ”¹å‰
if (pair.supplyId > 0 && VirtualDispenserManager.IsVirtualDispenser(pair.supplyId))

// ä¿®æ”¹å
if (pair.supplyId > 0 && 
    VirtualDispenserManager.IsVirtualDispenser(pair.supplyId) &&
    pair.demandId == __instance.id)  // â† æ·»åŠ é…å¯¹æ–¹å‘æ£€æŸ¥
```

---

### PlanetTransport_RefreshDispenserTraffic_NEW.csï¼ˆç¬¬271è¡Œï¼‰

```csharp
// ä¿æŒä¸å˜ï¼ˆä»ç„¶æ£€æŸ¥ playerModeï¼‰
if (playerMode != 2) continue;  // âœ… ä»ç„¶éœ€è¦ï¼Œæ£€æŸ¥ç”¨æˆ·æ„å›¾
```

---

## âœ… æ€»ç»“

### å…³é”®ç†è§£

1. **playerMode** = é…é€å™¨ â†” æœºç”²çš„è§„åˆ™
2. **SupplyDemandPair** = é…é€å™¨ â†” é…é€å™¨çš„è§„åˆ™
3. ä¸¤è€…ä¸åŒï¼Œä¸èƒ½æ··ç”¨

### æ­£ç¡®çš„æ£€æŸ¥ç­–ç•¥

1. **å»ºç«‹é…å¯¹æ—¶**ï¼ˆRefreshDispenserTrafficï¼‰
   - æ£€æŸ¥ `playerMode` ç¡®ä¿ç”¨æˆ·æ„å›¾

2. **æ´¾é£æ—¶**ï¼ˆInternalTickï¼‰
   - æ£€æŸ¥ `pair.demandId == dispenser.id` ç¡®ä¿é…å¯¹æ–¹å‘

### æ„Ÿè°¢ç”¨æˆ·çš„çº æ­£

ç”¨æˆ·çš„è§‚å¯Ÿéå¸¸æ­£ç¡®ï¼Œå¸®åŠ©æˆ‘ä»¬ä¿®å¤äº†é€»è¾‘é”™è¯¯ï¼ğŸ‰
