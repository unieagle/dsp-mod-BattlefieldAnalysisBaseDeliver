# CourierData 行为研究

## 测试结果总结

| 测试# | begin | end | direction | t | endId | 结果 |
|------|-------|-----|-----------|---|-------|------|
| 1 | basePos | dispenserPos | 1f | 0 | -10000 | 从基站起飞 → 机甲 |
| 2 | dispenserPos | basePos | 1f | 0 | -10000 | 从配送器起飞 → 机甲 |
| 3 | basePos | dispenserPos | -1f | 0 | -10000 | 从配送器起飞 → 基站（正确！但后来改了）|
| 4 | dispenserPos | basePos | -1f | 0 | -10000 | 无动作，courier被立即回收 |

## 关键代码逻辑

### 1. t 的更新（InternalTick line 919）
```csharp
t = t + num32 * direction
```
- `direction = 1f`: t 从 0 增加到 maxt（正向飞行）
- `direction = -1f`: t 从 maxt 减少到 0（反向飞行/返回）

### 2. 跟踪玩家逻辑（InternalTick line 856）
```csharp
if (endId < 0 && direction > 0f) {
    // 动态更新 end = playerPos（每帧跟踪机甲位置）
}
```

### 3. 到达终点（InternalTick line 921-1100）
```csharp
if (t >= maxt) {
    // 无人机到达，卸货
}
else if (t <= 0f) {
    // 无人机返回配送器，卸货并回收
}
```

## 问题分析

### 问题1: 为什么 direction=-1f 时无人机立即消失？
- direction = -1f 时，t 从 0 开始递减变成负数
- t <= 0 触发"返回配送器"逻辑
- 因为 itemCount=0（空载），courier被立即回收

### 问题2: 为什么 direction=1f 时无人机飞向机甲？
- endId < 0 且 direction > 0 触发"跟踪玩家"逻辑
- 游戏每帧强制更新 end = playerPos
- 无人机目标被改为机甲位置

### 问题3: 矛盾
- 需要 direction=1f 让 t 从 0 增加（飞出去）
- 但 direction=1f + endId<0 会触发跟踪玩家
- direction=-1f 避免跟踪玩家，但 t 会变负数导致立即回收

## 可能的解决方案

### 方案A: 使用正数 endId
- 不使用负数 endId，避免触发特殊逻辑
- 问题：游戏可能会尝试访问 dispenserPool[endId]，导致越界或错误

### 方案B: 从 t=maxt 开始，direction=-1f
- 让无人机"看起来"是在返回
- begin=dispenserPos, end=basePos, t=maxt, direction=-1f
- t 会从 maxt 减少到 0，视觉上是从 dispenserPos → basePos

### 方案C: Patch 跟踪玩家逻辑
- 使用 Harmony Prefix 拦截 InternalTick
- 检测到我们的特殊 endId 时，跳过"跟踪玩家"逻辑

### 方案D: 使用极大的 endId
- 尝试 endId = int.MaxValue 或其他超出游戏范围的正数
- 避免负数的特殊逻辑

## 下一步行动
需要测试方案B：从 t=maxt 开始，让无人机"返回"到基站
