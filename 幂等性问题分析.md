# å¹‚ç­‰æ€§é—®é¢˜åˆ†æ

## ğŸ› é—®é¢˜æ ¹æº

### æ¸¸æˆåŸå§‹çš„ AddPair é€»è¾‘

```csharp
public void AddPair(int sId, int sIdx, int dId, int dIdx)
{
    // ... æ·»åŠ åˆ° pairs[pairCount] ...
    this.pairCount++;
    
    // âŒ å…³é”®é—®é¢˜ï¼šåªæœ‰è´Ÿæ•°IDæ‰å¢åŠ  playerPairCountï¼
    if (sId < 0 || dId < 0)
    {
        this.playerPairCount++;
    }
}
```

### æˆ‘ä»¬çš„è™šæ‹Ÿé…é€å™¨

```csharp
virtualDispenserId = 2;  // âœ… æ­£æ•°ID
dispenserId = 1;         // âœ… æ­£æ•°ID

AddPair(
    sId: 2,   // æ­£æ•°ï¼Œè™šæ‹Ÿé…é€å™¨
    dId: 1    // æ­£æ•°ï¼Œéœ€æ±‚é…é€å™¨
);
```

### å¯¼è‡´çš„é—®é¢˜

```
ç¬¬1æ¬¡è°ƒç”¨ RefreshDispenserTrafficï¼š
  - AddPair(2, ..., 1, ...)
  - pairCount++ â†’ å˜æˆ 1
  - playerPairCount ä¸å˜ï¼Œè¿˜æ˜¯ 0ï¼ˆå› ä¸ºéƒ½æ˜¯æ­£æ•°IDï¼‰
  - pairs[0] = {supplyId: 2, demandId: 1}

ç¬¬2æ¬¡è°ƒç”¨ RefreshDispenserTrafficï¼š
  - å¹‚ç­‰æ€§æ£€æŸ¥ï¼šéå† playerPairCount (=0) ä¸ªé…å¯¹
  - æ²¡æœ‰éå†åˆ°ä»»ä½•é…å¯¹ï¼ˆå› ä¸º playerPairCount=0ï¼‰
  - è®¤ä¸ºé…å¯¹ä¸å­˜åœ¨ï¼
  - å†æ¬¡ AddPair(2, ..., 1, ...)
  - pairCount++ â†’ å˜æˆ 2
  - pairs[1] = {supplyId: 2, demandId: 1}  â† é‡å¤äº†ï¼

... é‡å¤5æ¬¡ ...
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨ pairCount è€Œä¸æ˜¯ playerPairCount

```csharp
// éå†æ‰€æœ‰é…å¯¹ï¼Œè€Œä¸åªæ˜¯ playerPairCount
for (int pairIdx = 0; pairIdx < pairCount && pairIdx < existingPairs.Length; pairIdx++)
{
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
}
```

**ä¼˜ç‚¹**ï¼š
- ç®€å•ç›´æ¥
- èƒ½æ­£ç¡®æ£€æµ‹åˆ°æ‰€æœ‰é…å¯¹

**ç¼ºç‚¹**ï¼š
- å¯èƒ½éå†åˆ°å­˜å‚¨é…å¯¹ï¼ˆä½†æˆ‘ä»¬åªå…³å¿ƒé…é€å™¨é…å¯¹ï¼Œå¯ä»¥é€šè¿‡æ£€æŸ¥ supplyId > 0 è¿‡æ»¤ï¼‰

---

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨è´Ÿæ•°IDï¼ˆä½†è¿™ä¼šå¯¼è‡´å…¶ä»–é—®é¢˜ï¼‰

```csharp
// âŒ ä¸æ¨èï¼šå›åˆ°è´Ÿæ•°IDä¼šå¯¼è‡´æ•°ç»„è¶Šç•Œ
virtualDispenserId = -battleBaseId;
```

**ç¼ºç‚¹**ï¼š
- ä¼šå¯¼è‡´ `dispenserPool[virtualDispenserId]` æ•°ç»„è¶Šç•Œ
- éœ€è¦ Patch æ›´å¤šåœ°æ–¹
- è¿™å°±æ˜¯æˆ‘ä»¬ä¹‹å‰é‡åˆ°çš„é—®é¢˜

---

### æ–¹æ¡ˆ3ï¼šå¼ºåˆ¶å¢åŠ  playerPairCountï¼ˆä¸æ¨èï¼‰

```csharp
// æ‰‹åŠ¨å¢åŠ  playerPairCount
var playerPairCountField = dispenser.GetType().GetField("playerPairCount");
playerPairCountField.SetValue(dispenser, existingPlayerPairCount + 1);
```

**ç¼ºç‚¹**ï¼š
- ç ´åäº†æ¸¸æˆçš„å†…éƒ¨é€»è¾‘
- å¯èƒ½å¯¼è‡´å…¶ä»–é—®é¢˜

---

## ğŸ¯ æ¨èæ–¹æ¡ˆï¼šä½¿ç”¨ pairCount

ä¿®æ”¹å¹‚ç­‰æ€§æ£€æŸ¥ï¼Œä½¿ç”¨ `pairCount` è€Œä¸æ˜¯ `playerPairCount`ï¼š

```csharp
// è·å– pairCountï¼ˆæ‰€æœ‰é…å¯¹ï¼‰
var pairCountField = dispenser.GetType().GetField("pairCount");
int existingPairCount = (int)pairCountField.GetValue(dispenser)!;

// éå†æ‰€æœ‰é…å¯¹
for (int pairIdx = 0; pairIdx < existingPairCount && pairIdx < existingPairs.Length; pairIdx++)
{
    var pair = existingPairs.GetValue(pairIdx);
    // æ£€æŸ¥æ˜¯å¦æ˜¯æˆ‘ä»¬çš„é…å¯¹ï¼ˆsupplyId = virtualDispenserIdï¼‰
}
```

---

## ğŸ“Š é…å¯¹ç±»å‹åˆ†ç±»

æ¸¸æˆä¸­æœ‰ä¸¤ç§é…å¯¹ï¼š

### 1. é…é€å™¨åˆ°é…é€å™¨ï¼ˆplayerPairCountï¼‰

**æ¸¸æˆåŸå§‹é€»è¾‘**ï¼š
- supplyId < 0 æˆ– demandId < 0
- è®¡å…¥ `playerPairCount`
- ç”¨äºç©å®¶æ‰‹åŠ¨è®¾ç½®çš„é…å¯¹

**æˆ‘ä»¬çš„é…å¯¹**ï¼š
- supplyId = 2 (è™šæ‹Ÿé…é€å™¨ï¼Œæ­£æ•°)
- demandId = 1 (éœ€æ±‚é…é€å™¨ï¼Œæ­£æ•°)
- âŒ ä¸è®¡å…¥ `playerPairCount`ï¼ˆè¿™æ˜¯é—®é¢˜æ‰€åœ¨ï¼ï¼‰

### 2. é…é€å™¨åˆ°å­˜å‚¨ï¼ˆå…¶ä»–é…å¯¹ï¼‰

- supplyId > 0 ä¸” demandId > 0
- è®¡å…¥ `pairCount`ï¼Œä½†ä¸è®¡å…¥ `playerPairCount`
- ç”¨äºé…é€å™¨ä¸ç‰©æµç«™ã€å­˜å‚¨ç®±çš„è‡ªåŠ¨é…å¯¹

---

## ğŸ” ä¸ºä»€ä¹ˆæ¸¸æˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ

æ¸¸æˆå¯èƒ½çš„è®¾è®¡æ„å›¾ï¼š
- `playerPairCount`ï¼šç©å®¶æ‰‹åŠ¨é…å¯¹ï¼ˆä½¿ç”¨ç‰¹æ®Šè´Ÿæ•°IDï¼‰
- `pairCount - playerPairCount`ï¼šè‡ªåŠ¨é…å¯¹ï¼ˆé…é€å™¨åˆ°å­˜å‚¨ç­‰ï¼‰

æˆ‘ä»¬çš„è™šæ‹Ÿé…é€å™¨ä½¿ç”¨æ­£æ•°IDï¼Œæ‰€ä»¥è¢«å½’ç±»ä¸º"è‡ªåŠ¨é…å¯¹"ã€‚

---

## âœ… æœ€ç»ˆä¿®å¤

1. **å¹‚ç­‰æ€§æ£€æŸ¥ä½¿ç”¨ `pairCount`**
2. **æ·»åŠ é…å¯¹æ—¶æ£€æŸ¥ supplyId æ˜¯å¦æ˜¯è™šæ‹Ÿé…é€å™¨**
3. **ç¡®ä¿åªæ£€æŸ¥é…é€å™¨åˆ°é…é€å™¨çš„é…å¯¹**
