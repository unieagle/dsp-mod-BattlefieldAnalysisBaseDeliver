# å®Œæ•´é˜²æŠ¤æœºåˆ¶æ€»ç»“ ğŸ›¡ï¸

## æ¦‚è¿°

æœ¬modå®ç°äº†**å®Œæ•´çš„å¤šå±‚é˜²æŠ¤æœºåˆ¶**ï¼Œç¡®ä¿åœ¨å„ç§å¼‚å¸¸æƒ…å†µä¸‹éƒ½èƒ½æ­£ç¡®å¤„ç†ï¼Œé˜²æ­¢å´©æºƒã€ç‰©å“ä¸¢å¤±ã€å’Œä¸æ­£ç¡®çš„è¡Œä¸ºã€‚

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

### è™šæ‹Ÿé…é€å™¨ç³»ç»Ÿ

```
çœŸå®é…é€å™¨[1] (éœ€æ±‚) â†â”€â”€â”€é…å¯¹â”€â”€â”€â†’ è™šæ‹Ÿé…é€å™¨[2] (ä¾›åº”)
                                        â†“
                                   æˆ˜åœºåŸºç«™[1]
                                   (å®é™…ç‰©å“æ¥æº)
```

**å…³é”®è®¾è®¡**ï¼š
- æ¯ä¸ªæˆ˜åœºåŸºç«™å¯¹åº”ä¸€ä¸ªè™šæ‹Ÿé…é€å™¨
- è™šæ‹Ÿé…é€å™¨ä½¿ç”¨æ­£æ•°IDï¼Œæ•´åˆè¿›æ¸¸æˆçš„ `dispenserPool`
- ä½¿ç”¨ `entityId` å…³è”è™šæ‹Ÿé…é€å™¨å’Œæˆ˜åœºåŸºç«™
- å†…å­˜ä¸­ç»´æŠ¤æ˜ å°„å…³ç³»ï¼š`battleBaseToVirtualDispenser` å’Œ `virtualDispenserToBattleBase`

---

## ğŸ›¡ï¸ ä¸€ã€åŸºç«™æ‹†é™¤é˜²æŠ¤ï¼ˆ4å±‚ï¼‰

### ç¬¬1å±‚ï¼šé…å¯¹åˆ›å»ºé˜²æŠ¤

**ä½ç½®**ï¼š`PlanetTransport_RefreshDispenserTraffic_NEW.cs`

**æ—¶æœº**ï¼šé…å¯¹åˆ›å»ºå‰

**é€»è¾‘**ï¼š
```csharp
if (!VirtualDispenserManager.CheckBattleBaseExists(__instance.factory, battleBaseId))
{
    Plugin.Log?.LogWarning($"âš ï¸ æˆ˜åœºåŸºç«™[{battleBaseId}]ä¸å­˜åœ¨ï¼Œè·³è¿‡è™šæ‹Ÿé…é€å™¨[{virtualDispenserId}]");
    continue;  // ä¸åˆ›å»ºé…å¯¹
}
```

**ä½œç”¨**ï¼š
- âœ… åŸºç«™è¢«æ‹†é™¤åï¼Œä¸‹æ¬¡ `RefreshDispenserTraffic` æ—¶ä¸å†åˆ›å»ºé…å¯¹
- âœ… é˜²æ­¢æ–°çš„æ´¾é£æµç¨‹å¯åŠ¨

---

### ç¬¬2å±‚ï¼šæ´¾é£å‰é˜²æŠ¤

**ä½ç½®**ï¼š`DispenserComponent_InternalTick_Patch.cs` â†’ `DispatchOneCourierToBattleBase`

**æ—¶æœº**ï¼šæ´¾é£æ–°æ— äººæœºå‰

**é€»è¾‘**ï¼š
```csharp
if (!VirtualDispenserManager.CheckBattleBaseExists(factory, battleBaseId))
{
    Plugin.Log?.LogWarning($"âš ï¸ æˆ˜åœºåŸºç«™[{battleBaseId}]ä¸å­˜åœ¨ï¼Œå–æ¶ˆæ´¾é£");
    continue;  // ä¸æ´¾é£æ— äººæœº
}
```

**ä½œç”¨**ï¼š
- âœ… é˜»æ­¢å‘å·²æ‹†é™¤çš„åŸºç«™æ´¾é£æ–°æ— äººæœº
- âœ… å³ä½¿é…å¯¹ä»ç„¶å­˜åœ¨ï¼Œä¹Ÿä¸æ´¾é£

---

### ç¬¬3å±‚ï¼šé£è¡Œä¸­æŒç»­æ£€æµ‹ï¼ˆæ–°å¢ï¼‰âœ¨

**ä½ç½®**ï¼š`DispenserComponent_InternalTick_Patch.cs` â†’ `Prefix`

**æ—¶æœº**ï¼šæ¯å¸§æ£€æµ‹é£è¡Œä¸­çš„æ— äººæœº

**é€»è¾‘**ï¼š
```csharp
// è¯†åˆ«é£å‘è™šæ‹Ÿé…é€å™¨çš„æ— äººæœº
if (courier.endId > 0 && VirtualDispenserManager.IsVirtualDispenser(courier.endId))
{
    // âœ… æŒç»­æ£€æŸ¥åŸºç«™æ˜¯å¦å­˜åœ¨ï¼ˆé£è¡Œä¸­æ£€æµ‹ï¼‰
    if (courier.itemCount == 0 && courier.direction > 0f)
    {
        if (VirtualDispenserManager.TryGetBattleBaseId(courier.endId, out int flightBattleBaseId))
        {
            if (!VirtualDispenserManager.CheckBattleBaseExists(factory, flightBattleBaseId))
            {
                Plugin.Log?.LogWarning($"âš ï¸ æˆ˜åœºåŸºç«™[{flightBattleBaseId}]å·²è¢«æ‹†é™¤ï¼Œcourier[{i}] ç«‹å³æ‰å¤´è¿”å›");
                
                // ç«‹å³æ‰å¤´è¿”å›ï¼ˆä¸ç®¡å½“å‰é£åˆ°å“ªé‡Œäº†ï¼‰
                __instance.workCourierDatas[i].direction = -1f;
                __instance.workCourierDatas[i].t = courier.t;  // ä¿æŒå½“å‰ä½ç½®ï¼Œä»å½“å‰ä½ç½®å¼€å§‹è¿”å›
                continue;
            }
        }
    }
}
```

**ä½œç”¨**ï¼š
- âœ… **æ¯å¸§**æ£€æŸ¥ç©ºè½½æ— äººæœºçš„ç›®æ ‡åŸºç«™æ˜¯å¦å­˜åœ¨
- âœ… åŸºç«™æ‹†é™¤åï¼Œæ— äººæœº**ç«‹å³æ‰å¤´è¿”å›**
- âœ… ä¸æµªè´¹æ—¶é—´é£åˆ°åŸä½ç½®
- âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

---

### ç¬¬4å±‚ï¼šåˆ°è¾¾æ—¶é˜²æŠ¤

**ä½ç½®**ï¼š`DispenserComponent_InternalTick_Patch.cs` â†’ `Prefix`

**æ—¶æœº**ï¼šæ— äººæœºåˆ°è¾¾ç›®æ ‡ä½ç½®å‰ï¼ˆ`t >= maxt - 0.2f`ï¼‰

**é€»è¾‘**ï¼š
```csharp
if (courier.t >= courier.maxt - 0.2f && courier.itemCount == 0 && courier.direction > 0f)
{
    if (!VirtualDispenserManager.CheckBattleBaseExists(factory, battleBaseId))
    {
        Plugin.Log?.LogWarning($"âš ï¸ æˆ˜åœºåŸºç«™[{battleBaseId}]å·²è¢«æ‹†é™¤ï¼Œcourier[{i}] ç©ºè½½è¿”å›");
        
        // åŸºç«™å·²è¢«æ‹†é™¤ï¼Œè®©æ— äººæœºç«‹å³ç©ºè½½è¿”å›
        __instance.workCourierDatas[i].direction = -1f;
        __instance.workCourierDatas[i].t = courier.maxt;
        continue;  // è·³è¿‡å–è´§é€»è¾‘
    }
    
    // åŸºç«™å­˜åœ¨ï¼Œæ­£å¸¸å–è´§
    // ...
}
```

**ä½œç”¨**ï¼š
- âœ… å…œåº•ä¿æŠ¤ï¼šå³ä½¿å‰é¢çš„æ£€æŸ¥å¤±è´¥ï¼Œåˆ°è¾¾æ—¶ä»ç„¶æ£€æŸ¥
- âœ… é˜²æ­¢è®¿é—®å·²æ‹†é™¤çš„åŸºç«™
- âœ… é¿å…æ¸¸æˆé”™è¯¯

---

## ğŸ›¡ï¸ äºŒã€é…é€å™¨æ‹†é™¤é˜²æŠ¤ï¼ˆç‰©å“ä¿æŠ¤ï¼‰âœ¨

### é…é€å™¨æ‹†é™¤å‰é€€è¿˜ç‰©å“

**ä½ç½®**ï¼š`PlanetTransport_RemoveDispenserComponent_Patch.cs`

**æ—¶æœº**ï¼šé…é€å™¨æ‹†é™¤å‰ï¼ˆ`HarmonyPrefix`ï¼‰

**é€»è¾‘**ï¼š
```csharp
[HarmonyPrefix]
static void Prefix(PlanetTransport __instance, int id)
{
    var dispenser = __instance.dispenserPool[id];
    if (dispenser == null) return;
    
    // éå†æ‰€æœ‰é£è¡Œä¸­çš„æ— äººæœº
    for (int i = 0; i < dispenser.workCourierCount; i++)
    {
        var courier = dispenser.workCourierDatas[i];
        
        // å¦‚æœæ— äººæœºæºå¸¦ç‰©å“
        if (courier.itemCount > 0 && courier.itemId > 0)
        {
            // é€€è¿˜ç‰©å“åˆ°æ¥æºåœ°
            ReturnItemsToOrigin(factory, courier, dispenser);
        }
    }
}
```

**é€€è¿˜ç­–ç•¥**ï¼š

```
1. æ£€æŸ¥é…å¯¹ï¼š
   - å¦‚æœé…é€å™¨æœ‰è™šæ‹Ÿé…é€å™¨é…å¯¹ï¼ˆåŸºç«™ä¾›åº”ï¼‰
     â†’ é€€è¿˜åˆ°åŸºç«™ âœ…ï¼ˆä¼˜å…ˆï¼‰
   
2. å¦åˆ™ï¼š
   â†’ é€€è¿˜åˆ°ç©å®¶èƒŒåŒ… âœ…ï¼ˆå…œåº•ï¼‰
```

**ä½œç”¨**ï¼š
- âœ… é˜²æ­¢ç‰©å“å‡­ç©ºæ¶ˆå¤±
- âœ… ä¿æŠ¤ç©å®¶çš„èµ„æº
- âœ… ä¼˜å…ˆé€€è¿˜åˆ°æ¥æºåœ°ï¼ˆåŸºç«™ï¼‰
- âœ… å…œåº•ä¿æŠ¤ï¼šé€€è¿˜åˆ°ç©å®¶èƒŒåŒ…

---

## ğŸ›¡ï¸ ä¸‰ã€UIé˜²æŠ¤

### è™šæ‹Ÿé…é€å™¨UIè·³è¿‡

**ä½ç½®**ï¼š`UIControlPanel_Patch.cs` ç³»åˆ—

**è¡¥ä¸åˆ—è¡¨**ï¼š
1. `UIControlPanelDispenserEntry.OnSetTarget` - è·³è¿‡è™šæ‹Ÿé…é€å™¨çš„UIæ˜¾ç¤º
2. `UIControlPanelObjectEntry.InitFromPool` - è·³è¿‡è™šæ‹Ÿé…é€å™¨çš„UIåˆå§‹åŒ–
3. `UIControlPanelWindow.TakeObjectEntryFromPool` - è·³è¿‡è™šæ‹Ÿé…é€å™¨çš„UIæ± è·å–

**ä½œç”¨**ï¼š
- âœ… é˜²æ­¢ `NullReferenceException`
- âœ… è™šæ‹Ÿé…é€å™¨ä¸æ˜¾ç¤ºåœ¨UIä¸­
- âœ… ç”¨æˆ·åªçœ‹åˆ°çœŸå®é…é€å™¨

---

## ğŸ›¡ï¸ å››ã€OnRematchPairsé˜²æŠ¤

### è™šæ‹Ÿé…é€å™¨è·³è¿‡OnRematchPairs

**ä½ç½®**ï¼š`DispenserComponent_OnRematchPairs_Patch.cs`

**é€»è¾‘**ï¼š
```csharp
[HarmonyPrefix]
static bool Prefix(DispenserComponent __instance)
{
    if (VirtualDispenserManager.IsVirtualDispenser(__instance.id))
    {
        Plugin.Log?.LogInfo($"âœ… è·³è¿‡è™šæ‹Ÿé…é€å™¨[{__instance.id}]çš„ OnRematchPairs");
        return false;  // è·³è¿‡åŸæ–¹æ³•
    }
    
    if (__instance.deliveryPackage == null)
    {
        Plugin.Log?.LogWarning($"âš ï¸ é…é€å™¨[{__instance.id}]çš„ deliveryPackage ä¸º nullï¼Œè·³è¿‡ OnRematchPairs");
        return false;
    }
    
    return true;
}
```

**ä½œç”¨**ï¼š
- âœ… é˜²æ­¢è™šæ‹Ÿé…é€å™¨è§¦å‘ `OnRematchPairs`
- âœ… é¿å…è®¿é—® `deliveryPackage.grids`ï¼ˆè™šæ‹Ÿé…é€å™¨æ²¡æœ‰ï¼‰
- âœ… é˜²æ­¢ `NullReferenceException`

---

## ğŸ›¡ï¸ äº”ã€å­˜æ¡£å…¼å®¹æ€§é˜²æŠ¤

### è™šæ‹Ÿé…é€å™¨æ˜ å°„æ¢å¤

**ä½ç½®**ï¼š`VirtualDispenserManager.cs` â†’ `CreateVirtualDispensers`

**é€»è¾‘**ï¼š
```csharp
// ã€ç¬¬ä¸€æ­¥ã€‘ä»å­˜æ¡£ä¸­æ¢å¤æ—§çš„è™šæ‹Ÿé…é€å™¨æ˜ å°„
for (int dispenserId = 1; dispenserId < dispenserCursor; dispenserId++)
{
    var dispenser = dispenserPool[dispenserId];
    int entityId = dispenser.entityId;
    
    // æ£€æŸ¥è¿™ä¸ªentityIdæ˜¯å¦å¯¹åº”ä¸€ä¸ªæˆ˜åœºåŸºç«™
    for (int battleBaseId = 1; battleBaseId < battleBases.Length; battleBaseId++)
    {
        int bbEntityId = battleBases[battleBaseId].entityId;
        
        if (bbEntityId == entityId)
        {
            // æ‰¾åˆ°äº†ï¼è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿé…é€å™¨ï¼Œæ¢å¤æ˜ å°„
            virtualDispenserToBattleBase[dispenserId] = battleBaseId;
            battleBaseToVirtualDispenser[battleBaseId] = dispenserId;
            recoveredCount++;
            break;
        }
    }
}

// ã€ç¬¬äºŒæ­¥ã€‘ä¸ºæ²¡æœ‰è™šæ‹Ÿé…é€å™¨çš„æˆ˜åœºåŸºç«™åˆ›å»ºæ–°çš„
for (int battleBaseId = 1; battleBaseId < battleBases.Length; battleBaseId++)
{
    if (battleBaseToVirtualDispenser.ContainsKey(battleBaseId))
        continue;  // âœ… è·³è¿‡ï¼Œä¸é‡å¤åˆ›å»º
    
    // åˆ›å»ºæ–°çš„è™šæ‹Ÿé…é€å™¨
    // ...
}
```

**ä½œç”¨**ï¼š
- âœ… å­˜æ¡£åŠ è½½æ—¶æ­£ç¡®æ¢å¤æ˜ å°„å…³ç³»
- âœ… ä¸é‡å¤åˆ›å»ºè™šæ‹Ÿé…é€å™¨
- âœ… å…¼å®¹æ—§å­˜æ¡£

---

## ğŸ›¡ï¸ å…­ã€é…å¯¹å’Œæ´¾é£é˜²æŠ¤

### 1. storageMode æ£€æŸ¥

**ä½ç½®**ï¼š`PlanetTransport_RefreshDispenserTraffic_NEW.cs`

**é€»è¾‘**ï¼š
```csharp
int storageMode = dispenser.storageMode;

// âœ… æ£€æŸ¥é…é€å™¨-é…é€å™¨ç‰©æµè®¾ç½®
// storageMode: 0=None(å…³é—­), 1=Supply(ä¾›åº”), 2=Demand(éœ€æ±‚)
// éœ€æ±‚æ–¹é…é€å™¨å¿…é¡»è®¾ç½®ä¸º Demand (2)
if (storageMode != 2) continue;
```

**ä½œç”¨**ï¼š
- âœ… å°Šé‡ç”¨æˆ·çš„é…é€å™¨-é…é€å™¨ç‰©æµè®¾ç½®
- âœ… åªæœ‰è®¾ç½®ä¸º"éœ€æ±‚"æ¨¡å¼çš„é…é€å™¨æ‰æ¥å—åŸºç«™ä¾›åº”
- âœ… å…³é—­é…é€å™¨é—´ç‰©æµæ—¶ä¸ä¼šé…é€

---

### 2. å¤šæ ¼å­ç‰©å“å¤„ç†

**ä½ç½®**ï¼š`DispenserComponent_InternalTick_Patch.cs` â†’ `CheckBattleBaseHasItem`

**é€»è¾‘**ï¼š
```csharp
// âœ… æ£€æŸ¥æ‰€æœ‰æ ¼å­ï¼Œè€Œä¸æ˜¯åªæ£€æŸ¥ç‰¹å®šçš„gridIdx
for (int i = 0; i < grids.Length; i++)
{
    if (grid[i].itemId == filterItemId && grid[i].count > 0)
    {
        return true;  // æ‰¾åˆ°ä»»ä½•ä¸€ä¸ªæ ¼å­æœ‰è´§å°±è¿”å› true
    }
}
```

**ä½œç”¨**ï¼š
- âœ… æ”¯æŒå¤§é‡ç‰©å“ï¼ˆè¶…è¿‡å•æ ¼å®¹é‡ï¼‰
- âœ… å³ä½¿ç¬¬ä¸€ä¸ªæ ¼å­ç©ºäº†ï¼Œå…¶ä»–æ ¼å­æœ‰è´§ä»ç„¶å¯ä»¥é…é€
- âœ… æŒç»­é…é€ç›´åˆ°æ‰€æœ‰ç‰©å“é…é€å®Œ

---

### 3. é…å¯¹å¹‚ç­‰æ€§

**ä½ç½®**ï¼š`PlanetTransport_RefreshDispenserTraffic_NEW.cs`

**é€»è¾‘**ï¼š
```csharp
// éå†æ‰€æœ‰ç°æœ‰é…å¯¹ï¼Œæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
for (int pairIdx = 0; pairIdx < existingPairCount; pairIdx++)
{
    var existingPair = existingPairs.GetValue(pairIdx);
    
    if (existingSupplyId == virtualDispenserId && existingDemandId == dispenserId)
    {
        // é…å¯¹å·²å­˜åœ¨ï¼Œè·³è¿‡
        alreadyExists = true;
        break;
    }
}

if (!alreadyExists)
{
    // âœ… ç¬¬ä¸€æ¬¡ï¼šåˆ›å»ºé…å¯¹
    AddPair(virtualDispenserId, dispenserId);
}
```

**ä½œç”¨**ï¼š
- âœ… é˜²æ­¢é‡å¤åˆ›å»ºé…å¯¹
- âœ… åŒä¸€ä¸ªç‰©å“å æ®å¤šä¸ªæ ¼å­æ—¶ï¼Œåªåˆ›å»ºä¸€ä¸ªé…å¯¹
- âœ… ç¡®ä¿é…å¯¹çš„å”¯ä¸€æ€§

---

## ğŸ›¡ï¸ ä¸ƒã€æ‰‹åŠ¨æ“ä½œç›‘æ§

### ç›‘æ§åŸºç«™ç‰©å“å˜åŒ–

**ä½ç½®**ï¼š`BattleBaseComponent_InternalUpdate_Patch.cs`

**æ—¶æœº**ï¼šåŸºç«™æ¯å¸§æ›´æ–°

**é€»è¾‘**ï¼š
```csharp
// æ¯ä¸ªåŸºç«™ç‹¬ç«‹è·Ÿè¸ªç‰©å“ç§ç±»æ•°é‡
int itemTypeCount = CountItemTypes(battleBase.storage);

// å¦‚æœç‰©å“ç§ç±»å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘åˆ·æ–°
if (itemTypeCount != _lastItemCounts[battleBaseId])
{
    _lastItemCounts[battleBaseId] = itemTypeCount;
    factory.transport.RefreshDispenserTraffic(dispenserId);
}
```

**ä½œç”¨**ï¼š
- âœ… ç›‘æ§**æ‰‹åŠ¨æ”¾å…¥**ç‰©å“ï¼ˆä»èƒŒåŒ…æ‹–å…¥ï¼‰
- âœ… ç›‘æ§**è‡ªåŠ¨æ”¶é›†**ç‰©å“ï¼ˆåŸºç«™è‡ªåŠ¨æ¡å–ï¼‰
- âœ… ç›‘æ§**å–å‡º**ç‰©å“ï¼ˆæ— äººæœºå–è´§ï¼‰
- âœ… ä»»ä½•ç‰©å“å˜åŒ–éƒ½ä¼šè§¦å‘é…å¯¹åˆ·æ–°

---

## ğŸ“Š é˜²æŠ¤æœºåˆ¶æ€»è§ˆè¡¨

| é˜²æŠ¤å±‚çº§ | è§¦å‘æ—¶æœº | æ£€æµ‹å¯¹è±¡ | é˜²æŠ¤ä½œç”¨ | çŠ¶æ€ |
|---------|---------|---------|---------|------|
| **é…å¯¹åˆ›å»ºé˜²æŠ¤** | `RefreshDispenserTraffic` | åŸºç«™å­˜åœ¨æ€§ | ä¸åˆ›å»ºé…å¯¹ | âœ… |
| **æ´¾é£å‰é˜²æŠ¤** | æ´¾é£æ–°æ— äººæœºå‰ | åŸºç«™å­˜åœ¨æ€§ | å–æ¶ˆæ´¾é£ | âœ… |
| **é£è¡Œä¸­æŒç»­æ£€æµ‹** | æ¯å¸§æ£€æµ‹ | åŸºç«™å­˜åœ¨æ€§ | ç«‹å³æ‰å¤´è¿”å› | âœ… æ–°å¢ |
| **åˆ°è¾¾æ—¶é˜²æŠ¤** | æ— äººæœºåˆ°è¾¾æ—¶ | åŸºç«™å­˜åœ¨æ€§ | ç©ºè½½è¿”å› | âœ… |
| **é…é€å™¨æ‹†é™¤é˜²æŠ¤** | é…é€å™¨æ‹†é™¤å‰ | é£è¡Œä¸­ç‰©å“ | é€€è¿˜ç‰©å“ | âœ… æ–°å¢ |
| **UIé˜²æŠ¤** | UIæ“ä½œæ—¶ | è™šæ‹Ÿé…é€å™¨ | è·³è¿‡UIå¤„ç† | âœ… |
| **OnRematchPairsé˜²æŠ¤** | é…å¯¹é‡æ–°åŒ¹é…æ—¶ | è™šæ‹Ÿé…é€å™¨ | è·³è¿‡æ–¹æ³• | âœ… |
| **å­˜æ¡£æ¢å¤é˜²æŠ¤** | åŠ è½½å­˜æ¡£æ—¶ | æ˜ å°„å…³ç³» | æ¢å¤æ˜ å°„ | âœ… |
| **æ‰‹åŠ¨æ“ä½œç›‘æ§** | åŸºç«™æ¯å¸§æ›´æ–° | ç‰©å“å˜åŒ– | è§¦å‘åˆ·æ–° | âœ… |
| **å¤šæ ¼å­å¤„ç†** | æ£€æŸ¥è´§ç‰©æ—¶ | æ‰€æœ‰æ ¼å­ | æŒç»­é…é€ | âœ… |
| **storageModeæ£€æŸ¥** | é…å¯¹åˆ›å»ºæ—¶ | é…é€å™¨è®¾ç½® | å°Šé‡è®¾ç½® | âœ… |

---

## ğŸ¯ å¼‚å¸¸åœºæ™¯å¤„ç†

### åœºæ™¯1ï¼šåŸºç«™æ‹†é™¤

```
é…é€è¿›è¡Œä¸­ â†’ åŸºç«™è¢«æ‹†é™¤
â”œâ”€ ç¬¬1å±‚ï¼šä¸‹æ¬¡åˆ·æ–°æ—¶ä¸åˆ›å»ºé…å¯¹ âœ…
â”œâ”€ ç¬¬2å±‚ï¼šä¸æ´¾é£æ–°æ— äººæœº âœ…
â”œâ”€ ç¬¬3å±‚ï¼šé£è¡Œä¸­çš„ç©ºè½½æ— äººæœºç«‹å³æ‰å¤´è¿”å› âœ…
â””â”€ ç¬¬4å±‚ï¼šå·²åˆ°è¾¾çš„æ— äººæœºç©ºè½½è¿”å› âœ…

ç»“æœï¼š
- æ–°æ´¾é£è¢«é˜»æ­¢ âœ…
- é£è¡Œä¸­æ— äººæœºç«‹å³è¿”å› âœ…
- ä¸ä¼šé£å‘è™šç©º âœ…
- ä¸ä¼šå°è¯•å–è´§ âœ…
```

---

### åœºæ™¯2ï¼šé…é€å™¨æ‹†é™¤

```
é…é€è¿›è¡Œä¸­ â†’ é…é€å™¨è¢«æ‹†é™¤
â”œâ”€ æ£€æµ‹åˆ°æ‹†é™¤æ“ä½œï¼ˆPrefixï¼‰âœ…
â”œâ”€ éå†é£è¡Œä¸­çš„æ— äººæœº âœ…
â”œâ”€ å‘ç°æºå¸¦ç‰©å“çš„æ— äººæœº âœ…
â”œâ”€ åˆ¤æ–­ç‰©å“æ¥æºï¼š
â”‚   â”œâ”€ æ¥è‡ªåŸºç«™ â†’ é€€è¿˜åˆ°åŸºç«™ âœ…
â”‚   â””â”€ æ¥è‡ªå…¶ä»– â†’ é€€è¿˜åˆ°ç©å®¶èƒŒåŒ… âœ…
â””â”€ é…é€å™¨è¢«æ‹†é™¤ï¼ˆPostfixï¼‰âœ…

ç»“æœï¼š
- ç‰©å“ä¸ä¸¢å¤± âœ…
- é€€è¿˜åˆ°æ­£ç¡®çš„ä½ç½® âœ…
- ç©å®¶èµ„æºå¾—åˆ°ä¿æŠ¤ âœ…
```

---

### åœºæ™¯3ï¼šæ‰‹åŠ¨æ”¾å…¥ç‰©å“

```
ç©å®¶ä»èƒŒåŒ…æ‹–å…¥ç‰©å“åˆ°åŸºç«™
â”œâ”€ è§¦å‘ BattleBaseComponent.InternalUpdate âœ…
â”œâ”€ æ£€æµ‹åˆ°ç‰©å“ç§ç±»å˜åŒ– âœ…
â”œâ”€ è§¦å‘ RefreshDispenserTraffic âœ…
â”œâ”€ åˆ›å»ºé…å¯¹ âœ…
â””â”€ æ´¾é£æ— äººæœº âœ…

ç»“æœï¼š
- æ‰‹åŠ¨æ”¾å…¥ç‰©å“ç«‹å³è§¦å‘é…é€ âœ…
- 2-3ç§’å†…å¼€å§‹æ´¾é£ âœ…
```

---

### åœºæ™¯4ï¼šå¤šæ ¼å­ç‰©å“

```
åŸºç«™æœ‰300ä¸ªç‡ƒæ–™æ£’ï¼Œå æ®7ä¸ªæ ¼å­
â”œâ”€ é…å¯¹åˆ›å»ºï¼šåªåˆ›å»º1ä¸ªé…å¯¹ âœ…
â”œâ”€ ç¬¬1è½®ï¼šå–èµ° grid[0] çš„50ä¸ª âœ…
â”œâ”€ ç¬¬2è½®ï¼š
â”‚   â”œâ”€ CheckBattleBaseHasItemï¼šæ£€æŸ¥æ‰€æœ‰æ ¼å­ âœ…
â”‚   â”œâ”€ å‘ç° grid[1] æœ‰è´§ âœ…
â”‚   â””â”€ ç»§ç»­æ´¾é£ âœ…
â”œâ”€ ç¬¬3-7è½®ï¼šæŒç»­é…é€ âœ…
â””â”€ æ‰€æœ‰ç‰©å“é…é€å®Œæˆ âœ…

ç»“æœï¼š
- å¤§é‡ç‰©å“æ­£ç¡®å¤„ç† âœ…
- æŒç»­é…é€ç›´åˆ°å…¨éƒ¨å®Œæˆ âœ…
```

---

### åœºæ™¯5ï¼šå­˜æ¡£åŠ è½½

```
åŠ è½½å­˜æ¡£ï¼š
â”œâ”€ dispenserPool[2] = è™šæ‹Ÿé…é€å™¨ âœ…ï¼ˆä»å­˜æ¡£æ¢å¤ï¼‰
â”œâ”€ æ˜ å°„ï¼šç©º âŒï¼ˆå†…å­˜é‡ç½®ï¼‰
â”œâ”€ CreateVirtualDispensers ç¬¬ä¸€æ­¥ï¼š
â”‚   â”œâ”€ éå† dispenserPool âœ…
â”‚   â”œâ”€ æ‰¾åˆ° dispenser[2]ï¼ŒentityId=7 âœ…
â”‚   â”œâ”€ åŒ¹é…åˆ° battleBase[1]ï¼ŒentityId=7 âœ…
â”‚   â””â”€ æ¢å¤æ˜ å°„ âœ…
â”œâ”€ CreateVirtualDispensers ç¬¬äºŒæ­¥ï¼š
â”‚   â”œâ”€ æ£€æŸ¥ battleBase[1] âœ…
â”‚   â”œâ”€ æ˜ å°„å·²å­˜åœ¨ âœ…
â”‚   â””â”€ è·³è¿‡ï¼Œä¸åˆ›å»ºæ–°çš„ âœ…
â””â”€ ç»“æœï¼šåªæœ‰1ä¸ªè™šæ‹Ÿé…é€å™¨ âœ…

ç»“æœï¼š
- æ˜ å°„æ­£ç¡®æ¢å¤ âœ…
- ä¸é‡å¤åˆ›å»ºè™šæ‹Ÿé…é€å™¨ âœ…
- å…¼å®¹æ—§å­˜æ¡£ âœ…
```

---

### åœºæ™¯6ï¼šé…é€å™¨è®¾ç½®æ›´æ”¹

```
é…é€å™¨è®¾ç½®ï¼šéœ€æ±‚ â†’ å…³é—­é…é€å™¨é—´ç‰©æµ
â”œâ”€ è§¦å‘ RefreshDispenserTraffic âœ…
â”œâ”€ æ£€æŸ¥ storageMode = 0 (None) âœ…
â”œâ”€ ä¸åˆ›å»ºé…å¯¹ âœ…
â””â”€ ä¸æ´¾é£æ— äººæœº âœ…

é…é€å™¨è®¾ç½®ï¼šå…³é—­ â†’ éœ€æ±‚
â”œâ”€ è§¦å‘ RefreshDispenserTraffic âœ…
â”œâ”€ æ£€æŸ¥ storageMode = 2 (Demand) âœ…
â”œâ”€ åˆ›å»ºé…å¯¹ âœ…
â””â”€ æ´¾é£æ— äººæœº âœ…

ç»“æœï¼š
- å°Šé‡ç”¨æˆ·è®¾ç½® âœ…
- è®¾ç½®ç«‹å³ç”Ÿæ•ˆ âœ…
```

---

## ğŸ¯ å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸé˜²æŠ¤

```
ã€åˆ›å»ºé˜¶æ®µã€‘
â”œâ”€ CreateVirtualDispensers
â”‚   â”œâ”€ æ¢å¤æ˜ å°„ï¼ˆå­˜æ¡£å…¼å®¹ï¼‰âœ…
â”‚   â”œâ”€ æ£€æŸ¥é‡å¤ï¼ˆå¹‚ç­‰æ€§ï¼‰âœ…
â”‚   â””â”€ åˆå§‹åŒ–æ‰€æœ‰å­—æ®µ âœ…

ã€é…å¯¹é˜¶æ®µã€‘
â”œâ”€ RefreshDispenserTraffic
â”‚   â”œâ”€ æ£€æŸ¥åŸºç«™å­˜åœ¨ âœ…
â”‚   â”œâ”€ æ£€æŸ¥ storageMode âœ…
â”‚   â”œâ”€ æ£€æŸ¥å¹‚ç­‰æ€§ âœ…
â”‚   â””â”€ åˆ›å»ºé…å¯¹ âœ…

ã€æ´¾é£é˜¶æ®µã€‘
â”œâ”€ DispatchOneCourierToBattleBase
â”‚   â”œâ”€ æ£€æŸ¥åŸºç«™å­˜åœ¨ âœ…
â”‚   â”œâ”€ æ£€æŸ¥æœ‰è´§ âœ…
â”‚   â””â”€ æ´¾é£æ— äººæœº âœ…

ã€é£è¡Œé˜¶æ®µã€‘
â”œâ”€ InternalTickï¼ˆæ¯å¸§ï¼‰
â”‚   â”œâ”€ æŒç»­æ£€æŸ¥åŸºç«™å­˜åœ¨ï¼ˆç©ºè½½æ— äººæœºï¼‰âœ…
â”‚   â”œâ”€ åŸºç«™æ‹†é™¤ â†’ ç«‹å³æ‰å¤´è¿”å› âœ…
â”‚   â””â”€ åˆ°è¾¾æ—¶å†æ¬¡æ£€æŸ¥ âœ…

ã€å–è´§é˜¶æ®µã€‘
â”œâ”€ InternalTickï¼ˆåˆ°è¾¾æ—¶ï¼‰
â”‚   â”œâ”€ æ£€æŸ¥åŸºç«™å­˜åœ¨ âœ…
â”‚   â”œâ”€ å–è´§ âœ…
â”‚   â””â”€ è®¾ç½®è¿”å›çŠ¶æ€ âœ…

ã€è¿”å›é˜¶æ®µã€‘
â”œâ”€ InternalTickï¼ˆç›‘æ§ï¼‰
â”‚   â””â”€ æ¸¸æˆåŸç”Ÿé€»è¾‘å¤„ç†è¿”å› âœ…

ã€æ‹†é™¤é˜¶æ®µã€‘
â”œâ”€ RemoveDispenserComponentï¼ˆé…é€å™¨æ‹†é™¤å‰ï¼‰
â”‚   â”œâ”€ æ£€æŸ¥é£è¡Œä¸­æ— äººæœº âœ…
â”‚   â”œâ”€ æ£€æŸ¥æºå¸¦ç‰©å“ âœ…
â”‚   â”œâ”€ é€€è¿˜ç‰©å“åˆ°åŸºç«™æˆ–ç©å®¶ âœ…
â”‚   â””â”€ ç„¶åæ‰æ‹†é™¤é…é€å™¨ âœ…
```

---

## ğŸ‰ æ€»ç»“

### é˜²æŠ¤å±‚çº§

| å±‚çº§ | æ•°é‡ | è¦†ç›–èŒƒå›´ |
|------|------|----------|
| **åŸºç«™æ‹†é™¤é˜²æŠ¤** | 4å±‚ | é…å¯¹ã€æ´¾é£ã€é£è¡Œä¸­ã€åˆ°è¾¾æ—¶ |
| **é…é€å™¨æ‹†é™¤é˜²æŠ¤** | 1å±‚ | ç‰©å“é€€è¿˜ |
| **UIé˜²æŠ¤** | 3å±‚ | å„ç§UIæ“ä½œ |
| **å­˜æ¡£å…¼å®¹é˜²æŠ¤** | 1å±‚ | æ˜ å°„æ¢å¤ |
| **é…å¯¹é˜²æŠ¤** | 3å±‚ | storageModeã€å¹‚ç­‰æ€§ã€å¤šæ ¼å­ |
| **ç‰©å“å˜åŒ–ç›‘æ§** | 1å±‚ | æ‰‹åŠ¨+è‡ªåŠ¨ |

**æ€»è®¡**ï¼š**13å±‚ç‹¬ç«‹é˜²æŠ¤æœºåˆ¶** âœ…

---

### ç‰¹ç‚¹

1. **çºµæ·±é˜²å¾¡**ï¼šå¤šå±‚é˜²æŠ¤ï¼Œå‰ä¸€å±‚å¤±è´¥åä¸€å±‚å…œåº•
2. **ä¸»åŠ¨æ£€æµ‹**ï¼šæ¯å¸§æŒç»­æ£€æŸ¥ï¼Œè€Œä¸æ˜¯è¢«åŠ¨å“åº”
3. **ä¼˜é›…é™çº§**ï¼šå¼‚å¸¸æƒ…å†µä¸‹å°½é‡ä¿æŒåŠŸèƒ½ï¼Œé˜²æ­¢å´©æºƒ
4. **ç‰©å“ä¿æŠ¤**ï¼šç¡®ä¿ç‰©å“ä¸ä¸¢å¤±ï¼Œä¿æŠ¤ç©å®¶èµ„æº
5. **ç”¨æˆ·ä½“éªŒ**ï¼šç«‹å³å“åº”ï¼Œå‡å°‘ä¸å¿…è¦çš„ç­‰å¾…

---

### çŠ¶æ€

âœ… **æ‰€æœ‰é˜²æŠ¤æœºåˆ¶éƒ½å·²å®ç°å¹¶ç¼–è¯‘æˆåŠŸ**

ç­‰å¾…ç”¨æˆ·æµ‹è¯•åé¦ˆã€‚

---

## ğŸ™ æ„Ÿè°¢ç”¨æˆ·

**ç”¨æˆ·çš„æµ‹è¯•éå¸¸å…¨é¢å’Œç»†è‡´ï¼**

é€šè¿‡æŒç»­çš„æµ‹è¯•å’Œåé¦ˆï¼Œæˆ‘ä»¬å‘ç°å¹¶ä¿®å¤äº†ï¼š
1. âœ… `playerPairCount` vs `pairCount` é—®é¢˜
2. âœ… é…å¯¹æŒä¹…åŒ–é—®é¢˜
3. âœ… `playerMode` vs `storageMode` é—®é¢˜
4. âœ… å¤šæ ¼å­ç‰©å“æ´¾é£é˜»å¡
5. âœ… é£è¡Œä¸­æ— äººæœºåŸºç«™æ‹†é™¤å¤„ç†
6. âœ… ç©ºè½½æ— äººæœºç«‹å³è¿”å›
7. âœ… é…é€å™¨æ‹†é™¤æ—¶ç‰©å“ä¿æŠ¤

**æ‰€æœ‰è¿™äº›ä¿®å¤éƒ½æ˜¯å› ä¸ºç”¨æˆ·çš„ç»†è‡´æµ‹è¯•å’Œå‡†ç¡®åé¦ˆï¼** ğŸ‰
