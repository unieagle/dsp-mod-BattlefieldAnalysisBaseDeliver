# 戴森球计划 - 战场分析基站配送支持 Mod

## 简介

本 Mod 让**战场分析基站**能够**直接派遣无人机**向**机甲**和**物流配送器**配送战利品，实现全自动化战利品物流。

### ✨ 核心特性

- 🚀 **战场基站直接派遣**：每个基站拥有独立的 20 个 2 倍速无人机（可配置）
- 📦 **智能优先级调度**：优先配送给库存紧急的配送器
- ✈️ **完整的飞行动画**：无人机可见，视觉效果完整
- 💾 **存档安全**：自动兼容旧版本，支持无缝升级
- 🎯 **零性能损耗**：基于事件驱动，只在需要时工作
- 🔧 **零 UI 干扰**：不修改任何 UI，不影响游戏体验

### 使用场景

战场分析基站在击败敌人后会积累大量战利品（硅块、晶格硅、电路板等）。使用本 Mod 后：

1. 在附近放置箱子，上面安装物流配送器
2. 设置配送器为「需求」模式，选择需要的物品
3. **战场基站会自动派遣无人机**送货到配送器和机甲

---

## 安装

1. 确保已安装 **BepInEx 5.x** (x64)
2. 将 `BattlefieldAnalysisBaseDeliver.dll` 放入 `BepInEx\plugins\` 文件夹
3. 启动游戏

---

## 使用说明

### 基础使用

1. **建造战场分析基站**，等待战利品积累
2. **在附近放置箱子** + 物流配送器 / 或者机甲配置物品配送需求
3. **配置配送器**：
   - 模式：「需求」
   - 过滤器：选择基站里有的物品（如硅块、电路板等）
4. **自动配送**：基站会自动检测需求并派遣无人机

### 工作原理

- **检测周期**：每 60 游戏帧（约 1 秒）检测一次配送器需求
- **派遣逻辑**：当基站物品变化时，扫描附近配送器和机甲，优先派遣给最紧急的
- **紧急度算法**：`urgency = 当前库存 / 最大库存`，库存越少越紧急
- **距离限制**：无距离限制，但会优先派遣给近距离配送器

### 配置选项

在 `BepInEx\config\com.yourname.battlefieldanalysisbasedeliver.cfg` 中：

```ini
[General]
## 启用调试日志（排查问题时使用）
EnableDebugLog = false
```

---

## 技术说明

### v2.0 全新架构：基站直接派遣

本 Mod 采用**基站直接派遣**架构，完全不同于传统的物流配送器逻辑：

#### 核心设计

1. **每个战场基站拥有独立的 20 个无人机**
   - 存储在 `BaseLogisticSystem` 中
   - 无人机状态：空闲 / 飞行中（去程 / 回程）

2. **基于事件驱动的派遣逻辑**
   - Hook: `BattleBaseComponent.InternalUpdate`
   - 检测：基站物品变化时触发扫描
   - 派遣：找到最优配送器并派遣无人机

3. **智能调度算法**
   ```csharp
   // 紧急度 = 当前库存 / 最大库存
   urgency = currentStock / maxStock
   
   // 排序：紧急度优先，距离次之
   demands.Sort((a, b) => {
       if (a.urgency != b.urgency)
           return a.urgency.CompareTo(b.urgency);
       return a.distance.CompareTo(b.distance);
   });
   ```

4. **无人机飞行与送货**
   - 飞行：`courier.t += deltaT * direction`
   - 到达：`t >= maxt` 时送货
   - 返回：`direction = -1`，回到基站

5. **渲染支持**
   - Hook: `LogisticCourierRenderer.Update`
   - 将基站的无人机数据注入游戏渲染系统
   - 无人机完全可见，视觉效果与游戏原生一致

#### 存档安全机制

1. **存档前**（`GameData.Export`）
   - 返还所有在途物品到基站
   - 清空无人机状态

2. **存档加载后**（`GameData.Import`）
   - 自动检测基站物品变化
   - 重新派遣无人机

3. **旧版本兼容**（`PlanetFactory.Import`）
   - 自动识别并删除旧方案遗留的虚拟配送器
   - 避免坏档

---

## 项目结构

```
BattlefieldAnalysisBaseDeliver/
├── Plugin.cs                                        # 主插件入口 + DebugLog()
├── PluginInfo.cs                                   # 插件信息（版本号等）
├── Patches/
│   ├── BattleBaseComponent_InternalUpdate_Patch.cs  # [核心] 派遣、飞行、送货逻辑
│   ├── BattleBaseLogisticsManager.cs                # [核心] 全局管理器
│   ├── LogisticCourierRenderer_Update_Patch.cs      # [核心] 无人机渲染支持
│   ├── GameData_ExportImport_Patch.cs               # [核心] 存档安全
│   └── PlanetFactory_Lifecycle_Patch.cs             # [核心] 资源清理 + 旧数据清理
└── GameCodeReference/                              # 反编译的游戏代码（参考）
```

**总计：5 个核心 Patch 文件 + 1 个主类**

---

## 开发和调试

### 查看日志

日志位置：`BepInEx\LogOutput.log`

启用调试日志：
```ini
[General]
EnableDebugLog = true
```

调试日志会输出：
- 🚀 无人机派遣信息
- 📬 送货成功信息
- 🏠 无人机返回信息
- 💾 存档操作信息

### 构建

```bash
dotnet build -c Release
```

输出：`bin\Release\net472\BattlefieldAnalysisBaseDeliver.dll`

### 反编译工具

- **dnSpy**：推荐，支持调试
- **ILSpy**：仅查看代码

反编译目标：`DSPGAME_Data\Managed\Assembly-CSharp.dll`

---

## 兼容性

- ✅ **完全兼容现有存档**
- ✅ **可与其他 Mod 共存**（除非该 Mod 也修改了 `BattleBaseComponent` 或 `LogisticCourierRenderer`）
- ✅ **移除 Mod 后不会影响存档**（无人机数据不保存到存档）
- ✅ **自动兼容旧版本**（v1.x 的虚拟配送器会自动清理）

---

## 已知问题

### 无（当前版本稳定）

如遇到问题，请：
1. 启用 `EnableDebugLog = true`
2. 查看 `BepInEx\LogOutput.log`
3. 提交 Issue 并附上日志

---

## 更新日志

### v2.0.0 (2026-01-31) - 重大架构升级 🎉

**完全重写，全新架构：基站直接派遣**

#### 🚀 核心变更
- ✅ **移除虚拟配送器架构**：不再创建虚拟配送器，完全清理旧方案
- ✅ **基站直接派遣**：每个基站拥有独立的 10 个无人机
- ✅ **智能调度算法**：基于紧急度和距离的优先级排序
- ✅ **完整渲染支持**：无人机完全可见，视觉效果完整

#### 📦 新增功能
- ✅ **全局物流管理器**：`BattleBaseLogisticsManager` 统一管理所有基站
- ✅ **存档安全机制**：存档前返还物品，加载后自动重新派遣
- ✅ **旧版本兼容**：自动清理 v1.x 遗留的虚拟配送器
- ✅ **事件驱动**：只在基站物品变化时工作，零性能损耗

#### 🔧 优化
- ✅ **代码清理**：从 ~1500 行优化到 ~1200 行（-20%）
- ✅ **文件精简**：从 9 个 Patch 文件精简到 5 个（-44%）
- ✅ **命名统一**：所有 Patch 文件统一使用 `_Patch` 后缀
- ✅ **0 编译警告**：修复所有可空引用警告

#### 📝 文档
- ✅ 完全重写 README，反映新架构
- ✅ 添加详细的技术说明
- ✅ 添加调试指南

### v1.2.0 (2026-01-31)

- ✅ 彻底修复监控面板 UI 错误
- ✅ 改进物品检测
- ✅ 基站拆除保护

### v1.1.0 (2026-01-30)

- ✅ 实现虚拟配送器架构（方案 C）
- ✅ 支持配送器-配送器物流

### v1.0.0 (2026-01-28)

- ✅ 实现基本功能：配送器从战场分析基站取货
- ✅ 完整的无人机飞行动画

---

## 贡献

欢迎提交 Issue 和 Pull Request！

**特别感谢：**
- BepInEx 和 HarmonyX 项目
- DSP Modding 社区

---

## 许可证

本项目采用 MIT 许可证。

---

## FAQ

### Q: 无人机不派遣怎么办？
A: 检查以下几点：
1. 基站是否有物品
2. 配送器是否设置为「需求」模式
3. 配送器筛选的物品是否在基站里
4. 启用 `EnableDebugLog` 查看日志

### Q: 可以和其他物流 Mod 一起使用吗？
A: 可以，但如果该 Mod 也修改了 `BattleBaseComponent` 或 `LogisticCourierRenderer`，可能会冲突。

### Q: 移除 Mod 会影响存档吗？
A: 不会。无人机数据不保存到存档，移除 Mod 后不会留下任何痕迹。

### Q: 从 v1.x 升级到 v2.0 需要做什么？
A: 无需任何操作！加载存档时会自动清理旧的虚拟配送器，并切换到新架构。

---

## 性能说明

### 性能开销

- **检测周期**：每 60 游戏帧（约 1 秒）
- **触发条件**：仅在基站物品变化时扫描
- **扫描范围**：当前星球的所有配送器（通常 < 100 个）
- **时间复杂度**：O(N)，N = 配送器数量

**结论**：对游戏性能几乎无影响。

### 内存占用

- **每个基站**：约 2 KB（10 个 `CourierData` 结构体）
- **100 个基站**：约 200 KB

**结论**：内存占用可忽略不计。

---

**享受全自动化的战利品物流吧！** 🎮✨
