# 戴森球计划/战场分析基站配送支持 Mod

## 简介

本 Mod 让**物流配送器**能够从**战场分析基站**的战利品仓库中取物，实现自动化物流。

### 核心特性

- ✅ 配送器自动派出无人机前往战场分析基站取货
- ✅ 完整的飞行动画和物流逻辑
- ✅ 支持现有存档，无需重建基站
- ✅ 支持同一物品占用多个仓库格子的情况
- ✅ 基站拆除后，飞行中的无人机立即返回
- ✅ 监控面板正常工作，无 UI 错误

### 使用场景

战场分析基站在击败敌人后会积累大量战利品（硅块、晶格硅、电路板等）。使用本 Mod 后：

1. 在附近放置箱子，上面安装物流配送器
2. 设置配送器为「需求」模式，选择需要的物品
3. 配送器会自动派出无人机前往基站取货
4. 取货后的无人机可以配送给其他建筑或机甲

---

## 安装

1. 确保已安装 **BepInEx 5.x** (x64)
2. 将 `BattlefieldAnalysisBaseDeliver.dll` 放入 `BepInEx\plugins\` 文件夹
3. 启动游戏

---

## 使用说明

### 配置配送器

1. 建造战场分析基站，等待战利品积累
2. 在附近的箱子上放置物流配送器
3. 打开配送器设置界面：
   - 配送器-机甲物流：设置为「需求」
   - 配送器-配送器物流：设置为「需求」
   - 物品过滤器：选择基站里有的物品
4. 确保配送器有足够的无人机

### 自动配送

配送器会自动：
- 每秒派出一个无人机前往基站
- 从基站取货后返回配送器
- 将物品配送给其他建筑或机甲
- 持续工作直到基站清空或无空闲无人机

---

## 技术说明

### 实现原理

本 Mod 为每个战场分析基站创建一个**虚拟配送器**，使其能够参与游戏的本地物流系统：

1. **配对阶段**：将虚拟配送器作为供货源，与需求配送器建立配对关系
2. **派出阶段**：真实配送器派出无人机飞向战场基站
3. **取货阶段**：无人机到达后从基站仓库取货
4. **返回阶段**：无人机返回配送器并自动卸货

### UI 处理

虚拟配送器在监控面板中被完全隐藏，采用双层防护机制：

- **第一层**：在面板扫描结果中过滤掉虚拟配送器
- **第二层**：即使第一层失效，UI 尝试显示时也会被安全拦截

这确保了监控面板的稳定运行，没有任何 UI 错误。

---

## 已知问题

### 1. 拆除配送器时物品丢失（游戏原版 Bug）

⚠️ **这是游戏原版的 Bug**，影响所有配送器间物流（不是本 Mod 引入）。

**现象**：拆除配送器时，飞行中无人机携带的物品会丢失。

**建议**：拆除配送器前，等待所有无人机返回（显示 10/10 空闲）。

**不修复原因**：游戏引擎限制，修复复杂且影响范围有限。

---

## 兼容性

- ✅ 完全兼容现有存档
- ✅ 可与其他 Mod 共存（除非该 Mod 也修改了物流配送系统）
- ✅ 移除 Mod 后不会影响存档（虚拟配送器会自动清理）

---

## 项目结构

```
BattlefieldAnalysisBaseDeliver/
├── Plugin.cs                                        # 主插件入口
├── PluginInfo.cs                                   # 插件信息
├── Patches/
│   ├── VirtualDispenserManager.cs                  # 虚拟配送器管理
│   ├── PlanetTransport_RefreshDispenserTraffic_NEW.cs  # 配对逻辑
│   ├── DispenserComponent_InternalTick_Patch.cs    # 派遣和取货逻辑
│   ├── UIControlPanelWindow_DetermineFilterResults_Patch.cs  # UI 过滤
│   └── UIControlPanelDispenserEntry_OnSetTarget_Safety_Patch.cs  # UI 安全检查
└── GameCodeReference/                              # 反编译的游戏代码（参考）
```

---

## 开发和调试

### 查看日志

日志位置：`BepInEx\LogOutput.log`

### 反编译工具

- **dnSpy**：推荐，支持调试
- **ILSpy**：仅查看代码

反编译文件：`DSPGAME_Data\Managed\Assembly-CSharp.dll`

---

### Build

```
dotnet build -c Release
```

## 更新日志

### v1.2.0 (2026-01-31)

- ✅ **彻底修复监控面板 UI 错误**
  - 使用双层防护：数据源过滤 + 安全检查
  - 虚拟配送器完全隐藏，不会出现在监控面板
  - 修复 `EControlPanelEntryType.Dispenser` 枚举值错误（5 不是 4）
- ✅ **改进物品检测**
  - 正确处理同一物品占用多个仓库格子的情况
  - 配送不会中途停止
- ✅ **基站拆除保护**
  - 拆除基站时，飞行中的无人机立即返回
  - 避免无人机飞向"幽灵基站"
- ✅ **代码清理**
  - 移除所有调试日志，保持静默运行
  - 精简代码结构，提高可维护性

### v1.1.0 (2026-01-30)

- ✅ 实现虚拟配送器架构（方案 C）
- ✅ 支持配送器-配送器物流
- ✅ 改进存档兼容性

### v1.0.0 (2026-01-28)

- ✅ 实现基本功能：配送器从战场分析基站取货
- ✅ 完整的无人机飞行动画
- ✅ 支持现有存档

---

## 贡献

欢迎提交 Issue 和 Pull Request！

特别感谢：
- BepInEx 和 HarmonyX 项目
- DSP Modding 社区

---

## 许可证

本项目采用 MIT 许可证。
