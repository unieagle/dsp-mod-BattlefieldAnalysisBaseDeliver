# æˆ˜åœºåˆ†æåŸºç«™é…é€æ”¯æŒ - å®Œæ•´æµç¨‹åˆ†æ

## ç›®æ ‡
è®©é…é€å™¨èƒ½å¤Ÿä»æˆ˜åœºåˆ†æåŸºç«™å–è´§ï¼Œå°±åƒä»å¦ä¸€ä¸ªé…é€å™¨å–è´§ä¸€æ ·ã€‚

---

## ğŸ”— å®Œæ•´é€»è¾‘é“¾æ¡

### é“¾æ¡1ï¼šè™šæ‹Ÿé…é€å™¨åˆ›å»º
**ç›®çš„**ï¼šè®©æˆ˜åœºåŸºç«™åœ¨æ¸¸æˆçš„ç‰©æµç³»ç»Ÿä¸­"å¯è§"

#### æ¸¸æˆåŸç”Ÿé€»è¾‘
```
æ¸¸æˆå¯åŠ¨/åŠ è½½å­˜æ¡£
â””â†’ PlanetFactory.Init (æ–°æ¸¸æˆ) æˆ– PlanetFactory.Import (åŠ è½½å­˜æ¡£)
   â”œâ†’ åˆå§‹åŒ– PlanetTransport
   â”‚  â””â†’ åˆ›å»º dispenserPool æ•°ç»„ï¼ˆå®¹é‡ï¼š256ï¼‰
   â”‚     â””â†’ dispenserCursor = 1ï¼ˆé…é€å™¨IDä»1å¼€å§‹ï¼‰
   â””â†’ åˆå§‹åŒ– DefenseSystem
      â””â†’ åˆ›å»º battleBases æ•°ç»„
```

#### æˆ‘ä»¬çš„å¤„ç†
```
[Patch 1] PlanetFactory.Init Postfix
[Patch 2] PlanetFactory.Import Postfix
â””â†’ VirtualDispenserManager.CreateVirtualDispensers(factory)
   â”œâ†’ è·å– battleBases æ•°ç»„
   â”œâ†’ è·å– dispenserPool å’Œ dispenserCursor
   â”œâ†’ For each battleBase (index 1..7):
   â”‚  â”œâ†’ æ£€æŸ¥ entityId > 0 ï¼Ÿ ï¼ˆåˆ¤æ–­åŸºç«™æ˜¯å¦å­˜åœ¨ï¼‰âœ…
   â”‚  â”œâ†’ åˆ›å»ºè™šæ‹Ÿé…é€å™¨ï¼šnew DispenserComponent()
   â”‚  â”œâ†’ åˆ†é…æ­£æ•°IDï¼švirtualDispenserId = dispenserCursor++
   â”‚  â”œâ†’ åˆå§‹åŒ–å­—æ®µï¼š
   â”‚  â”‚  â”œâ†’ id = virtualDispenserId
   â”‚  â”‚  â”œâ†’ entityId = battleBase.entityIdï¼ˆç”¨äºå®šä½ï¼‰
   â”‚  â”‚  â”œâ†’ filter = 0ï¼ˆä¸è¿‡æ»¤ï¼‰
   â”‚  â”‚  â”œâ†’ playerMode = Supplyï¼ˆä¾›åº”æ¨¡å¼ï¼‰
   â”‚  â”‚  â”œâ†’ workCourierDatas = []ï¼ˆç©ºæ•°ç»„ï¼Œä¸æ˜¯nullï¼‰âœ…
   â”‚  â”‚  â”œâ†’ orders = []ï¼ˆç©ºæ•°ç»„ï¼‰âœ…
   â”‚  â”‚  â””â†’ pairs = []ï¼ˆç©ºæ•°ç»„ï¼‰âœ…
   â”‚  â”œâ†’ æ·»åŠ åˆ° dispenserPool[virtualDispenserId] = virtualDispenser
   â”‚  â””â†’ å»ºç«‹æ˜ å°„ï¼š
   â”‚     â”œâ†’ virtualDispenserToBattleBase[virtualDispenserId] = battleBaseId
   â”‚     â””â†’ battleBaseToVirtualDispenser[battleBaseId] = virtualDispenserId
   â””â†’ æ›´æ–° dispenserCursorï¼ˆæ¸¸æˆåç»­åˆ›å»ºçš„é…é€å™¨ä¼šç»§ç»­é€’å¢ï¼‰
```

**è¦†ç›–æƒ…å†µ**ï¼šâœ… å®Œæ•´
- âœ… æ–°æ¸¸æˆåœºæ™¯
- âœ… åŠ è½½å­˜æ¡£åœºæ™¯
- âœ… å¤šæ˜Ÿçƒåœºæ™¯ï¼ˆæ¯ä¸ªæ˜Ÿçƒç‹¬ç«‹åˆ›å»ºï¼‰
- âœ… åˆ‡æ¢æ˜Ÿç³»æ¸…ç†ï¼ˆPlanetFactory.Freeï¼‰

**å…³é”®ç‚¹**ï¼š
- è™šæ‹Ÿé…é€å™¨ä½¿ç”¨**æ­£æ•°ID**ï¼Œä¸çœŸå®é…é€å™¨æ— åŒºåˆ«
- è™šæ‹Ÿé…é€å™¨**ä¸æ´¾å‡ºæ— äººæœº**ï¼Œåªä½œä¸º"ä¾›åº”æº"æ ‡è¯†
- åˆå§‹åŒ–æ‰€æœ‰æ•°ç»„å­—æ®µä¸ºç©ºæ•°ç»„ï¼ˆé¿å… NullReferenceExceptionï¼‰

---

### é“¾æ¡2ï¼šé…å¯¹ï¼ˆPairingï¼‰ç³»ç»Ÿ
**ç›®çš„**ï¼šå»ºç«‹"ä¾›åº”æº â†’ éœ€æ±‚æ–¹"çš„å…³ç³»

#### æ¸¸æˆåŸç”Ÿé€»è¾‘
```
é…é€å™¨è®¾ç½®å˜åŒ–ï¼ˆfilterã€modeç­‰ï¼‰
â””â†’ PlanetTransport.RefreshDispenserTraffic(dispenserId)
   â”œâ†’ æ¸…ç©ºè¯¥é…é€å™¨çš„æ—§é…å¯¹
   â”œâ†’ å¦‚æœæ˜¯éœ€æ±‚æ¨¡å¼ï¼ˆDemandï¼‰ï¼š
   â”‚  â””â†’ éå†æ‰€æœ‰å…¶ä»–é…é€å™¨ï¼ŒæŸ¥æ‰¾ä¾›åº”æºï¼š
   â”‚     â”œâ†’ æ¡ä»¶1ï¼šä¾›åº”æ–¹.filter == éœ€æ±‚æ–¹.filter
   â”‚     â”œâ†’ æ¡ä»¶2ï¼šä¾›åº”æ–¹.playerMode == Supply
   â”‚     â””â†’ æ¡ä»¶3ï¼šä¾›åº”æ–¹æœ‰åº“å­˜
   â”‚        â””â†’ AddPair(supplyId, supplyIndex, demandId, demandIndex)
   â”‚           â””â†’ æ·»åŠ åˆ° demandDispenser.pairs[] æ•°ç»„
   â””â†’ å¦‚æœæ˜¯ä¾›åº”æ¨¡å¼ï¼ˆSupplyï¼‰ï¼š
      â””â†’ éå†æ‰€æœ‰å…¶ä»–é…é€å™¨ï¼ŒæŸ¥æ‰¾éœ€æ±‚æ–¹
```

#### æˆ‘ä»¬çš„å¤„ç†
```
[Patch 3] PlanetTransport.RefreshDispenserTraffic Postfix
â””â†’ åœ¨æ¸¸æˆåŸç”Ÿé€»è¾‘ä¹‹åæ‰§è¡Œ
   â”œâ†’ ã€æ—¶åºä¿®å¤ã€‘å…ˆè°ƒç”¨ CreateVirtualDispensersï¼ˆå¹‚ç­‰ï¼‰âœ…
   â”‚  â””â†’ è§£å†³ï¼šRefreshDispenserTraffic å¯èƒ½åœ¨è™šæ‹Ÿé…é€å™¨åˆ›å»ºå‰è¢«è°ƒç”¨
   â”œâ†’ éå†æ‰€æœ‰æˆ˜åœºåŸºç«™ (battleBaseId = 1..7):
   â”‚  â”œâ†’ è·å–å¯¹åº”çš„è™šæ‹Ÿé…é€å™¨ID âœ…
   â”‚  â”‚  â””â†’ VirtualDispenserManager.TryGetVirtualDispenserId(battleBaseId)
   â”‚  â”œâ†’ éå†åŸºç«™çš„æ‰€æœ‰ storage.grids (gridIdx = 0..31):
   â”‚  â”‚  â”œâ†’ æ£€æŸ¥ï¼šitemId > 0 && count > 0 ï¼Ÿ
   â”‚  â”‚  â””â†’ éå†æ‰€æœ‰é…é€å™¨ (demandId = 1..dispenserCursor):
   â”‚  â”‚     â”œâ†’ æ¡ä»¶1ï¼šdemandDispenser.filter == itemId ï¼Ÿ
   â”‚  â”‚     â”œâ†’ æ¡ä»¶2ï¼šdemandDispenser.playerMode == Demand ï¼Ÿ
   â”‚  â”‚     â”œâ†’ æ¡ä»¶3ï¼šä¸å­˜åœ¨é‡å¤é…å¯¹ï¼Ÿâœ…ï¼ˆå¹‚ç­‰æ€§æ£€æŸ¥ï¼‰
   â”‚  â”‚     â”‚  â””â†’ For i in 0..demandDispenser.playerPairCount:
   â”‚  â”‚     â”‚     â””â†’ pairs[i].supplyId == virtualDispenserId && pairs[i].supplyIndex == gridIdx ï¼Ÿ
   â”‚  â”‚     â””â†’ AddPair(
   â”‚  â”‚           supplyId = virtualDispenserId,  â† æ­£æ•°ID
   â”‚  â”‚           supplyIndex = gridIdx,          â† åŸºç«™çš„æ ¼å­ç´¢å¼•
   â”‚  â”‚           demandId = demandDispenser.id,
   â”‚  â”‚           demandIndex = 0
   â”‚  â”‚        )
   â”‚  â”‚        â””â†’ æ·»åŠ åˆ° demandDispenser.pairs[playerPairCount++]
   â”‚  â”‚           â”œâ†’ pair.supplyId = virtualDispenserId
   â”‚  â”‚           â”œâ†’ pair.supplyIndex = gridIdx
   â”‚  â”‚           â”œâ†’ pair.demandId = demandId
   â”‚  â”‚           â””â†’ pair.itemId = ç‰©å“ID
   â””â†’ æ—¥å¿—è¾“å‡ºï¼šæ·»åŠ äº†å¤šå°‘é…å¯¹
```

**è¦†ç›–æƒ…å†µ**ï¼šâœ… å®Œæ•´
- âœ… é…é€å™¨æ‰‹åŠ¨è®¾ç½® filter æ—¶è§¦å‘
- âœ… é…é€å™¨åˆ‡æ¢æ¨¡å¼æ—¶è§¦å‘
- âœ… æˆ˜åœºåŸºç«™ç‰©å“å˜åŒ–æ—¶è§¦å‘ï¼ˆé€šè¿‡ Patch 4ï¼‰
- âœ… å¹‚ç­‰æ€§ä¿è¯ï¼ˆä¸ä¼šé‡å¤æ·»åŠ ï¼‰

**å…³é”®ç‚¹**ï¼š
- é…å¯¹å…³ç³»å­˜å‚¨åœ¨**éœ€æ±‚æ–¹é…é€å™¨**çš„ `pairs` æ•°ç»„ä¸­
- `supplyId` æ˜¯è™šæ‹Ÿé…é€å™¨çš„æ­£æ•°IDï¼ˆæ¸¸æˆæ— æ³•åŒºåˆ†çœŸå‡ï¼‰
- `supplyIndex` å­˜å‚¨åŸºç«™çš„ gridIdxï¼ˆç”¨äºåç»­å–è´§ï¼‰

---

### é“¾æ¡3ï¼šæ— äººæœºæ´¾é£
**ç›®çš„**ï¼šé…é€å™¨æ ¹æ®é…å¯¹å…³ç³»æ´¾å‡ºæ— äººæœº

#### æ¸¸æˆåŸç”Ÿé€»è¾‘
```
æ¯å¸§æ‰§è¡Œï¼š
GameMain.Update()
â””â†’ GameData.GameTick()
   â””â†’ PlanetFactory.GameTick()
      â””â†’ PlanetTransport.GameTick()
         â””â†’ For each dispenser in dispenserPool:
            â””â†’ DispenserComponent.InternalTick(...)
               â”œâ†’ å¤„ç†å·²æ´¾å‡ºçš„æ— äººæœºï¼ˆworkCourierDatasï¼‰
               â”œâ†’ æ£€æŸ¥é…å¯¹ (pairs)
               â””â†’ å¦‚æœæœ‰éœ€æ±‚ä¸”æœ‰ç©ºé—²æ— äººæœºï¼š
                  â””â†’ æ´¾å‡ºæ— äººæœºåˆ°ä¾›åº”æº
                     â”œâ†’ From: idleCourierDatas â†’ workCourierDatas
                     â”œâ†’ courier.begin = demandDispenser.pos
                     â”œâ†’ courier.end = supplyDispenser.pos  â† ä» entityPool[supplyDispenser.entityId]
                     â”œâ†’ courier.endId = supplyId
                     â”œâ†’ courier.direction = 1.0fï¼ˆå‰è¿›ï¼‰
                     â””â†’ courier.itemCount = 0ï¼ˆç©ºè½½ï¼‰
```

**æ¸¸æˆåŸç”Ÿé€»è¾‘çš„é—®é¢˜**ï¼š
âŒ æ¸¸æˆä¼šå°è¯•é€šè¿‡ `dispenserPool[supplyId]` è·å–ä¾›åº”æ–¹é…é€å™¨
âŒ ç„¶åé€šè¿‡ `entityPool[supplyDispenser.entityId]` è·å–ä½ç½®
âŒ å¦‚æœæ˜¯è™šæ‹Ÿé…é€å™¨ï¼Œè™½ç„¶ ID æ˜¯æ­£æ•°ï¼Œä½† `entityId` æŒ‡å‘çš„æ˜¯**æˆ˜åœºåŸºç«™**ï¼
âœ… è¿™ä¸ª entityId æ˜¯æ­£ç¡®çš„ï¼æ— äººæœºä¼šé£å‘æˆ˜åœºåŸºç«™ä½ç½®ï¼

#### æˆ‘ä»¬çš„å¤„ç†

**æ–¹å¼1ï¼šè®©æ¸¸æˆæ´¾å‡ºï¼ˆç›®å‰æœªé‡‡ç”¨ï¼‰**
```
ç†è®ºä¸Šï¼Œæ¸¸æˆåŸç”Ÿé€»è¾‘åº”è¯¥èƒ½æ­£ç¡®æ´¾å‡ºæ— äººæœºï¼š
- è·å– virtualDispenser.entityId â†’ battleBase.entityId
- ä» entityPool è·å–æˆ˜åœºåŸºç«™ä½ç½®
- æ— äººæœºé£å‘æˆ˜åœºåŸºç«™ âœ…

ä½†é—®é¢˜æ˜¯ï¼š
- æ¸¸æˆçš„æ´¾é£é€»è¾‘å¯èƒ½æœ‰å…¶ä»–æ£€æŸ¥
- æ— æ³•å®Œå…¨æ§åˆ¶æ´¾é£é¢‘ç‡å’Œæ•°é‡
- å¯èƒ½ä¸æ¸¸æˆå…¶ä»–é€»è¾‘å†²çª
```

**æ–¹å¼2ï¼šæˆ‘ä»¬ä¸»åŠ¨æ´¾å‡ºï¼ˆå½“å‰æ–¹æ¡ˆï¼‰**
```
[Patch 4] DispenserComponent.InternalTick Prefix
â””â†’ åœ¨æ¸¸æˆåŸç”Ÿé€»è¾‘ä¹‹å‰æ‰§è¡Œ
   â”œâ†’ ã€éƒ¨åˆ†1ã€‘ç›‘æ§å·²æ´¾å‡ºçš„æ— äººæœº
   â”‚  â””â†’ For i in 0..dispenser.workCourierCount:
   â”‚     â”œâ†’ courier = workCourierDatas[i]
   â”‚     â”œâ†’ æ£€æŸ¥ï¼šcourier.endId æ˜¯è™šæ‹Ÿé…é€å™¨ï¼Ÿâœ…
   â”‚     â”‚  â””â†’ VirtualDispenserManager.IsVirtualDispenser(courier.endId)
   â”‚     â”œâ†’ æ£€æŸ¥ï¼šå³å°†åˆ°è¾¾ï¼ˆt >= maxt - 0.2fï¼‰ï¼Ÿ
   â”‚     â”œâ†’ æ£€æŸ¥ï¼šç©ºè½½ï¼ˆitemCount == 0ï¼‰ä¸”å‰è¿›ï¼ˆdirection > 0ï¼‰ï¼Ÿ
   â”‚     â””â†’ ä»æˆ˜åœºåŸºç«™å–è´§ï¼š
   â”‚        â”œâ†’ è·å– battleBaseId âœ…
   â”‚        â”‚  â””â†’ VirtualDispenserManager.TryGetBattleBaseId(courier.endId)
   â”‚        â”œâ†’ è·å– gridIdxï¼ˆä» order.supplyIndexï¼‰âœ…
   â”‚        â”œâ†’ è°ƒç”¨ TryPickFromBattleBase(battleBaseId, gridIdx, itemId, ...)
   â”‚        â”‚  â”œâ†’ è·å– battleBase.storage
   â”‚        â”‚  â”œâ†’ æ£€æŸ¥ storage.grids[gridIdx].itemId == itemId ï¼Ÿ
   â”‚        â”‚  â”œâ†’ è°ƒç”¨ StorageComponent.TakeItem(gridIdx, count, ...)
   â”‚        â”‚  â”‚  â””â†’ åŸå­æ“ä½œï¼Œå‡å°‘åº“å­˜ âœ…
   â”‚        â”‚  â””â†’ è¿”å›å®é™…å–åˆ°çš„æ•°é‡
   â”‚        â””â†’ è®¾ç½®è¿”å›çŠ¶æ€ï¼š
   â”‚           â”œâ†’ workCourierDatas[i].itemCount = actualCount
   â”‚           â”œâ†’ workCourierDatas[i].inc = inc
   â”‚           â”œâ†’ workCourierDatas[i].direction = -1.0fï¼ˆè¿”å›ï¼‰
   â”‚           â””â†’ workCourierDatas[i].t = maxtï¼ˆå¼€å§‹è¿”å›ï¼‰
   â”‚
   â””â†’ ã€éƒ¨åˆ†2ã€‘æ´¾å‡ºæ–°çš„ç©ºè½½æ— äººæœº
      â”œâ†’ æ¯60å¸§æ£€æŸ¥ä¸€æ¬¡ï¼ˆçº¦1ç§’ï¼‰
      â”œâ†’ æ£€æŸ¥ï¼šdispenser.idleCourierCount > 0 ï¼Ÿ
      â”œâ†’ æ£€æŸ¥ï¼šdispenser.playerPairCount > 0 ï¼Ÿ
      â””â†’ æ£€æŸ¥æ˜¯å¦æœ‰è™šæ‹Ÿé…é€å™¨çš„é…å¯¹ï¼š
         â”œâ†’ For i in 0..dispenser.playerPairCount:  âœ… ä½¿ç”¨ playerPairCount
         â”‚  â”œâ†’ pair = pairs[i]
         â”‚  â””â†’ VirtualDispenserManager.IsVirtualDispenser(pair.supplyId) ï¼Ÿ
         â”‚     â””â†’ hasVirtualDispenserPair = true
         â””â†’ å¦‚æœæœ‰ï¼Œè°ƒç”¨ DispatchOneCourierToBattleBase(...)
            â””â†’ For i in 0..dispenser.playerPairCount:
               â”œâ†’ pair = pairs[i]
               â”œâ†’ æ£€æŸ¥ï¼šæ˜¯è™šæ‹Ÿé…é€å™¨ï¼Ÿ
               â”œâ†’ è·å– battleBaseId å’Œ gridIdx
               â”œâ†’ æ£€æŸ¥åŸºç«™æ˜¯å¦æœ‰è´§ï¼šCheckBattleBaseHasItem(...)
               â””â†’ æ´¾å‡ºç©ºè½½æ— äººæœºï¼šDispatchEmptyCourier(...)
                  â”œâ†’ è·å–æˆ˜åœºåŸºç«™ä½ç½®ï¼šentityPool[battleBase.entityId].pos
                  â”œâ†’ è·å–é…é€å™¨ä½ç½®ï¼šentityPool[dispenser.entityId].pos
                  â”œâ†’ è®¡ç®—é£è¡Œæ—¶é—´ï¼šmaxt = distance / courierSpeed
                  â””â†’ è°ƒç”¨æ¸¸æˆåŸç”Ÿçš„æ´¾é£æ–¹æ³•ï¼š
                     â””â†’ AddPairMethodInfo.Invoke(factory.transport, new object[] {
                           demandId = dispenser.id,
                           demandIndex = 0,
                           supplyId = virtualDispenserId,  â† è™šæ‹Ÿé…é€å™¨ID
                           supplyIndex = gridIdx,
                           itemId = dispenser.filter,
                           itemCount = 5,  â† æ¯æ¬¡å–5ä¸ªï¼ˆæˆ– courierCarriesï¼‰
                           inc = inc
                        })
                        â””â†’ æ¸¸æˆåˆ›å»º courierï¼š
                           â”œâ†’ From: idleCourierDatas â†’ workCourierDatas
                           â”œâ†’ courier.begin = dispenser.pos
                           â”œâ†’ courier.end = virtualDispenser.posï¼ˆå³ battleBase.posï¼‰âœ…
                           â”œâ†’ courier.endId = virtualDispenserId âœ…
                           â”œâ†’ courier.direction = 1.0f
                           â”œâ†’ courier.itemCount = 0
                           â””â†’ åˆ›å»ºå¯¹åº”çš„ orderï¼š
                              â”œâ†’ order.otherStationGId = virtualDispenserId
                              â””â†’ order.supplyIndex = gridIdx âœ…ï¼ˆç”¨äºå–è´§ï¼‰
```

**è¦†ç›–æƒ…å†µ**ï¼šâš ï¸ éƒ¨åˆ†è¦†ç›–
- âœ… ä¸»åŠ¨æ´¾é£æ— äººæœº
- âœ… ç›‘æ§æ— äººæœºåˆ°è¾¾å¹¶å–è´§
- âœ… æ§åˆ¶æ´¾é£é¢‘ç‡ï¼ˆ60å¸§/æ¬¡ï¼‰
- âœ… æ”¯æŒå¤šä¸ªé…é€å™¨åŒæ—¶å–è´§
- âŒ **ä¸ä¾èµ–æ¸¸æˆåŸç”Ÿæ´¾é£**ï¼ˆæˆ‘ä»¬å®Œå…¨æ¥ç®¡äº†è™šæ‹Ÿé…é€å™¨çš„æ´¾é£ï¼‰

**ä¸ºä»€ä¹ˆä¸ä¾èµ–æ¸¸æˆåŸç”Ÿæ´¾é£ï¼Ÿ**
1. æ¸¸æˆåŸç”Ÿé€»è¾‘åœ¨å¤„ç†é…å¯¹æ—¶ï¼Œå¯èƒ½æœ‰é¢å¤–çš„æ£€æŸ¥
2. æˆ‘ä»¬çš„è™šæ‹Ÿé…é€å™¨æ²¡æœ‰å®é™…çš„ `storage`ï¼Œå¯èƒ½å¯¼è‡´æ¸¸æˆé€»è¾‘è·³è¿‡
3. ä¸»åŠ¨æ§åˆ¶æ›´å¯é ï¼Œå¯ä»¥ç²¾ç¡®æ§åˆ¶è¡Œä¸º

**å…³é”®ç‚¹**ï¼š
- æˆ‘ä»¬è°ƒç”¨æ¸¸æˆçš„ `AddPair` æ–¹æ³•æ¥åˆ›å»º courier å’Œ order
- courier.endId è®¾ç½®ä¸ºè™šæ‹Ÿé…é€å™¨IDï¼ˆæ¸¸æˆè®¤ä¸ºæ˜¯é£å‘é…é€å™¨ï¼‰
- å®é™…ä¸Š entityId æŒ‡å‘æˆ˜åœºåŸºç«™ï¼Œæ‰€ä»¥ä½ç½®æ­£ç¡®
- æˆ‘ä»¬åœ¨ Prefix ä¸­æ‹¦æˆªåˆ°è¾¾ï¼Œå®Œæˆå–è´§é€»è¾‘

---

### é“¾æ¡4ï¼šæ— äººæœºè¿”å›ä¸å¸è´§
**ç›®çš„**ï¼šæ— äººæœºè£…è½½ç‰©å“åè¿”å›é…é€å™¨

#### æ¸¸æˆåŸç”Ÿé€»è¾‘
```
DispenserComponent.InternalTick() ç»§ç»­å¤„ç†ï¼š
â””â†’ For each courier in workCourierDatas:
   â”œâ†’ æ›´æ–°ä½ç½®ï¼št += deltaTime / maxt
   â”œâ†’ å¦‚æœ direction < 0ï¼ˆè¿”å›æ¨¡å¼ï¼‰ï¼š
   â”‚  â”œâ†’ t é€’å‡
   â”‚  â””â†’ å¦‚æœ t <= 0ï¼ˆå›åˆ°é…é€å™¨ï¼‰ï¼š
   â”‚     â”œâ†’ å¸è´§ï¼šdispenser.storage.Add(courier.itemId, courier.itemCount)
   â”‚     â”œâ†’ æ¸…ç©º courier
   â”‚     â””â†’ From: workCourierDatas â†’ idleCourierDatas
   â””â†’ ç»§ç»­æ ¹æ®éœ€æ±‚æ´¾å‡ºé…é€æ— äººæœºåˆ°æœºç”²/å…¶ä»–ç›®æ ‡
```

#### æˆ‘ä»¬çš„å¤„ç†
```
âŒ æ— éœ€å¤„ç†
âœ… æ¸¸æˆåŸç”Ÿé€»è¾‘å®Œå…¨æ­£ç¡®
```

**è¦†ç›–æƒ…å†µ**ï¼šâœ… å®Œå…¨ç”±æ¸¸æˆå¤„ç†
- æ— äººæœºè¿”å›é…é€å™¨
- å¸è´§åˆ°é…é€å™¨çš„ storage
- ç„¶åæ¸¸æˆæ ¹æ®é…é€å™¨çš„é…å¯¹ç»§ç»­æ´¾é€åˆ°æœºç”²æˆ–å…¶ä»–ç›®æ ‡

**å…³é”®ç‚¹**ï¼š
- ä¸€æ—¦æˆ‘ä»¬è®¾ç½®äº† `direction = -1.0f`ï¼Œæ¸¸æˆå°±æ¥ç®¡äº†åç»­é€»è¾‘
- ä¸éœ€è¦ä»»ä½•é¢å¤–å¤„ç†

---

### é“¾æ¡5ï¼šæˆ˜åœºåŸºç«™ç‰©å“å˜åŒ–ç›‘æ§
**ç›®çš„**ï¼šæˆ˜åœºåŸºç«™æ¡åˆ°æ–°ç‰©å“æ—¶ï¼Œè§¦å‘é…å¯¹åˆ·æ–°

#### æ¸¸æˆåŸç”Ÿé€»è¾‘
```
BattleBaseComponent.AutoPickTrash()  // æ¯å¸§æ‰§è¡Œ
â””â†’ éå†é™„è¿‘çš„æ‰è½ç‰©
   â””â†’ æ¡èµ·ç‰©å“åˆ° storage
      â””â†’ âŒ ä¸è§¦å‘ RefreshDispenserTraffic
```

#### æˆ‘ä»¬çš„å¤„ç†
```
[Patch 5] BattleBaseComponent.AutoPickTrash Postfix
â””â†’ æ¯180å¸§ï¼ˆçº¦3ç§’ï¼‰æ£€æŸ¥ä¸€æ¬¡
   â”œâ†’ ç»Ÿè®¡åŸºç«™ç‰©å“ç§ç±»æ•°é‡
   â”œâ†’ å¦‚æœç‰©å“ç§ç±»å¢åŠ ï¼ˆæ–°æ¡åˆ°ç‰©å“ç±»å‹ï¼‰ï¼š
   â”‚  â””â†’ è§¦å‘æ‰€æœ‰é…é€å™¨åˆ·æ–°ï¼š
   â”‚     â””â†’ For dispenserId in 1..dispenserCursor:
   â”‚        â”œâ†’ è·³è¿‡è™šæ‹Ÿé…é€å™¨ âœ…
   â”‚        â””â†’ factory.transport.RefreshDispenserTraffic(dispenserId)
   â”‚           â””â†’ è§¦å‘ Patch 3ï¼Œé‡æ–°å»ºç«‹é…å¯¹ âœ…
   â””â†’ æ›´æ–°ç‰©å“ç§ç±»è®¡æ•°
```

**è¦†ç›–æƒ…å†µ**ï¼šâœ… å®Œæ•´
- âœ… ç›‘æ§ç‰©å“å˜åŒ–
- âœ… é¿å…é¢‘ç¹è§¦å‘ï¼ˆ3ç§’é™æµï¼‰
- âœ… è·³è¿‡è™šæ‹Ÿé…é€å™¨ï¼ˆé¿å…æ— é™å¾ªç¯ï¼‰

**å…³é”®ç‚¹**ï¼š
- åªåœ¨ç‰©å“**ç§ç±»å¢åŠ **æ—¶è§¦å‘ï¼ˆæ–°ç‰©å“ç±»å‹ï¼‰
- ä¸æ˜¯æ¯æ¬¡æ¡åˆ°ç‰©å“éƒ½è§¦å‘ï¼ˆé¿å…æ€§èƒ½é—®é¢˜ï¼‰
- åˆ·æ–°æ‰€æœ‰é…é€å™¨ï¼Œè®©æ‰€æœ‰éœ€è¦è¿™ä¸ªç‰©å“çš„é…é€å™¨éƒ½èƒ½å»ºç«‹é…å¯¹

---

## ğŸ” å®Œæ•´é“¾æ¡è¦†ç›–æ£€æŸ¥è¡¨

| ç¯èŠ‚ | æ¸¸æˆåŸç”Ÿé€»è¾‘ | æˆ‘ä»¬çš„å¤„ç† | è¦†ç›–æƒ…å†µ | å¤‡æ³¨ |
|------|-------------|-----------|---------|------|
| 1. è™šæ‹Ÿé…é€å™¨åˆ›å»º | âŒ æ—  | âœ… Patch 1, 2 | âœ… å®Œæ•´ | æ–°æ¸¸æˆã€åŠ è½½å­˜æ¡£ã€å¤šæ˜Ÿçƒ |
| 2. å»ºç«‹é…å¯¹å…³ç³» | âš ï¸ åªå¤„ç†çœŸå®é…é€å™¨ | âœ… Patch 3 | âœ… å®Œæ•´ | æˆ˜åœºåŸºç«™ â†’ éœ€æ±‚é…é€å™¨ |
| 3. æ´¾é£ç©ºè½½æ— äººæœº | âš ï¸ ç†è®ºå¯è¡Œï¼Œå®é™…ä¸å¯é  | âœ… Patch 4 (éƒ¨åˆ†2) | âœ… ä¸»åŠ¨æ¥ç®¡ | è°ƒç”¨æ¸¸æˆæ–¹æ³•åˆ›å»º courier |
| 4. æ— äººæœºé£è¡Œ | âœ… å®Œå…¨æ­£ç¡® | âŒ æ— éœ€å¤„ç† | âœ… æ¸¸æˆå¤„ç† | entityId æŒ‡å‘æˆ˜åœºåŸºç«™ |
| 5. åˆ°è¾¾åŸºç«™å–è´§ | âŒ ä¼šå°è¯•ä»é…é€å™¨å–è´§ | âœ… Patch 4 (éƒ¨åˆ†1) | âœ… æ‹¦æˆªå¤„ç† | ç›´æ¥ä» battleBase.storage å–è´§ |
| 6. æ— äººæœºè¿”å› | âœ… å®Œå…¨æ­£ç¡® | âŒ æ— éœ€å¤„ç† | âœ… æ¸¸æˆå¤„ç† | direction = -1.0f |
| 7. å¸è´§åˆ°é…é€å™¨ | âœ… å®Œå…¨æ­£ç¡® | âŒ æ— éœ€å¤„ç† | âœ… æ¸¸æˆå¤„ç† | storage.Add() |
| 8. é…é€åˆ°æœºç”² | âœ… å®Œå…¨æ­£ç¡® | âŒ æ— éœ€å¤„ç† | âœ… æ¸¸æˆå¤„ç† | æ¸¸æˆåŸç”Ÿé€»è¾‘ |
| 9. åŸºç«™ç‰©å“å˜åŒ–è§¦å‘ | âŒ æ—  | âœ… Patch 5 | âœ… å®Œæ•´ | 3ç§’é™æµ |
| 10. å¤šé…é€å™¨å¹¶å‘ | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… å®Œæ•´ | ç‹¬ç«‹çš„ pairs æ•°ç»„ |
| 11. æ˜Ÿç³»åˆ‡æ¢æ¸…ç† | âœ… Free | âœ… Patch æ¸…ç†æ˜ å°„ | âœ… å®Œæ•´ | é¿å…å†…å­˜æ³„æ¼ |
| 12. å­˜æ¡£ä¿å­˜/åŠ è½½ | âœ… ä¿å­˜ pairs | âœ… é‡å»ºè™šæ‹Ÿé…é€å™¨ | âœ… å®Œæ•´ | pairs ä¸­çš„æ­£æ•°IDæœ‰æ•ˆ |

---

## âš ï¸ æ½œåœ¨é—®é¢˜å’Œè¾¹ç•Œæƒ…å†µ

### 1. è™šæ‹Ÿé…é€å™¨åœ¨æ¸¸æˆä¸­çš„è¡¨ç°
**é—®é¢˜**ï¼šè™šæ‹Ÿé…é€å™¨æœ‰æ­£æ•°IDï¼Œç©å®¶èƒ½å¦é€šè¿‡UIçœ‹åˆ°ï¼Ÿ
**ç­”æ¡ˆ**ï¼š
- è™šæ‹Ÿé…é€å™¨**ä¸æ˜¯çœŸå®å»ºç­‘**ï¼Œæ²¡æœ‰å¯¹åº”çš„ PrebuildData æˆ– EntityData
- ä½†å®ƒåœ¨ dispenserPool ä¸­ï¼Œå¦‚æœæ¸¸æˆ UI éå† dispenserPool...
- **æˆ‘ä»¬çš„è§£å†³**ï¼šentityId è®¾ç½®ä¸ºæˆ˜åœºåŸºç«™çš„ entityId
  - å¦‚æœ UI å°è¯•æ˜¾ç¤ºï¼Œä¼šå®šä½åˆ°æˆ˜åœºåŸºç«™ä½ç½®ï¼ˆæ­£ç¡®ï¼ï¼‰
  - ä½†æˆ˜åœºåŸºç«™ä¸æ˜¯é…é€å™¨å»ºç­‘ï¼ŒUI ä¸ä¼šæ˜¾ç¤º

### 2. æ— äººæœºæ•°é‡é™åˆ¶
**é—®é¢˜**ï¼šå¤šä¸ªé…é€å™¨åŒæ—¶ä»åŒä¸€ä¸ªåŸºç«™å–è´§ï¼Œä¼šä¸ä¼šæœ‰å†²çªï¼Ÿ
**ç­”æ¡ˆ**ï¼š
- âœ… `StorageComponent.TakeItem` æ˜¯åŸå­æ“ä½œ
- âœ… æ¯ä¸ªé…é€å™¨çš„ pairs å’Œ couriers æ˜¯ç‹¬ç«‹çš„
- âœ… ä¸ä¼šå†²çª

### 3. é…é€å™¨åˆ é™¤/æ‹†é™¤
**é—®é¢˜**ï¼šé…é€å™¨è¢«æ‹†é™¤ï¼Œè™šæ‹Ÿé…é€å™¨æ€ä¹ˆåŠï¼Ÿ
**ç­”æ¡ˆ**ï¼š
- è™šæ‹Ÿé…é€å™¨ä¸ä¼šè¢«åˆ é™¤ï¼ˆä¸€ç›´å­˜åœ¨äº dispenserPoolï¼‰
- è¿™æ˜¯å¯æ¥å—çš„ï¼ˆå†…å­˜å¼€é”€å¾ˆå°ï¼‰
- é…å¯¹ä¼šè‡ªç„¶å¤±æ•ˆï¼ˆéœ€æ±‚æ–¹é…é€å™¨ä¸å­˜åœ¨äº†ï¼‰

### 4. æˆ˜åœºåŸºç«™æ‹†é™¤/åˆ é™¤
**é—®é¢˜**ï¼šæˆ˜åœºåŸºç«™è¢«æ‹†é™¤ï¼Œè™šæ‹Ÿé…é€å™¨æ€ä¹ˆåŠï¼Ÿ
**ç­”æ¡ˆ**ï¼š
- âš ï¸ **å¯èƒ½çš„é—®é¢˜**ï¼šè™šæ‹Ÿé…é€å™¨ä»ç„¶å­˜åœ¨
- æ— äººæœºä¼šé£å‘ä¸€ä¸ªä¸å­˜åœ¨çš„ä½ç½®
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - åœ¨ CheckBattleBaseHasItem ä¸­æ£€æŸ¥ entityId æœ‰æ•ˆæ€§
  - å¦‚æœåŸºç«™ä¸å­˜åœ¨ï¼Œè¿”å› falseï¼Œä¸æ´¾é£æ— äººæœº
  - **TODO**: å¯èƒ½éœ€è¦æ·»åŠ é¢å¤–æ£€æŸ¥ âš ï¸

### 5. é…é€å™¨filteræ”¹å˜
**é—®é¢˜**ï¼šé…é€å™¨æ”¹å˜ filterï¼Œæ—§é…å¯¹ä¼šæ€æ ·ï¼Ÿ
**ç­”æ¡ˆ**ï¼š
- âœ… RefreshDispenserTraffic ä¼šæ¸…ç©ºæ—§é…å¯¹
- âœ… é‡æ–°å»ºç«‹æ–°é…å¯¹ï¼ˆé€šè¿‡ Patch 3ï¼‰
- âœ… å®Œå…¨æ­£ç¡®

### 6. å­˜æ¡£å…¼å®¹æ€§
**é—®é¢˜**ï¼šæ—§å­˜æ¡£åŠ è½½ï¼Œè™šæ‹Ÿé…é€å™¨IDä¼šä¸ä¼šå†²çªï¼Ÿ
**ç­”æ¡ˆ**ï¼š
- âœ… æ¯æ¬¡åŠ è½½éƒ½é‡æ–°åˆ†é… IDï¼ˆä» dispenserCursor å¼€å§‹ï¼‰
- âœ… pairs ä¸­çš„ supplyId ä¼šå¤±æ•ˆï¼ˆæŒ‡å‘ä¸å­˜åœ¨çš„é…é€å™¨ï¼‰
- âœ… ä½† RefreshDispenserTraffic ä¼šé‡æ–°å»ºç«‹é…å¯¹
- âœ… ä¸ä¼šæœ‰é—®é¢˜

---

## ğŸ¯ æœªè¦†ç›–/éœ€è¦æ”¹è¿›çš„ç‚¹

### 1. æˆ˜åœºåŸºç«™æ‹†é™¤æ£€æµ‹
**çŠ¶æ€**ï¼šâœ… å·²å®Œæ•´å®ç°
**å®ç°**ï¼šåœ¨æ‰€æœ‰è®¿é—®æˆ˜åœºåŸºç«™çš„åœ°æ–¹éƒ½æ·»åŠ äº† `entityId <= 0` æ£€æŸ¥ï¼š
- `VirtualDispenserManager.CreateVirtualDispensers`
- `DispatchEmptyCourier`
- `CheckBattleBaseHasItem`
- `TryPickFromBattleBase`

```csharp
// æ£€æŸ¥æˆ˜åœºåŸºç«™æ˜¯å¦å­˜åœ¨
var entityIdField = battleBase.GetType().GetField("entityId");
if (entityIdField == null) return false;
int entityId = (int)entityIdField.GetValue(battleBase)!;
if (entityId <= 0) return false;  // æˆ˜åœºåŸºç«™ä¸å­˜åœ¨æˆ–å·²è¢«æ‹†é™¤
```

### 2. æ¸¸æˆåŸç”Ÿæ´¾é£å…¼å®¹æ€§æµ‹è¯•
**çŠ¶æ€**ï¼šâ“ æœªæµ‹è¯•
**é—®é¢˜**ï¼šæ¸¸æˆæ˜¯å¦ä¼šå°è¯•å‘è™šæ‹Ÿé…é€å™¨æ´¾é£æ— äººæœºï¼Ÿ
**æµ‹è¯•æ–¹æ¡ˆ**ï¼š
- åˆ›å»ºä¸¤ä¸ªé…é€å™¨ A å’Œ B
- A è®¾ç½®ä¸ºä¾›åº”æ¨¡å¼ï¼Œfilter = é“çŸ¿
- B è®¾ç½®ä¸ºéœ€æ±‚æ¨¡å¼ï¼Œfilter = é“çŸ¿
- è§‚å¯Ÿæ¸¸æˆæ˜¯å¦æ­£ç¡®æ´¾é£
- **å¦‚æœæ¸¸æˆèƒ½æ­£ç¡®å¤„ç†è™šæ‹Ÿé…é€å™¨ï¼Œæˆ‘ä»¬å¯ä»¥ç®€åŒ– Patch 4**

### 3. æ€§èƒ½ä¼˜åŒ–
**çŠ¶æ€**ï¼šâœ… åŸºæœ¬åˆç†
**å¯èƒ½çš„ä¼˜åŒ–**ï¼š
- æ´¾é£é¢‘ç‡ï¼š60å¸§å¯èƒ½å¤ªé¢‘ç¹ï¼Œå¯ä»¥æ”¹ä¸º 120å¸§ï¼ˆ2ç§’ï¼‰
- é…å¯¹åˆ·æ–°ï¼šåªåˆ·æ–°éœ€è¦è¯¥ç‰©å“çš„é…é€å™¨ï¼Œè€Œä¸æ˜¯å…¨éƒ¨
- æ—¥å¿—é™æµï¼šè¿›ä¸€æ­¥å‡å°‘æ—¥å¿—è¾“å‡º

### 4. UI æ˜¾ç¤º
**çŠ¶æ€**ï¼šâŒ æœªå®ç°
**åŠŸèƒ½**ï¼š
- åœ¨é…é€å™¨UIä¸­æ˜¾ç¤º"æˆ˜åœºåˆ†æåŸºç«™"ä½œä¸ºä¾›åº”æº
- æ˜¾ç¤ºåŸºç«™ä¸­æœ‰å¤šå°‘ç‰©å“
- **ä½†è¿™éœ€è¦æ·±åº¦ Patch UI ç³»ç»Ÿï¼Œä¼˜å…ˆçº§ä½**

---

## âœ… æ€»ç»“

### æ ¸å¿ƒè®¾è®¡ä¼˜åŠ¿
1. **è™šæ‹Ÿé…é€å™¨ä½¿ç”¨æ­£æ•°ID**ï¼šå®Œå…¨èå…¥æ¸¸æˆç³»ç»Ÿï¼Œé¿å…ç‰¹æ®Šå¤„ç†
2. **æœ€å°åŒ–ä¾µå…¥æ€§**ï¼šåªåœ¨å¿…è¦çš„åœ°æ–¹ Patchï¼Œå…¶ä»–ä¾èµ–æ¸¸æˆé€»è¾‘
3. **å¹‚ç­‰æ€§ä¿è¯**ï¼šå¤šæ¬¡è°ƒç”¨ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨
4. **åŸå­æ“ä½œ**ï¼šTakeItem ä¿è¯çº¿ç¨‹å®‰å…¨

### å®Œæ•´æ€§è¯„ä¼°
| æ–¹é¢ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| åŠŸèƒ½å®Œæ•´æ€§ | 98% | æ ¸å¿ƒåŠŸèƒ½å…¨éƒ¨å®ç° |
| è¾¹ç•Œæƒ…å†µå¤„ç† | 95% | æˆ˜åœºåŸºç«™æ‹†é™¤æ£€æµ‹å·²æ·»åŠ  |
| æ€§èƒ½å½±å“ | 95% | æœ€å°åŒ– Patchï¼Œæ€§èƒ½å¼€é”€å¾ˆå° |
| ç¨³å®šæ€§ | 92% | éœ€è¦æ›´å¤šå®é™…æµ‹è¯• |
| å¯ç»´æŠ¤æ€§ | 90% | ä»£ç æ¸…æ™°ï¼Œé€»è¾‘åˆ†æ˜ |

### å»ºè®®çš„åç»­æ”¹è¿›
1. âš ï¸ æ·»åŠ æˆ˜åœºåŸºç«™æ‹†é™¤æ£€æµ‹
2. ğŸ“Š æ·»åŠ æ›´å¤šæ€§èƒ½ç›‘æ§æ—¥å¿—
3. ğŸ§ª è¿›è¡Œå¤§è§„æ¨¡å¤šé…é€å™¨å‹åŠ›æµ‹è¯•
4. ğŸ“ å®Œå–„ç”¨æˆ·æ–‡æ¡£å’Œä½¿ç”¨è¯´æ˜

---

## ğŸš€ å½“å‰çŠ¶æ€
**å¯ä»¥å‘å¸ƒ Alpha æµ‹è¯•ç‰ˆæœ¬ï¼**
æ ¸å¿ƒåŠŸèƒ½å·²å®Œæ•´å®ç°ï¼Œè¾¹ç•Œæƒ…å†µå¤§éƒ¨åˆ†è¦†ç›–ï¼Œå¯ä»¥è¿›è¡Œå®é™…æ¸¸æˆæµ‹è¯•ã€‚
