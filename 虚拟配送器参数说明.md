# 虚拟配送器参数详解

## 📊 当前配置

从日志可以看到：
```
dispenser[1]: filter=1804 (氢燃料棒), playerMode=2 (需求)  ← 真实配送器
dispenser[2]: filter=0 (无), playerMode=1 (供应)           ← 虚拟配送器

配对成功：虚拟配送器[2] (战场基站1) → 配送器[1]
战场基站有：itemId=1804 (氢燃料棒), count=50
```

---

## 🔧 DispenserComponent 所有参数详解

### 1. 基础标识

| 参数 | 虚拟配送器配置 | 说明 | 游戏使用 | 需要 Patch |
|------|---------------|------|---------|-----------|
| `id` | **virtualDispenserId** (正数) | 配送器ID，全局唯一 | ✅ 频繁使用 | ❌ 不需要 |
| `entityId` | **battleBase.entityId** | 实体ID，指向战场基站 | ✅ 用于定位 | ❌ 不需要 |
| `pcId` | **0** | 产线连接ID | ⚠️ 不常用 | ❌ 不需要 |
| `storageId` | **0** | 关联的存储ID | ⚠️ 不常用 | ❌ 不需要 |
| `gene` | **id % 3** | 基因（动画偏移） | ✅ 渲染用 | ❌ 不需要 |

---

### 2. 能量系统

| 参数 | 虚拟配送器配置 | 说明 | 游戏使用 | 需要 Patch |
|------|---------------|------|---------|-----------|
| `energy` | **0L** | 当前能量 | ⚠️ 不常用 | ❌ 不需要 |
| `energyPerTick` | **0L** | 每帧消耗能量 | ⚠️ 不常用 | ❌ 不需要 |
| `energyMax` | **0L** | 最大能量容量 | ⚠️ 不常用 | ❌ 不需要 |

**说明**：虚拟配送器不需要能量，设置为0即可。

---

### 3. 配送模式和过滤器（核心参数）

| 参数 | 虚拟配送器配置 | 说明 | 游戏使用 | 需要 Patch |
|------|---------------|------|---------|-----------|
| `filter` | **0** | 过滤器物品ID | ✅✅✅ **核心** | ❌ 不需要 |
| `playerMode` | **Supply (1)** | 玩家配送模式 | ✅✅✅ **核心** | ❌ 不需要 |
| `storageMode` | **None (0)** | 存储配送模式 | ⚠️ 中等使用 | ❌ 不需要 |

#### playerMode 详解
```csharp
enum EPlayerDeliveryMode 
{
    None = 0,      // 无
    Supply = 1,    // 供应 ✅ 虚拟配送器使用这个
    Demand = 2,    // 需求
    Both = 3       // 双向
}
```

**关键**：
- `filter = 0` 表示**不过滤**，所有物品都可供应
- `playerMode = Supply` 表示这是一个**供应源**
- 游戏在 `RefreshDispenserTraffic` 中会检查这两个字段来建立配对

---

### 4. 无人机系统（重要！）

| 参数 | 虚拟配送器配置 | 说明 | 游戏使用 | 需要 Patch |
|------|---------------|------|---------|-----------|
| `idleCourierCount` | **0** | 空闲无人机数量 | ✅ 派遣检查 | ❌ 不需要 |
| `workCourierCount` | **0** | 工作中无人机数量 | ✅ 循环遍历 | ❌ 不需要 |
| `courierAutoReplenish` | **false** | 自动补充无人机 | ⚠️ 不常用 | ❌ 不需要 |
| `workCourierDatas` | **[]** (空数组) | 工作中的无人机数据 | ✅✅ **重要** | ❌ 不需要 |
| `orders` | **[]** (空数组) | 订单数据 | ✅✅ **重要** | ❌ 不需要 |

**关键问题**：
```
虚拟配送器没有无人机！
- idleCourierCount = 0
- workCourierCount = 0
- workCourierDatas = [] (空数组)

这意味着：
❌ 虚拟配送器不会主动派出无人机
✅ 需求方配送器必须主动来取货
```

---

### 5. 暂存包裹系统（导致 OnRematchPairs 崩溃）

| 参数 | 虚拟配送器配置 | 说明 | 游戏使用 | 需要 Patch |
|------|---------------|------|---------|-----------|
| `holdupItemCount` | **0** | 暂存包裹数量 | ✅ OnRematchPairs | ❌ 已 Patch |
| `holdupPackage` | **[]** (空数组) | 暂存包裹数据 | ✅ OnRematchPairs | ❌ 已 Patch |

**说明**：`OnRematchPairs` 会访问这个数组，我们已经通过 Patch 跳过。

---

### 6. 订单和配对系统

| 参数 | 虚拟配送器配置 | 说明 | 游戏使用 | 需要 Patch |
|------|---------------|------|---------|-----------|
| `playerOrdered` | **0** | 玩家订单数量 | ✅ 配对计算 | ❌ 不需要 |
| `storageOrdered` | **0** | 存储订单数量 | ⚠️ 不常用 | ❌ 不需要 |
| `pairProcess` | **0** | 配对处理进度 | ⚠️ OnRematchPairs | ❌ 已 Patch |
| `pulseSignal` | **-1** | 脉冲信号 | ⚠️ 不常用 | ❌ 不需要 |
| `pairs` | **[]** (空数组) | 配对数组 | ✅✅ **核心** | ❌ 不需要 |
| `playerPairCount` | **0** | 玩家配对数量 | ✅✅ **核心** | ❌ 不需要 |
| `pairCount` | **0** | 总配对数量 | ✅ 配对管理 | ❌ 不需要 |

**说明**：
- `pairs` 数组由游戏的 `AddPair` 方法动态填充
- 虚拟配送器的 `pairs` 为空，因为它只作为"供应源"，不主动建立配对

---

### 7. 存储和搜索

| 参数 | 虚拟配送器配置 | 说明 | 游戏使用 | 需要 Patch |
|------|---------------|------|---------|-----------|
| `storage` | **null** | 关联的存储 | ⚠️ 存储模式 | ❌ 不需要 |
| `insertStorageSearchStart` | **null** | 插入搜索起点 | ⚠️ 存储模式 | ❌ 不需要 |
| `insertGridSearchStart` | **0** | 插入格子搜索起点 | ⚠️ 存储模式 | ❌ 不需要 |
| `pickStorageSearchStart` | **null** | 拾取搜索起点 | ⚠️ 存储模式 | ❌ 不需要 |
| `pickGridSearchStart` | **0** | 拾取格子搜索起点 | ⚠️ 存储模式 | ❌ 不需要 |

**说明**：虚拟配送器不使用存储系统（storageMode = None）。

---

### 8. 配送条件

| 参数 | 虚拟配送器配置 | 说明 | 游戏使用 | 需要 Patch |
|------|---------------|------|---------|-----------|
| `playerDeliveryCondition` | **None (0)** | 配送到玩家的条件 | ⚠️ 不常用 | ❌ 不需要 |

---

### 9. 玩家背包（导致 OnRematchPairs 崩溃）

| 参数 | 虚拟配送器配置 | 说明 | 游戏使用 | 需要 Patch |
|------|---------------|------|---------|-----------|
| `deliveryPackage` | **未初始化** | 玩家背包引用 | ✅✅ OnRematchPairs | ✅ **已 Patch** |

**关键问题**：
```
deliveryPackage 是 DeliveryPackage 类型，不是简单的数组
无法在虚拟配送器中初始化（需要玩家对象）

解决方案：
✅ 已通过 Patch DispenserComponent.OnRematchPairs 跳过虚拟配送器
```

---

## 🚨 核心问题：无人机数量

### 问题分析

```
虚拟配送器配置：
- idleCourierCount = 0     ← 没有空闲无人机
- workCourierCount = 0     ← 没有工作中的无人机
- workCourierDatas = []    ← 空数组

我们的派遣逻辑：
if (dispenser.idleCourierCount > 0 && dispenser.playerPairCount > 0)
{
    // 检查是否有虚拟配送器的配对
    // ...
}

问题：
❌ 我们检查的是需求方配送器（dispenser[1]）的 idleCourierCount
❌ 但我们没有确认配送器[1]是否真的有空闲无人机！
```

### 从日志看

```
dispenser[1]: filter=1804, playerMode=2 (需求)
配对：虚拟配送器[2] → 配送器[1]

但是：
❌ 没有看到"检查无人机派遣"的日志
❌ 没有看到"准备派出无人机"的日志
❌ 没有看到"开始派遣"的日志
```

---

## 🔍 需要检查的内容

### 1. 配送器[1]的无人机数量

需要在日志中添加：
```csharp
Plugin.Log?.LogInfo($"配送器[{dispenser.id}] idleCourierCount={dispenser.idleCourierCount}, workCourierCount={dispenser.workCourierCount}");
```

### 2. InternalTick 是否被调用

需要确认：
- InternalTick Patch 是否正确应用？
- 派遣逻辑是否被执行到？
- 频率控制是否太严格？

### 3. 配对数据是否正确

需要检查：
- `dispenser[1].playerPairCount` 是多少？
- `dispenser[1].pairs[0].supplyId` 是否等于虚拟配送器ID？

---

## 📝 需要 Patch 的游戏方法

| 游戏方法 | 访问的虚拟配送器字段 | Patch 状态 | 说明 |
|---------|-------------------|-----------|------|
| `OnRematchPairs` | `deliveryPackage`, `holdupPackage` | ✅ 已 Patch | 跳过虚拟配送器 |
| `InternalTick` | 所有字段 | ✅ Prefix 拦截 | 我们控制派遣逻辑 |
| `UIControlPanel` 相关 | 未知 | ❌ **需要 Patch** | UI 错误 |

---

## 🎯 下一步诊断

### 1. 添加更详细的日志

在 `InternalTick` Patch 中添加：

```csharp
// 每次进入时记录
if (_logThrottle % 60 == 0)  // 每60帧（1秒）
{
    Plugin.Log?.LogInfo($"InternalTick: dispenser[{__instance.id}] idle={__instance.idleCourierCount}, work={__instance.workCourierCount}, pairCount={__instance.playerPairCount}");
}
```

### 2. 检查配对状态

```csharp
if (__instance.playerPairCount > 0 && _logThrottle % 300 == 0)
{
    for (int i = 0; i < __instance.playerPairCount; i++)
    {
        var pair = __instance.pairs[i];
        Plugin.Log?.LogInfo($"  pair[{i}]: supplyId={pair.supplyId}, isVirtual={VirtualDispenserManager.IsVirtualDispenser(pair.supplyId)}");
    }
}
```

### 3. 修复 UI 错误

需要 Patch `UIControlPanelDispenserEntry.OnSetTarget` 等方法，跳过虚拟配送器。

---

## 💡 总结

### 虚拟配送器的"完美配置"

```csharp
虚拟配送器的角色：纯供应源
- 不派出无人机（idleCourierCount = 0）
- 不处理订单（orders = []）
- 不显示在UI（需要额外 Patch）
- 只提供位置信息（entityId 指向战场基站）

需求方配送器必须：
- 有空闲无人机（idleCourierCount > 0）
- 设置为需求模式（playerMode = Demand）
- 设置过滤器（filter = 物品ID）
```

### 当前问题的可能原因

1. ⚠️ 配送器[1]没有空闲无人机
2. ⚠️ InternalTick 的派遣逻辑没有被执行
3. ⚠️ 频率控制导致派遣延迟
4. ⚠️ 配对数据不正确

---

## 🔧 建议的修复

1. **添加诊断日志**：确认 InternalTick 执行情况和配送器状态
2. **修复 UI Patch**：处理 UIControlPanel 错误
3. **检查配送器**：确认游戏中配送器是否真的有无人机
